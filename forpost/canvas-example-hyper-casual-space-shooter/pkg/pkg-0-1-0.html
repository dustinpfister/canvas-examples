<html>
<head>
<title>Canvas Example Mr Sun</title>
</head>
<body>
<div id="canvas-app" style="width:320px;height:240px;margin-left:auto;margin-right:auto;"></div>
<script>var utils={};utils.mod=function(x,m){return(x%m+m)%m};utils.getCanvasRelative=function(e){var canvas=e.target,bx=canvas.getBoundingClientRect();return{x:(e.changedTouches?e.changedTouches[0].clientX:e.clientX)-bx.left,y:(e.changedTouches?e.changedTouches[0].clientY:e.clientY)-bx.top,bx:bx}};utils.distance=function(x1,y1,x2,y2){return Math.sqrt(Math.pow(x1-x2,2)+Math.pow(y1-y2,2))};var gameMod=function(){var api={};api.create=function(plugObj){return{ship:{x:0,y:0,r:8},map:{x:0,y:0,radian:Math.PI/180*45,pps:0,maxPPS:256}}};api.setMapMovement=function(game,degree,pps){game.map.radian=Math.PI/180*degree;if(game.map.radian>=Math.PI*2||game.map.radian<0){game.map.radian=utils.mod(game.map.radian,Math.PI*2)}game.map.pps=pps;game.map.pps=game.map.pps<0?0:game.map.pps;game.map.pps=game.map.pps>game.map.maxPPS?game.map.maxPPS:game.map.pps};api.updateMap=function(game,secs){game.map.x+=Math.cos(game.map.radian)*game.map.pps*secs;game.map.y+=Math.sin(game.map.radian)*game.map.pps*secs};return api}();var draw={background:function(ctx,canvas){ctx.fillStyle="black";ctx.fillRect(0,0,canvas.width,canvas.height)},ship:function(ctx,state){var game=state.game;ctx.fillStyle="rgba(0,0,255,0.2)";ctx.save();ctx.translate(160,120);ctx.beginPath();ctx.lineWidth=3;ctx.arc(game.ship.x,game.ship.y,game.ship.r,0,Math.PI*2);ctx.fill();ctx.strokeStyle="white";var radian=game.map.radian*-1;ctx.beginPath();ctx.moveTo(game.ship.x+Math.cos(radian)*game.ship.r,game.ship.y+Math.sin(radian)*game.ship.r);ctx.lineTo(game.ship.x,game.ship.y);ctx.stroke();ctx.restore()},gridLines:function(ctx,state,style){var grid={cellSize:64,cellWidth:7,cellHeight:7,xOffset:state.game.map.x,yOffset:state.game.map.y},sx=grid.cellWidth*grid.cellSize/2*-1-grid.xOffset%grid.cellSize,sy=grid.cellHeight*grid.cellSize/2*-1+grid.yOffset%grid.cellSize,x,y,len=grid.cellWidth*grid.cellHeight,i=0;ctx.strokeStyle=style||"red";ctx.lineWidth=1;ctx.save();ctx.translate(160,120);while(i<len){x=sx+i%grid.cellWidth*grid.cellSize;y=sy+Math.floor(i/grid.cellWidth)*grid.cellSize;ctx.beginPath();ctx.rect(x,y,grid.cellSize,grid.cellSize);ctx.stroke();i+=1}ctx.restore()},info:function(ctx,state){var game=state.game;ctx.fillStyle="yellow";ctx.font="10px arial";ctx.fillText("map pos: "+Math.floor(game.map.x)+" , "+Math.floor(game.map.y),10,10);ctx.fillText("heading: "+Math.floor(state.input.degree)+"; pps: "+state.input.pps.toFixed(2),10,20)},ver:function(ctx,state){ctx.fillStyle="yellow";ctx.font="10px arial";ctx.textBaseline="top";ctx.fillText("v"+state.ver,5,state.canvas.height-15)}};var createCanvas=function(opt){opt=opt||{};opt.container=opt.container||document.getElementById("canvas-app")||document.body;opt.canvas=document.createElement("canvas");opt.ctx=opt.canvas.getContext("2d");opt.container.appendChild(opt.canvas);opt.canvas.width=opt.width===undefined?320:opt.width;opt.canvas.height=opt.height===undefined?240:opt.height;opt.ctx.translate(.5,.5);return opt};var canvasObj=createCanvas();var state={ver:"0.1.0",canvas:canvasObj.canvas,ctx:canvasObj.ctx,game:gameMod.create(),input:{degree:0,degreesPerSecond:90,pps:0,ppsDelta:64,keys:{}}};var lt=new Date,FPS_target=1e3/30;var loop=function(){var now=new Date,t=now-lt,game=state.game,secs=t/1e3;requestAnimationFrame(loop);if(t>=FPS_target){gameMod.updateMap(game,secs);var input=state.input;if(input.keys.a){input.degree+=input.degreesPerSecond*secs}if(input.keys.d){input.degree-=input.degreesPerSecond*secs}if(input.keys.w){input.pps+=input.ppsDelta*secs;input.pps=input.pps>game.map.maxPPS?game.map.maxPPS:input.pps}if(input.keys.s){input.pps-=input.ppsDelta*secs;input.pps=input.pps<0?0:input.pps}input.degree=utils.mod(input.degree,360);gameMod.setMapMovement(game,input.degree,input.pps);draw.background(state.ctx,state.canvas);draw.gridLines(state.ctx,state,"rgba(255,255,255,0.1)");draw.ship(state.ctx,state);draw.info(state.ctx,state);draw.ver(state.ctx,state);lt=now}};loop();window.addEventListener("keydown",function(e){var key=e.key.toLowerCase();state.input.keys[key]=true});window.addEventListener("keyup",function(e){var key=e.key.toLowerCase();state.input.keys[key]=false});</script>
</body>
</html>
