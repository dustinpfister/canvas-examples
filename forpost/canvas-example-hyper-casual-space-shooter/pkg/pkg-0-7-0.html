<html>
<head>
<title>Canvas Example Mr Sun</title>
</head>
<body>
<div id="canvas-app" style="width:320px;height:240px;margin-left:auto;margin-right:auto;"></div>
<script>var utils={};utils.mod=function(x,m){return(x%m+m)%m};utils.getCanvasRelative=function(e){var canvas=e.target,bx=canvas.getBoundingClientRect();return{x:(e.changedTouches?e.changedTouches[0].clientX:e.clientX)-bx.left,y:(e.changedTouches?e.changedTouches[0].clientY:e.clientY)-bx.top,bx:bx}};utils.distance=function(x1,y1,x2,y2){return Math.sqrt(Math.pow(x1-x2,2)+Math.pow(y1-y2,2))};utils.wrapRadian=function(radian){return utils.mod(radian,Math.PI*2)};utils.angleTo=function(fromX,fromY,toX,toY){return utils.wrapRadian(Math.atan2(toY-fromY,toX-fromX)+Math.PI)};utils.deepClone=function(obj){return JSON.parse(JSON.stringify(obj))};var poolMod=function(){var api={};var getInactive=function(pool){var i=pool.objects.length,obj;while(i--){obj=pool.objects[i];if(!obj.active){return obj}}return false};api.create=function(opt){opt=opt||{};opt.count=opt.count||10;var i=0,pool={objects:[],data:opt.data||{},spawn:opt.spawn||function(obj,pool,state,opt){},purge:opt.purge||function(obj,pool,state){},update:opt.update||function(obj,pool,state,secs){}};while(i<opt.count){pool.objects.push({active:false,i:i,x:opt.x===undefined?0:opt.x,y:opt.y===undefined?0:opt.y,r:opt.r===undefined?16:opt.r,radian:opt.radian===undefined?0:opt.radian,pps:opt.pps===undefined?32:opt.pps,lifespan:opt.lifespan||3,fillStyle:opt.fillStyle||"red",data:{}});i+=1}return pool};api.spawn=function(pool,state,opt){var obj=getInactive(pool);state=state||{};opt=opt||{};if(obj){if(!obj.active){obj.active=true;pool.spawn.call(pool,obj,pool,state,opt);return obj}}return false};api.update=function(pool,secs,state){var i=pool.objects.length,obj;state=state||{};while(i--){obj=pool.objects[i];if(obj.active){pool.update.call(pool,obj,pool,state,secs);obj.lifespan-=secs;obj.lifespan=obj.lifespan<0?0:obj.lifespan;if(obj.lifespan===0){obj.active=false;pool.purge.call(pool,obj,pool,state)}}}};api.getAllActive=function(pool,activeState){activeState=activeState===undefined?true:activeState;return pool.objects.filter(function(object){return object.active===activeState})};return api}();var gameMod=function(){var BLOCK_COUNT=20,BLOCK_POS_MIN_DIST=220,BLOCK_POS_MAX_DIST=360,BLOCK_POS_ADELTA=45,BLOCK_HP_MIN=5,BLOCK_HP_MAX=1e3,MAP_MAX_DIST=Math.pow(10,5);var DEFAULT_WEAPONS={0:{name:"Pulse gun",firesPerSecond:2,shotDamage:1,shotsPerFire:1},1:{name:"Cannon",firesPerSecond:5,shotDamage:3,shotsPerFire:1},2:{name:"Atom",firesPerSecond:1,shotDamage:100,shotsPerFire:1}};var api={};var CreateHPObject=function(maxHP){return{current:maxHP||100,max:maxHP||100,per:1}};var attackObject=function(obj,damage){if(obj.hp){obj.hp.current-=damage;obj.hp.current=obj.hp.current<0?0:obj.hp.current;obj.hp.per=obj.hp.current/obj.hp.max}};var positionBlock=function(state,obj){var game=state.game,map=game.map,rDelta=Math.PI/180*BLOCK_POS_ADELTA,dist=BLOCK_POS_MIN_DIST+(BLOCK_POS_MAX_DIST-BLOCK_POS_MIN_DIST)*Math.random();var a=utils.wrapRadian(map.radian-rDelta+rDelta*2*Math.random());obj.x=game.ship.x+Math.cos(a)*dist;obj.y=game.ship.y+Math.sin(a)*dist};var createShotsPool=function(){return poolMod.create({count:60,fillStyle:"red",r:2,spawn:function(obj,pool,state,opt){obj.x=0;obj.y=0;obj.radian=state.game.map.radian;obj.pps=128;obj.lifespan=3;var weapon=state.game.ship.weapon;obj.damage=weapon.shotDamage},update:function(shot,pool,state,secs){var objDeltaX=Math.cos(shot.radian)*shot.pps*secs;var objDeltaY=Math.sin(shot.radian)*shot.pps*secs;shot.x+=objDeltaX;shot.y+=objDeltaY;var blocks=poolMod.getAllActive(state.game.blocks,true);blocks.forEach(function(block){var dist=utils.distance(shot.x,shot.y,block.x,block.y);if(dist<=block.r+shot.r){shot.lifespan=0;attackObject(block,shot.damage);if(block.hp.current<=0){block.lifespan=0;block.active=false}}})}})};var createBlocksPool=function(){return poolMod.create({data:{},fillStyle:"#1a1a1a",count:BLOCK_COUNT,spawn:function(obj,pool,state,opt){var game=state.game;positionBlock(state,obj);obj.radian=utils.wrapRadian(game.map.radian+Math.PI);obj.pps=game.map.pps;obj.lifespan=1;obj.hp=CreateHPObject(BLOCK_HP_MIN+Math.round(BLOCK_HP_MAX-BLOCK_HP_MIN)*game.map.per);obj.damage=1},update:function(obj,pool,state,secs){obj.lifespan=1;var game=state.game;var map=state.game.map;obj.radian=utils.wrapRadian(state.game.map.radian+Math.PI);obj.pps=state.game.map.pps;var objDeltaX=Math.cos(obj.radian)*obj.pps*secs;var objDeltaY=Math.sin(obj.radian)*obj.pps*secs;obj.x+=objDeltaX;obj.y+=objDeltaY;obj.data.dist=utils.distance(obj.x,obj.y,state.game.ship.x,state.game.ship.y);if(obj.data.dist<=game.ship.r+obj.r){attackObject(game.ship,obj.damage);obj.lifespan=0}if(obj.data.dist>=BLOCK_POS_MAX_DIST){obj.lifespan=0}}})};api.create=function(){var game={weapons:utils.deepClone(DEFAULT_WEAPONS),ship:{x:0,y:0,r:8,hp:CreateHPObject(100),fillStyle:"blue",weaponSecs:0,weapons:{}},shots:createShotsPool(),blocks:createBlocksPool(),map:{x:0,y:0,radian:Math.PI/180*45,pps:0,maxPPS:256,dist:0,per:0}};game.ship.weapon=game.weapons[0];return game};api.setMapMovement=function(game,degree,pps){game.map.radian=utils.wrapRadian(Math.PI/180*degree);game.map.pps=pps;game.map.pps=game.map.pps<0?0:game.map.pps;game.map.pps=game.map.pps>game.map.maxPPS?game.map.maxPPS:game.map.pps};var clampMapPos=function(map){if(map.dist>=MAP_MAX_DIST){var radian=utils.wrapRadian(map.radian+Math.PI);map.x=Math.cos(radian)*MAP_MAX_DIST;map.y=Math.sin(radian)*MAP_MAX_DIST}};api.updateMap=function(game,secs){var map=game.map;map.x+=Math.cos(map.radian)*map.pps*secs;map.y+=Math.sin(map.radian)*map.pps*secs;map.dist=utils.distance(0,0,map.x,map.y);clampMapPos(map);map.per=game.map.dist/MAP_MAX_DIST;map.aToOrigin=utils.angleTo(map.x,map.y,0,0)};api.updateBlocks=function(game,secs,state){poolMod.update(game.blocks,secs,state);poolMod.spawn(game.blocks,state,{})};api.updateShots=function(game,secs,state){var ship=game.ship,weapon=ship.weapon;ship.weaponSecs+=secs;if(ship.weaponSecs>=1/weapon.firesPerSecond){poolMod.spawn(game.shots,state,{});ship.weaponSecs=0}poolMod.update(game.shots,secs,state)};return api}();var draw=function(){var drawHealthBar=function(ctx,obj){if(obj.hp){if(obj.hp.per<1){ctx.beginPath();ctx.rect(obj.x-obj.r,obj.y+obj.r-5,obj.r*2,5);ctx.fillStyle="rgba(120,120,120,0.4)";ctx.fill();ctx.beginPath();ctx.rect(obj.x-obj.r,obj.y+obj.r-5,obj.r*2*obj.hp.per,5);ctx.fillStyle="rgba(0,255,0,0.4)";ctx.fill()}}};var baseObjectDraw=function(ctx,obj,render){ctx.save();ctx.translate(160,120);ctx.fillStyle=obj.fillStyle||"gray";ctx.strokeStyle=obj.strokeStyle||"white";ctx.beginPath();ctx.lineWidth=1;ctx.arc(obj.x,obj.y,obj.r,0,Math.PI*2);ctx.fill();ctx.stroke();if(render){render(ctx,obj)}if(obj.hp){drawHealthBar(ctx,obj)}ctx.restore()};var api={};api.background=function(ctx,state){var canvas=state.canvas,map=state.game.map,r=Math.floor(map.per*255);ctx.fillStyle="rgba("+r+",0,0,1)";ctx.fillRect(0,0,canvas.width,canvas.height)};api.shots=function(ctx,state){var game=state.game;state.game.shots.objects.forEach(function(shot){if(shot.active){baseObjectDraw(ctx,shot,function(ctx,shot){ctx.fillStyle="yellow";ctx.textBaseline="middle";ctx.textAlign="center"})}})};api.blocks=function(ctx,state){var game=state.game;state.game.blocks.objects.forEach(function(block){if(block.active){baseObjectDraw(ctx,block,function(ctx,block){ctx.fillStyle="yellow";ctx.textBaseline="middle";ctx.textAlign="center";ctx.font="8px arial";ctx.fillText(Math.floor(block.hp.current)+"/"+Math.floor(block.hp.max),block.x,block.y)})}})};api.ship=function(ctx,state){var game=state.game;ctx.fillStyle="rgba(0,0,255,0.2)";baseObjectDraw(ctx,game.ship,function(){var radian=game.map.radian;ctx.strokeStyle="white";ctx.beginPath();ctx.moveTo(game.ship.x+Math.cos(radian)*game.ship.r,game.ship.y+Math.sin(radian)*game.ship.r);ctx.lineTo(game.ship.x,game.ship.y);ctx.lineWidth=3;ctx.stroke()})};api.gridLines=function(ctx,state,style){var grid={cellSize:64,cellWidth:7,cellHeight:7,xOffset:state.game.map.x,yOffset:state.game.map.y},sx=grid.cellWidth*grid.cellSize/2*-1-grid.xOffset%grid.cellSize,sy=grid.cellHeight*grid.cellSize/2*-1+grid.yOffset%grid.cellSize*-1,x,y,len=grid.cellWidth*grid.cellHeight,i=0;ctx.strokeStyle=style||"red";ctx.lineWidth=1;ctx.save();ctx.translate(160,120);while(i<len){x=sx+i%grid.cellWidth*grid.cellSize;y=sy+Math.floor(i/grid.cellWidth)*grid.cellSize;ctx.beginPath();ctx.rect(x,y,grid.cellSize,grid.cellSize);ctx.stroke();i+=1}ctx.restore()};api.info=function(ctx,state){var game=state.game,ship=game.ship,w=ship.weapon,map=game.map;ctx.fillStyle="yellow";ctx.font="10px arial";ctx.textBaseline="top";ctx.textAlign="left";ctx.fillText("map pos: "+Math.floor(map.x)+" , "+Math.floor(map.y),10,10);ctx.fillText("map radian: "+map.radian.toFixed(2)+"; map pps: "+map.pps.toFixed(2),10,20);ctx.fillText("map dist: "+map.dist.toFixed(2)+" ("+Math.floor(map.per*100)+"%)",10,30);ctx.fillText("a to origin: "+map.aToOrigin.toFixed(2),10,40);ctx.fillText("weapon : "+w.name+", damage: "+w.shotDamage+", fps: "+w.firesPerSecond,10,50)};api.ver=function(ctx,state){ctx.fillStyle="yellow";ctx.font="10px arial";ctx.textBaseline="top";ctx.textAlign="left";ctx.fillText("v"+state.ver,5,state.canvas.height-15)};return api}();var createCanvas=function(opt){opt=opt||{};opt.container=opt.container||document.getElementById("canvas-app")||document.body;opt.canvas=document.createElement("canvas");opt.ctx=opt.canvas.getContext("2d");opt.container.appendChild(opt.canvas);opt.canvas.width=opt.width===undefined?320:opt.width;opt.canvas.height=opt.height===undefined?240:opt.height;opt.ctx.translate(.5,.5);return opt};var canvasObj=createCanvas();var state={ver:"0.7.0",canvas:canvasObj.canvas,ctx:canvasObj.ctx,game:gameMod.create(),input:{degree:0,degreesPerSecond:90,pps:0,ppsDelta:64,keys:{}}};var lt=new Date,FPS_target=1e3/30;var loop=function(){var now=new Date,t=now-lt,game=state.game,secs=t/1e3;requestAnimationFrame(loop);if(t>=FPS_target){var input=state.input;if(input.keys.a){input.degree+=input.degreesPerSecond*secs}if(input.keys.d){input.degree-=input.degreesPerSecond*secs}if(input.keys.w){input.pps+=input.ppsDelta*secs;input.pps=input.pps>game.map.maxPPS?game.map.maxPPS:input.pps}if(input.keys.s){input.pps-=input.ppsDelta*secs;input.pps=input.pps<0?0:input.pps}if(input.keys[1]){game.ship.weapon=game.weapons[0]}if(input.keys[2]){game.ship.weapon=game.weapons[1]}if(input.keys[3]){game.ship.weapon=game.weapons[2]}input.degree=utils.mod(input.degree,360);gameMod.setMapMovement(game,input.degree,input.pps);gameMod.updateMap(game,secs);gameMod.updateBlocks(game,secs,state);gameMod.updateShots(game,secs,state);draw.background(state.ctx,state);draw.gridLines(state.ctx,state,"rgba(255,255,255,0.1)");draw.blocks(state.ctx,state);draw.ship(state.ctx,state);draw.shots(state.ctx,state);draw.info(state.ctx,state);draw.ver(state.ctx,state);lt=now}};loop();window.addEventListener("keydown",function(e){var key=e.key.toLowerCase();state.input.keys[key]=true});window.addEventListener("keyup",function(e){var key=e.key.toLowerCase();state.input.keys[key]=false});</script>
</body>
</html>
