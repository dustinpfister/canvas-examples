<html><head><title>canvas example object pool</title></head><body>
<div id="canvas-app"style="width:320px;height:240px;margin-left:auto;margin-right:auto;"></div>
<script>var poolMod=(function(){var api={};var getInactive=function(pool){var i=pool.objects.length,obj;while(i--){obj=pool.objects[i];if(!obj.active){return obj;}} return false;};api.create=function(opt){opt=opt||{};opt.count=opt.count||10;var i=0,pool={objects:[],data:opt.data||{},spawn:opt.spawn||function(obj,pool,state,opt){},purge:opt.purge||function(obj,pool,state){},update:opt.update||function(obj,pool,state,secs){}};while(i<opt.count){pool.objects.push({active:false,i:i,x:opt.x===undefined?0:opt.x,y:opt.y===undefined?0:opt.y,w:opt.w===undefined?32:opt.w,h:opt.h===undefined?32:opt.h,heading:opt.heading===undefined?0:opt.heading,pps:opt.pps===undefined?32:opt.pps,lifespan:opt.lifespan||3,data:{}});i+=1;} return pool;};api.spawn=function(pool,state,opt){var obj=getInactive(pool);state=state||{};opt=opt||{};if(obj){if(!obj.active){obj.active=true;pool.spawn.call(pool,obj,pool,state,opt);return obj;}} return false;};api.update=function(pool,secs,state){var i=pool.objects.length,obj;state=state||{};while(i--){obj=pool.objects[i];if(obj.active){pool.update.call(pool,obj,pool,state,secs);obj.lifespan-=secs;obj.lifespan=obj.lifespan<0?0:obj.lifespan;if(obj.lifespan===0){obj.active=false;pool.purge.call(pool,obj,pool,state);}}}};api.setActiveStateForAll=function(pool,bool){bool=bool===undefined?false:bool;var i=pool.objects.length,obj;while(i--){obj=pool.objects[i];obj.active=bool;}};api.moveByPPS=function(obj,secs){obj.x+=Math.cos(obj.heading)*obj.pps*secs;obj.y+=Math.sin(obj.heading)*obj.pps*secs;};return api;} ());var draw={};draw.back=function(ctx,canvas){ctx.fillStyle='black';ctx.fillRect(0,0,canvas.width,canvas.height);};draw.pool=function(ctx,pool){var i=pool.objects.length,obj;ctx.fillStyle='white';ctx.strokeStyle='black';ctx.lineWidth=3;while(i--){obj=pool.objects[i];if(obj.active){ctx.save();ctx.fillStyle=obj.data.fill||'white';ctx.globalAlpha=obj.data.alpha||1;ctx.translate(obj.x,obj.y);ctx.beginPath();ctx.rect(obj.w/2* -1,obj.h/2* -1,obj.w,obj.h);ctx.fill();ctx.stroke();ctx.restore();if(obj.data.hp){var per=obj.data.hp.current/obj.data.hp.max;ctx.fillStyle='lime';ctx.fillRect(obj.x-16,obj.y,32*per,4);}}}};draw.ver=function(ctx,state){ctx.font='10px couriter';ctx.fillStyle='white';ctx.fillText('v'+state.ver,5,15);};var container=document.getElementById('canvas-app'),canvas=document.createElement('canvas'),ctx=canvas.getContext('2d');canvas.width=320;canvas.height=240;container.appendChild(canvas);var boundingBox=function(x1,y1,w1,h1,x2,y2,w2,h2){return!((y1+h1)<y2||y1>(y2+h2)||(x1+w1)<x2||x1>(x2+w2));};var state={ver:'0.3.0',canvas:canvas,secs:0,spawnRate:0.1,shots:poolMod.create({count:100,pps:32,w:8,h:8,spawn:function(obj,pool,state,opt){obj.x=opt.x;obj.y=opt.y;obj.heading=opt.heading;obj.lifespan=3;obj.data.shooter=opt.shooter;obj.data.damage=opt.damage;},update:function(obj,pool,state,secs){poolMod.moveByPPS(obj,secs);state.boxes.objects.forEach(function(bx){if(bx!=obj.data.shooter&&bx.active){if(boundingBox(bx.x,bx.y,bx.w,bx.h,obj.x,obj.y,obj.w,obj.h)){bx.data.hp.current-=obj.data.damage;bx.data.hp.current=bx.data.hp.current<0?0:bx.data.hp.current;if(bx.data.hp.current===0){bx.lifespan=0;} obj.lifespan=0;}}})}}),boxes:poolMod.create({count:10,data:{colors:['red','green','blue']},spawn:function(obj,pool,state,opt){obj.x=state.canvas.width*Math.random();obj.y=state.canvas.height*Math.random();obj.heading=Math.PI*2*Math.random();obj.pps=32+128*Math.random();var dir=Math.random()<0.5?-1:1;obj.hcps=(90+90*Math.random())*dir;obj.lifespan=300;obj.data.fill=pool.data.colors[obj.i%pool.data.colors.length];obj.data.weapon={secs:0,shotRate:1,damage:1};obj.data.hp={current:10,max:10};},update:function(obj,pool,state,secs){if(obj.active){poolMod.moveByPPS(obj,secs);obj.heading+=Math.PI/180*obj.hcps*secs;var w=obj.data.weapon;w.secs+=secs;if(w.secs>=w.shotRate){poolMod.spawn(state.shots,state,{x:obj.x,y:obj.y,heading:obj.heading,shooter:obj,damage:w.damage});w.secs%=w.shotRate;}}}})};var lt=new Date(),maxSecs=0.1;var loop=function(){var now=new Date(),t=now-lt,secs=t/1000;secs=secs>maxSecs?maxSecs:secs;requestAnimationFrame(loop);draw.back(ctx,canvas);draw.pool(ctx,state.boxes);draw.pool(ctx,state.shots);draw.ver(ctx,state);poolMod.update(state.boxes,secs,state);poolMod.update(state.shots,secs,state);state.secs+=secs;if(state.secs>=state.spawnRate){poolMod.spawn(state.boxes,state);state.secs%=state.spawnRate;} lt=now;};loop();</script>
</body></html>