<html>
    <head>
        <title>canvas grid gradient</title>
    </head>
    <body>
<div id="canvas-app" style="width:320px;height:240px;margin-left:auto;margin-right:auto;"></div>
<script>var u={};u.distance=function(x1,y1,x2,y2){return Math.sqrt(Math.pow(x1-x2,2)+Math.pow(y1-y2,2));};u.mod=function mod(x,m){return(x%m+m)%m;};var gradient=(function(){var objUpdaters={objDefaults:function(grid,obj,secs){obj.cps=1;obj.heading+=Math.PI/180*5*secs;obj.heading%=Math.PI*2;}};var initMethods={objDefaults:function(obj,grad,i){obj.x=0;obj.y=0;obj.i=i;obj.radius=5;obj.power=[1,1,1,1];obj.cps=0;obj.heading=1;obj.radiusDir=1;obj.updaterList=grad.updaters;}};var Grid=function(opt){opt=opt||{};var grad=this;grad.ver='0.0.0';grad.gridWidth=opt.gridWidth||7;grad.gridHeight=opt.gridHeight||6;grad.cellWidth=opt.cellWidth||7;grad.cellHeight=opt.cellHeight||6;grad.MIN_CPS=opt.MIN_CPS||0.25;grad.MAX_CPS=opt.MAX_CPS||1.5;grad.MIN_RADIUS=opt.MIN_RADIUS||3;grad.MAX_RADIUS=opt.MAX_RADIUS||5;grad.cells=[];grad.resetCells();grad.lt=new Date();grad.init=opt.init||['objDefaults'];grad.initMethods=initMethods;grad.updaters=opt.updaters===undefined?['objDefaults']:opt.updaters;grad.objUpdaters=objUpdaters;grad.objs=[];var i=opt.objCount||5,rand,r,g,b;while(i--){var obj={};initMethods.objDefaults(obj,grad,i);if(opt.init){if(typeof opt.init==='string'){initMethods[opt.init](obj,grad,i);}if(typeof opt.init==='object'){opt.init.forEach(function(initMethodKey){initMethods[initMethodKey](obj,grad,i);});}}grad.objs.push(obj);}grad.update();};Grid.prototype.resetCells=function(){this.cells=[];var ci=0,cellObj,cLen=this.gridWidth*this.gridHeight;while(ci<cLen){cellObj={i:ci,y:Math.floor(ci/this.gridWidth),x:ci%this.gridWidth,color:[0,0,0,0]};this.cells.push(cellObj);ci+=1;}};Grid.prototype.capCellColors=function(){this.cells.forEach(function(cell){var c=cell.color;c[0]=Math.floor(c[0]>255?255:c[0]);c[1]=Math.floor(c[1]>255?255:c[1]);c[2]=Math.floor(c[2]>255?255:c[2]);c[3]=c[3]>1?1:c[3];});};var upCellColor=function(grid,cell,obj,x,y){d=u.distance(cell.x,cell.y,x,y);if(d<=obj.radius){var per=1-d/obj.radius;var c=cell.color;c[0]+=Math.floor(255*per*obj.power[0]);c[1]+=Math.floor(255*per*obj.power[1]);c[2]+=Math.floor(255*per*obj.power[2]);c[3]+=per*obj.power[3];}};var applyUpdaterList=function(grid,obj,secs){obj.updaterList.forEach(function(updaterKey){objUpdaters[updaterKey](grid,obj,secs);});};Grid.prototype.update=function(){var grid=this,now=new Date(),t=now-grid.lt,secs=t/1000;grid.resetCells();grid.objs.forEach(function(obj){applyUpdaterList(grid,obj,secs);obj.x+=Math.cos(obj.heading)*obj.cps*secs;obj.y+=Math.sin(obj.heading)*obj.cps*secs;obj.x=u.mod(obj.x,grid.gridWidth);obj.y=u.mod(obj.y,grid.gridHeight);grid.cells.forEach(function(cell){upCellColor(grid,cell,obj,obj.x-grid.gridWidth,obj.y);upCellColor(grid,cell,obj,obj.x+grid.gridWidth,obj.y);upCellColor(grid,cell,obj,obj.x,obj.y-grid.gridHeight);upCellColor(grid,cell,obj,obj.x,obj.y+grid.gridHeight);upCellColor(grid,cell,obj,obj.x-grid.gridWidth,obj.y-grid.gridHeight);upCellColor(grid,cell,obj,obj.x+grid.gridWidth,obj.y+grid.gridHeight);upCellColor(grid,cell,obj,obj.x-grid.gridWidth,obj.y+grid.gridHeight);upCellColor(grid,cell,obj,obj.x+grid.gridWidth,obj.y-grid.gridHeight);upCellColor(grid,cell,obj,obj.x,obj.y);});});grid.capCellColors();grid.lt=now;};return{Grid:Grid,load:function(plug){for(var key in plug.initMethods){initMethods[key]=plug.initMethods[key];}for(var key in plug.objUpdaters){objUpdaters[key]=plug.objUpdaters[key];}}};}());gradient.load({initMethods:{randomPos:function(obj,grad){obj.x=grad.gridWidth*Math.random();obj.y=grad.gridHeight*Math.random();},randomColor:function(obj,grad,i){var r=Math.random(),g=Math.random(),b=Math.random(),a=Math.random();obj.power=[r,g,b,a];},randomHeading:function(obj,grad,i){var r=Math.PI*2*Math.random();obj.heading=r;},randomSpeed:function(obj,grad,i){obj.cps=grad.MIN_CPS+(Math.random()*(grad.MAX_CPS-grad.MIN_CPS));},randomRadius:function(obj,grad,i){obj.radius=grad.MIN_RADIUS+(Math.random()*(grad.MAX_RADIUS-grad.MIN_RADIUS));},random:function(obj,grad,i){grad.initMethods.randomPos(obj,grad,i);grad.initMethods.randomColor(obj,grad,i);grad.initMethods.randomHeading(obj,grad,i);grad.initMethods.randomSpeed(obj,grad,i);grad.initMethods.randomRadius(obj,grad,i);}}});gradient.load({initMethods:{rgb:function(obj,grad,i){var rand=Math.random()*0.75+0.25,r=rand,g=0,b=0;if(u.mod(i,2)===0){r=0;g=0;b=rand;}if(u.mod(i,3)===0){r=0;g=rand;b=0;}obj.power=[r,g,b,1];}}});gradient.load({objUpdaters:{radiusGrow:function(grid,obj,secs){if(obj.radius===3||obj.radius===10){var roll=Math.floor(Math.random()*50)+1;if(roll===1){obj.radiusDir=obj.radiusDir===1?-1:1;}}obj.radius+=1*secs*obj.radiusDir;obj.radius=obj.radius<3?3:obj.radius;obj.radius=obj.radius>10?10:obj.radius;obj.cps=3;}}});var draw={};draw.back=function(ctx,canvas){ctx.fillStyle='black';ctx.fillRect(0,0,canvas.width,canvas.height);};draw.cells=function(ctx,grid,xOffset,yOffset){xOffset=xOffset===undefined?0:xOffset;yOffset=yOffset===undefined?0:yOffset;var ci=0,cell,c,cLen=grid.cells.length;ctx.lineWidth=3;ctx.strokeStyle='black';while(ci<cLen){cell=grid.cells[ci];c=cell.color;ctx.fillStyle='rgba('+c[0]+','+c[1]+','+c[2]+','+c[3]+')';ctx.beginPath();ctx.rect(cell.x*grid.cellWidth+xOffset,cell.y*grid.cellHeight+yOffset,grid.cellWidth,grid.cellHeight);ctx.stroke();ctx.fill();ci+=1;}};draw.info=function(ctx,canvas,grid){ctx.fillStyle='grey';ctx.textBaseline='top';ctx.textAlign='left';ctx.font='15px courier';ctx.fillText('v'+grid.ver,10,canvas.height-20);};(function(){var container=document.getElementById('canvas-app'),canvas=document.createElement('canvas'),ctx=canvas.getContext('2d');canvas.width=320;canvas.height=240;ctx.translate(0.5,0.5);container.appendChild(canvas);var w=24,h=24;var grad=new gradient.Grid({cellWidth:canvas.width/w,cellHeight:canvas.height/h,gridWidth:w,gridHeight:h,init:['rgb','random'],updaters:['radiusGrow'],MIN_RADIUS:3,MAX_RADIUS:7,MAX_CPS:5,objCount:10});var lt=new Date(),target_fps=20;var loop=function(){var now=new Date(),t=now-lt;requestAnimationFrame(loop);if(t>1000/target_fps){grad.update();draw.back(ctx,canvas);draw.cells(ctx,grad);draw.info(ctx,canvas,grad);lt=now;}};loop();}());</script>
    </body>
</html>