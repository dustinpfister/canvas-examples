/*
   canvas-example-pop-the-lock
   Copyright 2020,2021 by Dustin Pfister
   https://raw.githubusercontent.com/dustinpfister/canvas-examples/master/LICENSE
 
   https://github.com/dustinpfister/canvas-examples
*/
var utils={};utils.noop=function(){};utils.isNaN=function(a){return String(a)==="NaN"&&typeof a!="string"};utils.getDimPer=function(n,base){base=base===undefined?2:base;return Math.log(base-(base-1)*1/(n+1),base)/Math.log(base,base)};utils.distance=function(x1,y1,x2,y2){return Math.sqrt(Math.pow(x1-x2,2)+Math.pow(y1-y2,2))};utils.boundingBox=function(x1,y1,w1,h1,x2,y2,w2,h2){return!(y1+h1<y2||y1>y2+h2||x1+w1<x2||x1>x2+w2)};utils.mod=function(x,m){return(x%m+m)%m};utils.clampPer=function(per){per=per>1?1:per;per=per<0?0:per;return per};utils.randomRange=function(a,b){var x=a,y=b;if(typeof a==="object"){x=a[0];y=a[1]}return x+(y-x)*Math.random()};utils.normalizeHalf=function(degree,scale){var halfScale=scale/2;return utils.mod(degree+halfScale,scale)-halfScale};utils.shortestDistance=function(a,b,scale){var halfScale=scale/2,diff=utils.normalizeHalf(a-b,scale);if(diff>halfScale){diff=diff-scale}return Math.abs(diff)};utils.createCanvas=function(opt){opt=opt||{};opt.container=opt.container||document.getElementById("canvas-app")||document.body;opt.canvas=document.createElement("canvas");opt.ctx=opt.canvas.getContext("2d");opt.canvas.className="canvas_example";opt.canvas.width=opt.width===undefined?320:opt.width;opt.canvas.height=opt.height===undefined?240:opt.height;opt.ctx.translate(.5,.5);opt.canvas.onselectstart=function(){return false};opt.canvas.style.imageRendering="pixelated";opt.ctx.imageSmoothingEnabled=false;opt.container.appendChild(opt.canvas);return opt};utils.getCanvasRelative=function(e){var canvas=e.target,bx=canvas.getBoundingClientRect(),pos={x:(e.changedTouches?e.changedTouches[0].clientX:e.clientX)-bx.left,y:(e.changedTouches?e.changedTouches[0].clientY:e.clientY)-bx.top,bx:bx};pos.x=Math.floor(pos.x/canvas.scrollWidth*canvas.width);pos.y=Math.floor(pos.y/canvas.scrollHeight*canvas.height);e.preventDefault();return pos};utils.save=function(appName,slotID,state){var key=appName+"-"+slotID;var str=JSON.stringify(state);localStorage.setItem(key,str)};utils.load=function(appName,slotID){var key=appName+"-"+slotID;var str=localStorage.getItem(key);if(str){try{return JSON.parse(str)}catch(e){return false}}return false};var poolMod=function(){var api={};var getInactive=function(pool){var i=pool.objects.length,obj;while(i--){obj=pool.objects[i];if(!obj.active){return obj}}return false};api.create=function(opt){opt=opt||{};opt.count=opt.count||10;var i=0,pool={maxSecs:opt.maxSecs||.125,objects:[],data:opt.data||{},spawn:opt.spawn||function(obj,pool,state,opt){},purge:opt.purge||function(obj,pool,state){},update:opt.update||function(obj,pool,state,secs){}};while(i<opt.count){pool.objects.push({active:false,i:i,x:opt.x===undefined?0:opt.x,y:opt.y===undefined?0:opt.y,w:opt.w===undefined?32:opt.w,h:opt.h===undefined?32:opt.h,heading:opt.heading===undefined?0:opt.heading,pps:opt.pps===undefined?32:opt.pps,lifespan:opt.lifespan||3,data:{}});i+=1}return pool};api.spawn=function(pool,state,opt){var obj=getInactive(pool);state=state||{};opt=opt||{};if(obj){if(!obj.active){obj.active=true;pool.spawn.call(pool,obj,pool,state,opt);return obj}}return false};api.update=function(pool,secs,state){var i=pool.objects.length,obj;state=state||{};secs=secs>=pool.maxSecs?pool.maxSecs:secs;while(i--){obj=pool.objects[i];if(obj.active){pool.update.call(pool,obj,pool,state,secs);obj.lifespan-=secs;obj.lifespan=obj.lifespan<0?0:obj.lifespan;if(obj.lifespan===0){obj.active=false;pool.purge.call(pool,obj,pool,state)}}}};api.setActiveStateForAll=function(pool,bool){bool=bool===undefined?false:bool;var i=pool.objects.length,obj;while(i--){obj=pool.objects[i];obj.active=bool}};api.getObjectAt=function(pool,x,y){var i=pool.objects.length,obj;while(i--){obj=pool.objects[i];if(obj.active){if(api.boundingBox(obj,{x:x,y:y,w:1,h:1})){return obj}}}return false};api.moveByPPS=function(obj,secs){obj.x+=Math.cos(obj.heading)*obj.pps*secs;obj.y+=Math.sin(obj.heading)*obj.pps*secs};api.moveByFramePerObj=function(obj,fp){var per=fp.frame/fp.frameMax;per=per>1?1:per;per=per<0?0:per;per=fp.rev?1-per:per;obj.x=fp.sx+Math.cos(fp.heading)*fp.dist*per;obj.y=fp.sy+Math.sin(fp.heading)*fp.dist*per};api.checkBounds=function(obj,canvas){if(obj.x>=canvas.width||obj.x<obj.w*-1||obj.y>canvas.height||obj.y<obj.h*-1){return false}return true};api.boundingBox=function(a,b){return utils.boundingBox(a.x,a.y,a.w,a.h,b.x,b.y,b.w,b.h)};return api}();var forFrame=function(){var DEFAULT_MAX_FRAME=50,DEFAULT_FRAME=0,DEFAULT_WIDTH=320,DEFAULT_HEIGHT=240,FORFRAME_BUILT_IN=function(){},FFDRAW_BUILT_IN=function(){};var setFrame=function(ff,frame){ff.frame=frame;ff.frame=utils.mod(ff.frame,ff.maxFrame);ff.per=ff.frame/ff.maxFrame;ff.bias=1-Math.abs(.5-ff.per)/.5;ff.model={};var argu=[ff.model,ff.model.points,ff.per];ff.model=ff.forFrame.apply(ff,[ff].concat(argu));return ff};var api={};api.create=function(opt){opt=opt||{};var ff={type:opt.type||"plain",frame:opt.frame||DEFAULT_FRAME,width:opt.width||DEFAULT_WIDTH,height:opt.height||DEFAULT_HEIGHT,maxFrame:opt.maxFrame||DEFAULT_MAX_FRAME,model:{},per:0,secs:0};ff.forFrame=opt.forFrame||FORFRAME_BUILT_IN;ff=setFrame(ff,ff.frame);return ff};api.step=function(ff,stepFrames){stepFrames=stepFrames===undefined?1:stepFrames;stepFrames=Math.round(stepFrames);return setFrame(ff,ff.frame+stepFrames)};api.update=function(ff,secs,fps){var frames;secs=secs===undefined?0:secs;fps=fps===undefined?30:fps;ff.secs+=secs;if(ff.secs>=1/fps){frames=Math.floor(ff.secs/(1/fps));api.step(ff,frames);ff.secs=utils.mod(ff.secs,1/fps)}return ff};api.createCanvas=function(ff,ffDraw,backFill,stroke,fill){var canvas=document.createElement("canvas"),ctx=canvas.getContext("2d");canvas.width=ff.width*ff.maxFrame;canvas.height=ff.height;ffDraw=ffDraw||FFDRAW_BUILT_IN;if(backFill){ctx.fillStyle=backFill;ctx.fillRect(0,0,canvas.width,canvas.height)}ff.frame=0;while(ff.frame<ff.maxFrame){setFrame(ff,ff.frame);ffDraw.apply(ff,[ff,ctx,canvas,stroke,fill]);ctx.translate(ff.width,0);ff.frame+=1}return{canvas:canvas,ctx:ctx,frame:0,maxFrame:ff.maxFrame,cellWidth:ff.width,cellHeight:ff.height,step:function(delta){delta=delta===undefined?1:delta;this.frame+=delta;this.frame=utils.mod(this.frame,this.maxFrame)},set:function(frame){frame=frame===undefined?0:frame;this.frame=frame;this.frame=utils.mod(this.frame,this.maxFrame)},draw:function(ctx,x,y,w,h){ctx.drawImage(this.canvas,this.cellWidth*this.frame,0,this.cellWidth,this.cellHeight,x,y,w,h)}}};return api}();var pixmapMod=function(){var api={};var plugins={};api.load=function(plug){var key=plug.name||"pix_"+Object.keys(plugins).length;plugins[key]=plug;console.log(plugins)};var createFF=function(maxFrame,w,h,pixdata,pallette){var size=w*h;return forFrame.create({maxFrame:maxFrame,width:w,height:h,forFrame:function(ff,model,frame,maxFrame,per){return{pallette:pallette,pixdata:pixdata.slice(ff.frame*size,ff.frame*size+size)}}})};var ffDraw=function(ff,ctx,canvas){var colors=ff.model.pallette;ctx.imageSmoothingEnabled=false;ff.model.pixdata.forEach(function(colorIndex,pxIndex){var x=pxIndex%ff.width,y=Math.floor(pxIndex/ff.width);if(typeof colors[colorIndex]==="string"){ctx.fillStyle=colors[colorIndex];ctx.fillRect(x,y,1,1)}})};api.create=function(opt){var pixmaps={};Object.keys(plugins).forEach(function(key){var plug=plugins[key];pixmaps[key]={};Object.keys(plug.ani).forEach(function(aniKey){var ani=plug.ani[aniKey],frameSize=ani.w*ani.h,maxFrame=ani.data.length/frameSize,palette=plug.palettes[ani.paletteIndex],ff=createFF(maxFrame,ani.w,ani.h,ani.data,palette);pixmaps[key][aniKey]=forFrame.createCanvas(ff,ffDraw)})});return pixmaps};return api}();pixmapMod.load({name:"default",palettes:[[false,"black","white","orange","yellow","red"]],ani:{circle_small:{paletteIndex:0,w:16,h:16,data:[0,0,0,0,0,0,2,2,2,2,0,0,0,0,0,0,0,0,0,0,2,2,1,1,1,1,2,2,0,0,0,0,0,0,0,2,1,1,2,2,2,2,1,1,2,0,0,0,0,0,2,1,2,2,3,3,3,3,2,2,1,2,0,0,0,2,1,2,3,3,3,3,3,3,3,3,2,1,2,0,0,2,1,2,3,3,3,3,3,3,3,3,2,1,2,0,2,1,2,3,3,3,3,3,3,3,3,3,3,2,1,2,2,1,2,3,3,3,3,3,3,3,3,3,3,2,1,2,2,1,2,3,3,3,3,3,3,3,3,3,3,2,1,2,2,1,2,3,3,3,3,3,3,3,3,3,3,2,1,2,0,2,1,2,3,3,3,3,3,3,3,3,2,1,2,0,0,2,1,2,3,3,3,3,3,3,3,3,2,1,2,0,0,0,2,1,2,2,3,3,3,3,2,2,1,2,0,0,0,0,0,2,1,1,2,2,2,2,1,1,2,0,0,0,0,0,0,0,2,2,1,1,1,1,2,2,0,0,0,0,0,0,0,0,0,0,2,2,2,2,0,0,0,0,0,0]},circle_big:{paletteIndex:0,w:1,h:1,data:[0]},circle_big_miss:{paletteIndex:0,w:1,h:1,data:[0]}}});pixmapMod.load({name:"mrsun",palettes:[[false,"black","white","orange","yellow","red"],[false,"black","white",false,"red","red"]],ani:{circle_small:{paletteIndex:1,w:16,h:16,data:[0,0,0,0,0,0,2,2,2,2,0,0,0,0,0,0,0,0,0,0,2,2,1,1,1,1,2,2,0,0,0,0,0,0,0,2,1,1,2,2,2,2,1,1,2,0,0,0,0,0,2,1,2,2,3,3,3,3,2,2,1,2,0,0,0,2,1,2,3,3,3,3,3,3,3,3,2,1,2,0,0,2,1,2,3,3,3,3,3,3,3,3,2,1,2,0,2,1,2,3,3,3,3,3,3,3,3,3,3,2,1,2,2,1,2,3,3,3,3,3,3,3,3,3,3,2,1,2,2,1,2,3,3,3,3,3,3,3,3,3,3,2,1,2,2,1,2,3,3,3,3,3,3,3,3,3,3,2,1,2,0,2,1,2,3,3,3,3,3,3,3,3,2,1,2,0,0,2,1,2,3,3,3,4,4,3,3,3,2,1,2,0,0,0,2,1,2,2,3,4,4,3,2,2,1,2,0,0,0,0,0,2,1,1,2,2,2,2,1,1,2,0,0,0,0,0,0,0,2,2,1,1,1,1,2,2,0,0,0,0,0,0,0,0,0,0,2,2,2,2,0,0,0,0,0,0,0,0,0,0,0,0,2,2,2,2,0,0,0,0,0,0,0,0,0,0,2,2,1,1,1,1,2,2,0,0,0,0,0,0,0,2,1,1,2,2,2,2,1,1,2,0,0,0,0,0,2,1,2,2,3,3,3,3,2,2,1,2,0,0,0,2,1,2,3,3,3,3,3,3,3,3,2,1,2,0,0,2,1,2,3,3,3,3,3,3,3,3,2,1,2,0,2,1,2,3,3,3,3,3,3,3,3,3,3,2,1,2,2,1,2,3,3,3,3,3,3,3,3,4,4,2,1,2,2,1,2,3,3,3,3,3,3,3,3,4,4,2,1,2,2,1,2,3,3,3,3,3,3,3,3,3,3,2,1,2,0,2,1,2,3,3,3,3,3,3,3,3,2,1,2,0,0,2,1,2,3,3,3,3,3,3,3,3,2,1,2,0,0,0,2,1,2,2,3,3,3,3,2,2,1,2,0,0,0,0,0,2,1,1,2,2,2,2,1,1,2,0,0,0,0,0,0,0,2,2,1,1,1,1,2,2,0,0,0,0,0,0,0,0,0,0,2,2,2,2,0,0,0,0,0,0,0,0,0,0,0,0,2,2,2,2,0,0,0,0,0,0,0,0,0,0,2,2,1,1,1,1,2,2,0,0,0,0,0,0,0,2,1,1,2,2,2,2,1,1,2,0,0,0,0,0,2,1,2,2,3,4,4,3,2,2,1,2,0,0,0,2,1,2,3,3,3,4,4,3,3,3,2,1,2,0,0,2,1,2,3,3,3,3,3,3,3,3,2,1,2,0,2,1,2,3,3,3,3,3,3,3,3,3,3,2,1,2,2,1,2,3,3,3,3,3,3,3,3,3,3,2,1,2,2,1,2,3,3,3,3,3,3,3,3,3,3,2,1,2,2,1,2,3,3,3,3,3,3,3,3,3,3,2,1,2,0,2,1,2,3,3,3,3,3,3,3,3,2,1,2,0,0,2,1,2,3,3,3,3,3,3,3,3,2,1,2,0,0,0,2,1,2,2,3,3,3,3,2,2,1,2,0,0,0,0,0,2,1,1,2,2,2,2,1,1,2,0,0,0,0,0,0,0,2,2,1,1,1,1,2,2,0,0,0,0,0,0,0,0,0,0,2,2,2,2,0,0,0,0,0,0,0,0,0,0,0,0,2,2,2,2,0,0,0,0,0,0,0,0,0,0,2,2,1,1,1,1,2,2,0,0,0,0,0,0,0,2,1,1,2,2,2,2,1,1,2,0,0,0,0,0,2,1,2,2,3,3,3,3,2,2,1,2,0,0,0,2,1,2,3,3,3,3,3,3,3,3,2,1,2,0,0,2,1,2,3,3,3,3,3,3,3,3,2,1,2,0,2,1,2,3,3,3,3,3,3,3,3,3,3,2,1,2,2,1,2,4,4,3,3,3,3,3,3,3,3,2,1,2,2,1,2,4,4,3,3,3,3,3,3,3,3,2,1,2,2,1,2,3,3,3,3,3,3,3,3,3,3,2,1,2,0,2,1,2,3,3,3,3,3,3,3,3,2,1,2,0,0,2,1,2,3,3,3,3,3,3,3,3,2,1,2,0,0,0,2,1,2,2,3,3,3,3,2,2,1,2,0,0,0,0,0,2,1,1,2,2,2,2,1,1,2,0,0,0,0,0,0,0,2,2,1,1,1,1,2,2,0,0,0,0,0,0,0,0,0,0,2,2,2,2,0,0,0,0,0,0]},circle_big:{paletteIndex:0,w:16,h:16,data:[0,0,0,0,0,0,0,3,3,0,0,0,0,0,0,0,0,0,0,0,0,3,3,4,4,3,3,0,0,0,0,0,0,0,0,3,3,4,4,4,4,4,4,3,3,0,0,0,0,0,3,4,4,4,4,4,4,4,4,4,4,3,0,0,0,0,3,4,4,4,4,4,4,4,4,4,4,3,0,0,0,3,4,4,4,4,4,4,4,4,4,4,4,4,3,0,0,3,4,4,1,1,1,4,4,1,1,1,4,4,3,0,3,4,4,4,2,5,2,4,4,2,5,2,4,4,4,3,3,4,4,4,4,4,4,4,4,4,4,4,4,4,4,3,0,3,4,4,4,4,4,1,1,4,4,4,4,4,3,0,0,3,4,4,4,4,4,4,4,4,4,4,4,4,3,0,0,0,3,4,4,1,4,4,4,4,1,4,4,3,0,0,0,0,3,4,4,4,1,1,1,1,4,4,4,3,0,0,0,0,0,3,3,4,4,4,4,4,4,3,3,0,0,0,0,0,0,0,0,3,3,4,4,3,3,0,0,0,0,0,0,0,0,0,0,0,0,3,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,3,0,0,0,0,0,0,0,0,0,0,0,0,3,3,4,4,3,3,0,0,0,0,0,0,0,0,3,3,4,4,4,4,4,4,3,3,0,0,0,0,0,3,4,4,4,4,4,4,4,4,4,4,3,0,0,0,0,3,4,4,4,4,4,4,4,4,4,4,3,0,0,0,3,4,4,4,4,4,4,4,4,4,4,4,4,3,0,0,3,4,4,1,1,1,4,4,1,1,1,4,4,3,0,3,4,4,4,2,2,5,4,4,2,2,5,4,4,4,3,3,4,4,4,4,4,4,4,4,4,4,4,4,4,4,3,0,3,4,4,4,4,4,1,1,4,4,4,4,4,3,0,0,3,4,4,4,4,4,4,4,4,4,4,4,4,3,0,0,0,3,4,4,4,4,1,1,4,4,4,4,3,0,0,0,0,3,4,4,4,4,1,1,4,4,4,4,3,0,0,0,0,0,3,3,4,4,4,4,4,4,3,3,0,0,0,0,0,0,0,0,3,3,4,4,3,3,0,0,0,0,0,0,0,0,0,0,0,0,3,3,0,0,0,0,0,0,0]},circle_big_miss:{paletteIndex:0,w:16,h:16,data:[0,0,0,0,0,0,0,3,3,0,0,0,0,0,0,0,0,0,0,0,0,3,3,5,5,3,3,0,0,0,0,0,0,0,0,3,3,5,5,5,5,5,5,3,3,0,0,0,0,0,3,5,5,5,5,5,5,5,5,5,5,3,0,0,0,0,3,5,5,5,5,5,5,5,5,5,5,3,0,0,0,3,5,5,5,5,5,5,5,5,5,5,5,5,3,0,0,3,5,5,1,1,1,5,5,1,1,1,5,5,3,0,3,5,5,5,2,5,2,5,5,2,5,2,5,5,5,3,3,5,5,5,5,5,5,5,5,5,5,5,5,5,5,3,0,3,5,5,5,5,5,1,1,5,5,5,5,5,3,0,0,3,5,5,5,5,5,5,5,5,5,5,5,5,3,0,0,0,3,5,5,5,5,5,5,5,5,5,5,3,0,0,0,0,3,5,5,5,1,1,1,1,5,5,5,3,0,0,0,0,0,3,3,5,5,5,5,5,5,3,3,0,0,0,0,0,0,0,0,3,3,5,5,3,3,0,0,0,0,0,0,0,0,0,0,0,0,3,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,3,0,0,0,0,0,0,0,0,0,0,0,0,3,3,5,5,3,3,0,0,0,0,0,0,0,0,3,3,5,5,5,5,5,5,3,3,0,0,0,0,0,3,5,5,5,5,5,5,5,5,5,5,3,0,0,0,0,3,5,5,5,5,5,5,5,5,5,5,3,0,0,0,3,5,5,1,5,5,5,5,5,5,1,5,5,3,0,0,3,5,5,5,1,1,5,5,1,1,5,5,5,3,0,3,5,5,5,2,5,2,1,1,2,5,2,5,5,5,3,3,5,5,5,5,5,5,5,5,5,5,5,5,5,5,3,0,3,5,5,5,5,5,1,1,5,5,5,5,5,3,0,0,3,5,5,5,5,5,5,5,5,5,5,5,5,3,0,0,0,3,5,5,5,1,1,1,1,5,5,5,3,0,0,0,0,3,5,5,5,5,1,1,5,5,5,5,3,0,0,0,0,0,3,3,5,5,5,5,5,5,3,3,0,0,0,0,0,0,0,0,3,3,5,5,3,3,0,0,0,0,0,0,0,0,0,0,0,0,3,3,0,0,0,0,0,0,0]}}});var gameMod=function(){var modeAPI={};var modes={};var getDistanceFromTarget=function(game){return utils.shortestDistance(game.deg.current,game.deg.target,game.deg.total)};var getInRange=function(game){return game.deg.distance<=game.deg.margin};var getTarget=function(game,degOrgin,per,rangePer){degOrgin=degOrgin===undefined?game.deg.current:degOrgin;per=utils.mod(per===undefined?0:per,1);rangePer=utils.clampPer(rangePer===undefined?1:rangePer);var halfDeg=game.deg.total/2,halfRange=halfDeg*rangePer,homeDeg=utils.mod(degOrgin+halfDeg,game.deg.total),deg=homeDeg-halfRange+halfRange*2*per;return utils.mod(Math.round(deg),game.deg.total)};var getTargetFrom=function(game,degOrgin,margin,dir){margin=margin===undefined?0:margin;dir=dir===undefined?1:dir;return utils.mod(Math.round(degOrgin+margin*dir),game.deg.total)};var getTargetRandom=modeAPI.getTargetRandom=function(game){return getTarget(game,game.deg.current,Math.random(),game.range)};var getTargetRandomTripUp=function(game){var deltaDeg=utils.randomRange(game.tripUp.degRange);return getTargetFrom(game,game.deg.current+deltaDeg*game.dir)};var newTarget=modeAPI.newTarget=function(game){if(game.tripUp.count>0){game.tripUp.count-=1}if(game.tripUp.count>=1){return getTargetRandomTripUp(game)}var roll=Math.random();if(roll<game.tripUp.chance){game.tripUp.count=Math.floor(utils.randomRange(game.tripUp.countRange));return getTargetRandomTripUp(game)}return getTargetRandom(game)};var api={};api.modes=modes;api.create=function(opt){opt=opt||{};var game={mode:opt.mode||"freePlay",level:1,targets:1,deg:{perSec:30,current:25,target:0,total:100,margin:4,distance:0},missTrack:{canMiss:false,count:0},clickTrack:{total:0,hits:0},tripUp:{count:0,chance:.12,countRange:[3,10],degRange:[15,25]},hp:{active:false,current:5,max:10,damage:1},gameOver:false,win:false,pause:true,range:.5,dir:-1,inRange:false,score:0};game.deg.target=newTarget(game);modes[game.mode].init(modeAPI,game,opt.modeSettings||{});game.deg.distance=getDistanceFromTarget(game);game.inRange=getInRange(game);return game};api.update=function(game,secs){if(!game.pause&&!game.gameOver){game.deg.current+=game.deg.perSec*secs*game.dir}game.deg.current=utils.mod(game.deg.current,game.deg.total);game.deg.distance=getDistanceFromTarget(game);game.inRange=getInRange(game);if(game.inRange){game.missTrack.canMiss=true}if(game.missTrack.canMiss&&!game.inRange){modes[game.mode].onMiss(modeAPI,game,secs);game.missTrack.canMiss=false}modes[game.mode].update(modeAPI,game,secs)};api.click=function(game,modeOptions){if(!game.pause&&!game.gameOver){game.clickTrack.total+=1;game.clickTrack.hits+=game.inRange?1:0;if(game.inRange){game.missTrack.canMiss=false;game.dir=game.dir===1?-1:1}modes[game.mode].onClick(modeAPI,game,modeOptions)}game.pause=false};api.loadMode=function(gameMode){["init","update","onMiss","onClick","draw"].forEach(function(key){gameMode[key]=gameMode[key]||utils.noop});gameMode.key=gameMode.key||"nameMe-"+Object.keys(modes).length;gameMode.settings=gameMode.settings||[];gameMode.background=gameMode.background||"#4a4a4a";gameMode.createBackground=gameMode.createBackground||false;modes[gameMode.key]=gameMode};return api}();gameMod.loadMode({key:"freePlay",settings:[{key:"perSec",disp:"Speed",start:35,range:[10,60]},{key:"margin",disp:"Margin",start:4,range:[0,20]},{key:"tripUpChance",disp:"Trip Up Chance",start:10,range:[0,100]},{key:"tripUpRange",disp:"Trip Up Range",start:35,range:[0,100]}],init:function(modeAPI,game,modeSettings){game.hp.active=false;game.win=true;game.score=0;game.perHitScore=0;game.deg.perSec=modeSettings.perSec||10;var deg=game.deg.total*.125;game.deg.margin=deg-modeSettings.margin/20*(deg-2)||1;game.tripUp.count=0;game.tripUp.chance=modeSettings.tripUpChance/100||0;var tpRangePer=1-modeSettings.tripUpRange/100;game.tripUp.degRange=[10+Math.round(15*tpRangePer),18+Math.round(32*tpRangePer)];game.tripUp.countRange=[4,12];game.baseBonus=100+Math.round(300*((modeSettings.perSec-10)/(100-10)));game.cirSmall={frame:0,fps:2,secs:0};game.cirBig={frame:0,aniKey:"circle_big",secs:0}},update:function(modeAPI,game,secs){var hits=game.clickTrack.hits,total=game.clickTrack.total,hitPer=game.clickTrack.hits/total,missLoss=1-1/(game.missTrack.count+1);hitPer=utils.isNaN(hitPer)?1:hitPer;var bonus=Math.floor(game.baseBonus*hitPer*(1-missLoss))*(total<100?total/100:1);game.score=Math.floor(game.perHitScore+bonus);var cs=game.cirSmall;cs.secs+=secs;if(cs.secs>1/cs.fps){cs.frame+=1;cs.frame=utils.mod(cs.frame,4);cs.secs=utils.mod(cs.secs,1/cs.fps)}game.cirBig.frame=0;if(game.cirBig.secs>0){game.cirBig.frame=1;game.cirBig.secs-=secs}},onMiss:function(modeAPI,game){game.missTrack.count+=1},onClick:function(modeAPI,game){game.cirBig.secs=.25;if(game.inRange){game.deg.target=modeAPI.newTarget(game);var hits=game.clickTrack.hits;var perHitScoreDelta=(1-utils.getDimPer(hits,.125))*10;game.perHitScore+=perHitScoreDelta;game.perHitScore=Number(game.perHitScore.toFixed(2));game.perHitScore=game.perHitScore>=100?100:game.perHitScore;game.cirBig.aniKey="circle_big"}else{game.cirBig.aniKey="circle_big_miss"}},background:"gray",createBackground:function(sm,mode){var gradient=draw.createGradient(sm.ctx,sm.canvas,Math.random());return gradient},draw:function(ctx,canvas,sm){draw.baseCircle_pixmap(ctx,sm,"mrsun",sm.game.cirBig.aniKey,sm.game.cirBig.frame);draw.baseCircle(ctx,sm.canvas,"black");draw.targetRange(ctx,sm.canvas,sm.game);draw.current_pos_pixmap(ctx,sm,"mrsun","circle_small",32,sm.game.cirSmall.frame);draw.score(ctx,canvas,sm)}});gameMod.loadMode({key:"suddendeath",settings:[{key:"levelStart",disp:"Start Level",start:1,range:[1,100]}],init:function(modeAPI,game,modeSettings){game.hp.active=false;game.deg.current=25;game.level=modeSettings.levelStart||1;game.levelCap=100;game.perSecLower=20;game.perSecHigher=80;game.deg.target=modeAPI.getTargetRandom(game)},update:function(modeAPI,game){var hits=game.clickTrack.hits;game.score=Math.floor(hits+Math.pow(1.075,hits))-1;var levPer=game.level/game.levelCap;game.deg.perSec=game.perSecLower+Math.round((game.perSecHigher-game.perSecLower)*levPer)},onMiss:function(modeAPI,game){game.missTrack.count=1;game.gameOver=true},onClick:function(modeAPI,game,modeSettings){if(game.inRange){game.deg.target=modeAPI.getTargetRandom(game);game.level+=1;game.level=game.level>game.levelCap?game.levelCap:game.level}else{game.gameOver=true}},createBackground:function(sm,mode){var gradient=draw.createGradient(sm.ctx,sm.canvas,.75,[[0,"black"],[1,"red"]]);return gradient},draw:function(ctx,canvas,sm){draw.baseCircle(ctx,sm.canvas,"black");draw.targetRange(ctx,sm.canvas,sm.game);draw.current_pos_pixmap(ctx,sm,"default","circle_small",32,0);draw.score(ctx,canvas,sm)}});gameMod.loadMode({key:"classic",settings:[{key:"level",disp:"Level",start:8,range:[1,100]}],init:function(modeAPI,game,modeSettings){game.hp.active=false;game.deg.current=25;modeSettings.level=game.level=modeSettings.level||1;game.levelCap=100;var levPer=game.level/game.levelCap;game.tripUp.chance=.1;game.tripUp.degRange=[20,30];game.perSecLower=20+20*levPer;game.perSecHigher=25+45*levPer;game.targets=game.level;game.deg.target=modeAPI.getTargetRandom(game)},update:function(modeAPI,game){var hits=game.clickTrack.hits;game.score=hits;game.deg.perSec=game.perSecLower+Math.round((game.perSecHigher-game.perSecLower)*(hits/game.level));game.deg.perSec=game.deg.perSec>game.perSecHigher?game.perSecHigher:game.deg.perSec},onMiss:function(modeAPI,game){game.missTrack.count=1;game.gameOver=true},onClick:function(modeAPI,game,modeSettings){if(game.inRange){game.deg.target=modeAPI.newTarget(game);game.targets-=1;if(game.targets===0){modeSettings.level+=1;modeSettings.level=modeSettings.level>game.levelCap?game.levelCap:modeSettings.level;game.gameOver=true;game.win=true}}else{game.gameOver=true}},createBackground:function(sm,mode){var gradient=draw.createGradient(sm.ctx,sm.canvas,.75,[[0,"purple"],[1,"cyan"]]);return gradient},draw:function(ctx,canvas,sm){draw.baseCircle(ctx,sm.canvas,"black");draw.targetRange(ctx,sm.canvas,sm.game);draw.current_pos_pixmap(ctx,sm,"default","circle_small",32,0);draw.score(ctx,canvas,sm)}});gameMod.loadMode({key:"endurance",settings:[{key:"levelStart",disp:"Start Level",start:10,range:[1,100]},{key:"perSecLower",disp:"Start Speed",start:30,range:[10,40]},{key:"dmgBase",disp:"Damage Base",start:10,range:[1,40]},{key:"maxHp",disp:"Max HP",start:100,range:[0,100]}],init:function(modeAPI,game,modeSettings){game.deg.current=25;game.hp.active=true;game.hp.max=10+Math.round(990*(modeSettings.maxHp/100));game.hp.current=game.hp.max;game.hp.perSec=10;game.hp.damage=1;game.hp.damageBase=1.025+.075*(modeSettings.dmgBase/40);game.level=modeSettings.levelStart||1;game.perSecLower=modeSettings.perSecLower||20;game.perSecHigher=80;game.deg.perSec=game.perSecLower;game.deg.target=modeAPI.getTargetRandom(game);game.deg.margin=5;game.tripUp.count=0;game.tripUp.chance=0;game.tripUp.degRange=[25,40];game.tripUp.countRange=[3,6]},update:function(modeAPI,game,secs){var hits=game.clickTrack.hits;var per=game.level/100;per=per>1?1:per;if(!game.pause){game.hp.perSec=10-9.5*per;game.hp.current+=game.hp.perSec*secs;game.hp.current=game.hp.current>=game.hp.max?game.hp.max:game.hp.current}game.deg.margin=6-3.5*per;game.tripUp.chance=per>.25?(per-.25)/.75*.75:0;game.hp.damage=1+Math.pow(game.hp.damageBase,game.level-1)-1;game.deg.perSec=game.perSecLower+Math.floor((game.perSecHigher-game.perSecLower)*(game.level/100));game.deg.perSec=game.deg.perSec>game.perSecHigher?game.perSecHigher:game.deg.perSec;if(game.hp.current<=0){game.gameOver=true}game.score=Math.floor(hits+Math.pow(1.075,hits))-1},onMiss:function(modeAPI,game){game.missTrack.count+=1;game.hp.current-=game.hp.damage},onClick:function(modeAPI,game,modeSettings){if(game.inRange){game.deg.target=modeAPI.newTarget(game);game.level+=1}else{game.hp.current-=game.hp.damage}},createBackground:function(sm,mode){var gradient=draw.createGradient(sm.ctx,sm.canvas,.625,[[0,"black"],[1,"lime"]]);return gradient},draw:function(ctx,canvas,sm){draw.baseCircle(ctx,sm.canvas,"black");draw.targetRange(ctx,sm.canvas,sm.game);draw.current_pos_pixmap(ctx,sm,"default","circle_small",32,0);draw.hpBar(ctx,canvas,sm.game);draw.score(ctx,canvas,sm)}});var stateMachine=function(){var api={};var STATES={};api.create=function(){var canvasObj=utils.createCanvas({width:640,height:480}),canvas=canvasObj.canvas,ctx=canvasObj.ctx;var sm={ver:"1.0.4",appName:"canvas-example-pop-the-lock",debugMode:false,pixmaps:pixmapMod.create(),canvas:canvas,ctx:ctx,game:{},highScores:{},lt:new Date,currentState:"title",gameModeIndex:0,gameMode:"",modeSettingsCollection:{},modeSettings:{},trans:{active:true,inState:true,secs:0,secsTotal:.5,onDone:utils.noop},states:STATES,buttons:api.createButtonPool(20),dispObjects:api.createButtonPool(2),background:"blue"};return sm};api.createButtonPool=function(count){return poolMod.create({count:count||20,maxSecs:.25,spawn:function(obj,pool,sm,opt){obj.data=opt;obj.x=opt.hx;obj.y=opt.hy;obj.w=opt.w||128;obj.h=opt.h||32},update:function(obj,pool,sm,secs){var fp={sx:obj.data.sx||0,sy:obj.data.sy||0,dist:obj.data.dist||0,heading:obj.data.heading||0,frame:Math.round(sm.trans.secs/sm.trans.secsTotal*50),frameMax:50,rev:!sm.trans.inState};poolMod.moveByFramePerObj(obj,fp);obj.lifespan=Infinity}})};api.spawnButton=function(sm,bx,actionString,dispText,angle,poolKey){poolKey=poolKey===undefined?"buttons":poolKey;angle=angle===undefined?Math.PI*.5:angle;var sx=bx.x+Math.cos(angle)*sm.canvas.width,sy=bx.y+Math.sin(angle)*sm.canvas.width;return poolMod.spawn(sm[poolKey],sm,{action:actionString,disp:dispText,sx:sx,sy:sy,w:bx.w||256,h:bx.h||64,alpha:.4,alpha2:.8,dist:utils.distance(bx.x,bx.y,sx,sy),heading:utils.mod(angle+Math.PI,Math.PI*2)})};api.getButtonByAction=function(buttonPool,action){var result=buttonPool.objects.filter(function(button){return button.active&&button.data.action===action});if(result.length>=1){return result[0]}return false};api.changeState=function(sm,stateKey){sm.currentState=stateKey;sm.trans.active=true;sm.trans.inState=true;sm.trans.secs=0;poolMod.setActiveStateForAll(sm.buttons,false);poolMod.setActiveStateForAll(sm.dispObjects,false);sm.states[sm.currentState].init(sm)};api.startStateChangeTrans=function(sm,stateKey){sm.trans.active=true;sm.trans.inState=false;sm.trans.secs=0;sm.trans.onDone=function(sm){api.changeState(sm,stateKey);sm.trans.onDone=function(){};sm.trans.onDone=utils.noop}};api.updateState=function(sm,secs){if(sm.trans.active){if(sm.trans.secs<sm.trans.secsTotal){sm.trans.secs+=secs;sm.trans.secs=sm.trans.secs>sm.trans.secsTotal?sm.trans.secsTotal:sm.trans.secs;if(sm.trans.secs===sm.trans.secsTotal){sm.trans.active=false;sm.trans.onDone(sm)}}sm.states[sm.currentState].trans(sm,secs)}else{sm.states[sm.currentState].update(sm,secs)}};api.load=function(stateObj){STATES[stateObj.key]=stateObj};return api}();(function(){stateMachine.load({key:"title",init:function(sm){var x=sm.canvas.width/2-128,y=sm.canvas.height/2;stateMachine.spawnButton(sm,{x:x,y:y-64},"start_state_gameMode","Play");stateMachine.spawnButton(sm,{x:x,y:y+32},"goto_devsite_canvas_examples","More Games",Math.PI);poolMod.spawn(sm.dispObjects,sm,{action:"dispobj_title",disp:"Pop The Lock",sx:sm.canvas.width*1.7*1,sy:8,w:512,h:128,dist:sm.canvas.width*1.6,heading:Math.PI,draw:function(ctx,obj){draw.text_title(ctx,sm.canvas,obj)}});sm.background=draw.createGradient(sm.ctx,sm.canvas,.75,[[0,"#cc0000"],[.25,"purple"],[1,"cyan"]])},trans:function(sm,secs){poolMod.update(sm.buttons,secs,sm);poolMod.update(sm.dispObjects,secs,sm)},update:function(sm,secs){},draw:function(sm,ctx,canvas){draw.background(ctx,canvas,sm.background);draw.buttonPool(ctx,sm.buttons);draw.pool(ctx,sm.dispObjects)},click:function(sm,pos,e){var button=poolMod.getObjectAt(sm.buttons,pos.x,pos.y);if(button){if(button.data.action==="start_state_gameMode"){stateMachine.startStateChangeTrans(sm,"gameMode")}if(button.data.action==="goto_devsite_canvas_examples"){document.location.href="https://dustinpfister.github.io/2020/03/23/canvas-example/"}}}})})();(function(){var spawnSettingsButton=function(sm,setting,bx,actionStringPart,dispText,angle,poolKey){var actionString="set_modesetting_"+actionStringPart+"_"+setting.key;var button=stateMachine.spawnButton(sm,bx,actionString,dispText,angle,poolKey);button.data.setting=setting;return button};var setModeProp=function(sm,parts,button,dir){var modeProp=sm.modeSettings[parts[3]],settingObj=button.data.setting,range=settingObj.range;modeProp+=1*dir;modeProp=dir===-1&&modeProp<range[0]?range[1]:modeProp;modeProp=dir===1&&modeProp>range[1]?range[0]:modeProp;sm.modeSettings[parts[3]]=modeProp;var dispButton=stateMachine.getButtonByAction(sm.buttons,"set_modesetting_current_"+settingObj.key);dispButton.data.disp=settingObj.disp+" "+sm.modeSettings[parts[3]]};stateMachine.load({key:"gameMode",init:function(sm){sm.gameMode=Object.keys(gameMod.modes)[sm.gameModeIndex];var mode=gameMod.modes[sm.gameMode];if(mode.createBackground){mode.background=mode.createBackground(sm,mode)}sm.modeSettings=sm.modeSettingsCollection[sm.gameMode];mode.settings.forEach(function(setting,i){var w=64,h=64,x=8,y=64+64*i;spawnSettingsButton(sm,setting,{x:x,y:y,w:w,h:h},"down","-");spawnSettingsButton(sm,setting,{x:x+w*5,y:y,w:w,h:h},"up","+");w=64*4;spawnSettingsButton(sm,setting,{x:x+64*1,y:y,w:w,h:h},"current",setting.disp+" "+sm.modeSettings[setting.key])});var w=64,h=64;stateMachine.spawnButton(sm,{x:sm.canvas.width-80,y:200,w:w,h:h},"set_mode_next","Next");var w=250,h=64;stateMachine.spawnButton(sm,{x:sm.canvas.width-275,y:sm.canvas.height-80,w:w,h:h},"start_game","Start");w=125;stateMachine.spawnButton(sm,{x:sm.canvas.width-150,y:32,w:w,h:h},"start_title","Title");var disp=stateMachine.spawnButton(sm,{x:8,y:8,w:200,h:32},"dispobj_currentMode",sm.gameMode,0,"dispObjects");disp.data.draw=function(ctx,obj){ctx.fillStyle="white";ctx.textBaseline="top";ctx.textAlign="left";ctx.font="50px arial";ctx.fillText(obj.data.disp,obj.x,obj.y)}},trans:function(sm,secs){poolMod.update(sm.buttons,secs,sm);poolMod.update(sm.dispObjects,secs,sm)},update:function(sm,secs){},draw:function(sm,ctx,canvas){draw.backgroundMode(ctx,canvas,sm);draw.buttonPool(ctx,sm.buttons);draw.pool(ctx,sm.dispObjects)},click:function(sm,pos,e){var button=poolMod.getObjectAt(sm.buttons,pos.x,pos.y);if(button){if(button.data.action==="start_game"){stateMachine.startStateChangeTrans(sm,"game")}if(button.data.action==="start_title"){stateMachine.startStateChangeTrans(sm,"title")}if(button.data.action==="set_mode_next"){sm.gameModeIndex+=1;sm.gameModeIndex=utils.mod(sm.gameModeIndex,Object.keys(gameMod.modes).length);stateMachine.startStateChangeTrans(sm,"gameMode")}var parts=button.data.action.split("_");if(parts[0]==="set"){if(parts[2]==="up"){setModeProp(sm,parts,button,1)}if(parts[2]==="down"){setModeProp(sm,parts,button,-1)}}}}})})();(function(){stateMachine.load({key:"game",init:function(sm){stateMachine.spawnButton(sm,{x:sm.canvas.width-72,y:8,w:64,h:64},"set_state_gameover","Quit",Math.PI);var disp=stateMachine.spawnButton(sm,{x:0,y:0,w:sm.canvas.width,h:sm.canvas.height},"dispobj_ptl",sm.gameMode,Math.PI*1.5,"dispObjects");disp.data.draw=function(ctx,obj){ctx.save();ctx.translate(obj.x,obj.y);gameMod.modes[sm.gameMode].draw(ctx,sm.canvas,sm);ctx.restore()};sm.game=gameMod.create({mode:sm.gameMode,modeSettings:sm.modeSettings})},trans:function(sm,secs){poolMod.update(sm.buttons,secs,sm);poolMod.update(sm.dispObjects,secs,sm)},update:function(sm,secs){gameMod.update(sm.game,secs);if(sm.game.gameOver){stateMachine.startStateChangeTrans(sm,"gameOver")}},draw:function(sm,ctx,canvas){draw.backgroundMode(ctx,canvas,sm);draw.buttonPool(ctx,sm.buttons);draw.pool(ctx,sm.dispObjects);if(sm.debugMode){draw.debugInfo(ctx,canvas,sm.game)}},click:function(sm,pos,e){var button=poolMod.getObjectAt(sm.buttons,pos.x,pos.y);if(button){if(button.data.action==="set_state_gameover"){stateMachine.startStateChangeTrans(sm,"gameOver")}}else{gameMod.click(sm.game,sm.modeSettings)}}})})();(function(){stateMachine.load({key:"gameOver",init:function(sm){var dispText=["Try Again","Settings","Title"];["game","gameMode","title"].forEach(function(stateKey,i){var bx={x:sm.canvas.width-176,y:sm.canvas.height*.25+70*i,w:168,h:64};stateMachine.spawnButton(sm,bx,"set_state_"+stateKey,dispText[i],0)});var disp=stateMachine.spawnButton(sm,{x:0,y:0,w:sm.canvas.width,h:sm.canvas.height},"dispobj_gameOver",sm.gameMode,Math.PI*.5,"dispObjects");disp.data.draw=function(ctx,obj){ctx.save();ctx.translate(obj.x,obj.y);draw.text_gameover(ctx,sm.canvas,sm);ctx.restore()};var highScore=sm.highScores[sm.game.mode];if(!highScore||highScore<sm.game.score){sm.highScores[sm.game.mode]=sm.game.score;utils.save(sm.appName,0,sm.highScores)}},trans:function(sm,secs){poolMod.update(sm.buttons,secs,sm);poolMod.update(sm.dispObjects,secs,sm)},update:function(sm,secs){},draw:function(sm,ctx,canvas){draw.backgroundMode(ctx,canvas,sm);draw.background(ctx,canvas,"rgba(0,0,0,0.8)");draw.buttonPool(ctx,sm.buttons);draw.pool(ctx,sm.dispObjects)},click:function(sm,pos,e){var button=poolMod.getObjectAt(sm.buttons,pos.x,pos.y);if(button){["title","gameMode","game"].forEach(function(stateKey,i){if(button.data.action==="set_state_"+stateKey){stateMachine.startStateChangeTrans(sm,stateKey)}})}}})})();var draw=function(){var CIRCLE_RADIUS=200;var api={};var text_base_center=function(ctx){ctx.fillStyle="white";ctx.textBaseline="middle";ctx.textAlign="center"};var text_title_center=function(ctx){text_base_center(ctx);ctx.font="50px arial"};var text_big_center=function(ctx){text_base_center(ctx);ctx.font="40px arial"};var text_big_left=function(ctx){text_base_center(ctx);ctx.textAlign="left";ctx.font="40px arial"};var text_med_center=function(ctx){text_base_center(ctx);ctx.font="20px arial"};var text_small_center=function(ctx){text_base_center(ctx);ctx.font="15px arial"};var text_game_stats=function(ctx){ctx.fillStyle="lime";ctx.textBaseline="top";ctx.font="10px arial";ctx.textAlign="left"};var baseCircle=api.baseCircle=function(ctx,canvas,style){ctx.strokeStyle=style||"white";ctx.lineWidth=6;ctx.beginPath();ctx.arc(canvas.width/2,canvas.height/2,CIRCLE_RADIUS,0,Math.PI*2);ctx.stroke()};api.baseCircle_pixmap=function(ctx,sm,pixmapKey,aniKey,frameIndex){var size=CIRCLE_RADIUS/2,halfSize=size/2,ani=sm.pixmaps[pixmapKey][aniKey];ani.set(frameIndex);ani.draw(ctx,sm.canvas.width/2-halfSize,sm.canvas.height/2-halfSize,size,size)};var targetRange=api.targetRange=function(ctx,canvas,game){ctx.strokeStyle=game.tripUp.count>0?"red":"orange";ctx.beginPath();ctx.lineWidth=8;ctx.arc(canvas.width/2,canvas.height/2,CIRCLE_RADIUS,utils.mod(game.deg.target-game.deg.margin,game.deg.total)/game.deg.total*Math.PI*2,utils.mod(game.deg.target+game.deg.margin,game.deg.total)/game.deg.total*Math.PI*2);ctx.stroke()};var current_pos=function(ctx,canvas,game,sm){ctx.strokeStyle="blue";ctx.beginPath();ctx.lineWidth=6;var r=game.deg.current/game.deg.total*Math.PI*2,x=Math.cos(r)*CIRCLE_RADIUS+canvas.width/2,y=Math.sin(r)*CIRCLE_RADIUS+canvas.height/2;ctx.arc(x,y,10,0,Math.PI*2);ctx.stroke();ctx.fill()};var current_pos_pixmap=api.current_pos_pixmap=function(ctx,sm,pixmapKey,aniKey,size,frameIndex){var halfSize=size/2,r=sm.game.deg.current/sm.game.deg.total*Math.PI*2,x=Math.cos(r)*CIRCLE_RADIUS+sm.canvas.width/2,y=Math.sin(r)*CIRCLE_RADIUS+sm.canvas.height/2;var ani=sm.pixmaps[pixmapKey]["circle_small"];ani.set(frameIndex);ani.draw(ctx,x-halfSize,y-halfSize,size,size)};var hpBar=api.hpBar=function(ctx,canvas,game){if(game.hp.active){ctx.fillStyle="black";ctx.fillRect(canvas.width/2-50,10,100,10);ctx.fillStyle="lime";var per=game.hp.current/game.hp.max;ctx.fillRect(canvas.width/2-50,10,100*per,10)}};var default_stops=[[0,"red"],[.2,"orange"],[.4,"yellow"],[.6,"blue"],[.8,"cyan"],[1,"lime"]];api.createGradient=function(ctx,canvas,angelePer,stops){angelePer=angelePer===undefined?.125:angelePer;stops=stops||default_stops;var size=Math.min.apply(null,[canvas.width,canvas.height]),radius=size/2,radian=Math.PI*2*angelePer,sx=canvas.width/2+Math.cos(radian)*radius,sy=canvas.height/2+Math.sin(radian)*radius,ex=canvas.width/2+Math.cos(radian+Math.PI)*radius,ey=canvas.height/2+Math.sin(radian+Math.PI)*radius,gradient=ctx.createLinearGradient(sx,sy,ex,ey);stops.forEach(function(st){gradient.addColorStop.apply(gradient,st)});return gradient};api.background=function(ctx,canvas,style){ctx.globalAlpha=1;ctx.fillStyle=style||"black";ctx.fillRect(0,0,canvas.width,canvas.height)};api.backgroundMode=function(ctx,canvas,sm){ctx.globalAlpha=1;ctx.fillStyle="black";var mode=gameMod.modes[sm.gameMode];if(mode){ctx.fillStyle=mode.background}ctx.fillRect(0,0,canvas.width,canvas.height)};var scoreModes={classic:function(ctx,canvas,sm,game){text_big_center(ctx);ctx.fillText(game.targets,canvas.width/2,canvas.height*.5)}};api.score=function(ctx,canvas,sm){var game=sm.game;if(sm.gameMode in scoreModes){scoreModes[sm.gameMode](ctx,canvas,sm,game)}else{text_big_center(ctx);ctx.fillText(game.score,canvas.width/2,canvas.height*.25);text_med_center(ctx);var miss=game.clickTrack.total-game.clickTrack.hits;ctx.fillText("late: "+game.missTrack.count+", miss: "+miss,canvas.width/2,canvas.height*.35);text_small_center(ctx);var hs=sm.highScores[sm.game.mode];if(hs){ctx.fillText("High Score: "+hs,canvas.width/2,canvas.height*.65)}}};api.text_title=function(ctx,canvas,obj){text_title_center(ctx);ctx.fillText("Pop The Lock",obj.x+obj.w/2,obj.y+obj.h/2)};api.text_gameover=function(ctx,canvas,sm){var game=sm.game,sx=canvas.width*.25-120,sy=canvas.height/2-25;text_big_left(ctx);ctx.fillText(game.win?"You Won!":"Game Over",sx,canvas.height*.25);text_game_stats(ctx);ctx.fillText("clicks (hits/total): "+game.clickTrack.hits+"/"+game.clickTrack.total,sx,sy+10);ctx.fillText("miss count: "+game.missTrack.count,sx,sy+20);ctx.fillText("score: "+game.score,sx,sy+40)};api.ver=function(ctx,canvas,sm){ctx.fillStyle="black";ctx.textBaseline="top";ctx.font="15px arial";ctx.textAlign="left";ctx.fillText("v"+sm.ver,5,canvas.height-15)};var drawPool=function(ctx,pool,globalDraw){var i=pool.objects.length,obj;ctx.fillStyle="white";ctx.strokeStyle="black";ctx.lineWidth=3;while(i--){obj=pool.objects[i];if(obj.active){ctx.save();if(obj.data.draw){obj.data.draw(ctx,obj,i)}else{globalDraw(ctx,obj,i)}ctx.restore()}}};api.pool=function(ctx,pool){drawPool(ctx,pool,function(ctx,obj,i){ctx.fillStyle=obj.data.fill||"white";ctx.globalAlpha=obj.data.alpha||1;ctx.translate(obj.x,obj.y);ctx.beginPath();ctx.rect(0,0,obj.w,obj.h);ctx.fill();ctx.stroke();ctx.globalAlpha=1})};api.buttonPool=function(ctx,pool){drawPool(ctx,pool,function(ctx,obj,i){ctx.fillStyle=obj.data.fill||"white";ctx.translate(obj.x,obj.y);ctx.beginPath();ctx.globalAlpha=obj.data.alpha===undefined?1:obj.data.alpha;ctx.rect(0,0,obj.w,obj.h);ctx.fill();ctx.globalAlpha=obj.data.alpha2===undefined?ctx.globalAlpha:obj.data.alpha2;ctx.stroke();if(obj.data.disp){ctx.fillStyle="black";ctx.textBaseline="middle";ctx.font="20px arial";ctx.textAlign="center";ctx.fillText(obj.data.disp,obj.w/2,obj.h/2)}ctx.globalAlpha=1})};api.debugInfo=function(ctx,canvas,game){ctx.fillStyle="yellow";ctx.textBaseline="top";ctx.textAlign="left";ctx.globalAlpha=.35;ctx.font="20px arial";ctx.fillText("deg.current "+game.deg.current.toFixed(2),10,20);ctx.fillText("deg.target "+game.deg.target,10,40);ctx.fillText("deg.distance "+game.deg.distance.toFixed(2),10,60);ctx.fillText("deg.perSec "+game.deg.perSec.toFixed(2),10,80);ctx.fillText("trip up count: "+game.tripUp.count,10,100);ctx.fillText("inrange "+game.inRange,10,120);ctx.fillText("miss count: "+game.missTrack.count,10,140);ctx.fillText("clicks (hits/total): "+game.clickTrack.hits+"/"+game.clickTrack.total,10,160);ctx.fillText("paused: "+game.pause,10,180);ctx.fillText("mode: "+game.mode,10,200);ctx.fillText("level: "+game.level,10,220)};return api}();(function(){var sm=stateMachine.create();var highScores=utils.load(sm.appName,"0");if(highScores){sm.highScores=highScores}sm.modeSettingsCollection={};Object.keys(gameMod.modes).forEach(function(modeKey){var mode=gameMod.modes[modeKey],settings={};mode.settings.forEach(function(settingObj){settings[settingObj.key]=settingObj.start});sm.modeSettingsCollection[modeKey]=settings});stateMachine.changeState(sm,"title");var loop=function(){var now=new Date,secs=(now-sm.lt)/1e3;requestAnimationFrame(loop);stateMachine.updateState(sm,secs);sm.states[sm.currentState].draw(sm,sm.ctx,sm.canvas);draw.ver(sm.ctx,sm.canvas,sm);sm.lt=now};loop();sm.canvas.addEventListener("mousedown",function(e){var pos=utils.getCanvasRelative(e);sm.states[sm.currentState].click(sm,pos,e)});sm.canvas.addEventListener("touchstart",function(e){var pos=utils.getCanvasRelative(e);sm.states[sm.currentState].click(sm,pos,e)})})();
