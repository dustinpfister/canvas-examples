/*
   canvas-example-pop-the-lock
   Copyright 2020 by Dustin Pfister
   https://raw.githubusercontent.com/dustinpfister/canvas-examples/master/LICENSE
 
   https://github.com/dustinpfister/canvas-examples
*/
var utils={};utils.distance=function(x1,y1,x2,y2){return Math.sqrt(Math.pow(x1-x2,2)+Math.pow(y1-y2,2))};utils.boundingBox=function(x1,y1,w1,h1,x2,y2,w2,h2){return!(y1+h1<y2||y1>y2+h2||x1+w1<x2||x1>x2+w2)};utils.mod=function(x,m){return(x%m+m)%m};utils.createCanvas=function(opt){opt=opt||{};opt.container=opt.container||document.getElementById("canvas-app")||document.body;opt.canvas=document.createElement("canvas");opt.ctx=opt.canvas.getContext("2d");opt.canvas.className="canvas_example";opt.canvas.width=opt.width===undefined?320:opt.width;opt.canvas.height=opt.height===undefined?240:opt.height;opt.ctx.translate(.5,.5);opt.canvas.onselectstart=function(){return false};opt.canvas.style.imageRendering="pixelated";opt.ctx.imageSmoothingEnabled=false;opt.container.appendChild(opt.canvas);return opt};utils.getCanvasRelative=function(e){var canvas=e.target,bx=canvas.getBoundingClientRect(),pos={x:(e.changedTouches?e.changedTouches[0].clientX:e.clientX)-bx.left,y:(e.changedTouches?e.changedTouches[0].clientY:e.clientY)-bx.top,bx:bx};pos.x=Math.floor(pos.x/canvas.scrollWidth*canvas.width);pos.y=Math.floor(pos.y/canvas.scrollHeight*canvas.height);e.preventDefault();return pos};var poolMod=function(){var api={};var getInactive=function(pool){var i=pool.objects.length,obj;while(i--){obj=pool.objects[i];if(!obj.active){return obj}}return false};api.create=function(opt){opt=opt||{};opt.count=opt.count||10;var i=0,pool={objects:[],data:opt.data||{},spawn:opt.spawn||function(obj,pool,state,opt){},purge:opt.purge||function(obj,pool,state){},update:opt.update||function(obj,pool,state,secs){}};while(i<opt.count){pool.objects.push({active:false,i:i,x:opt.x===undefined?0:opt.x,y:opt.y===undefined?0:opt.y,w:opt.w===undefined?32:opt.w,h:opt.h===undefined?32:opt.h,heading:opt.heading===undefined?0:opt.heading,pps:opt.pps===undefined?32:opt.pps,lifespan:opt.lifespan||3,data:{}});i+=1}return pool};api.spawn=function(pool,state,opt){var obj=getInactive(pool);state=state||{};opt=opt||{};if(obj){if(!obj.active){obj.active=true;pool.spawn.call(pool,obj,pool,state,opt);return obj}}return false};api.update=function(pool,secs,state){var i=pool.objects.length,obj;state=state||{};while(i--){obj=pool.objects[i];if(obj.active){pool.update.call(pool,obj,pool,state,secs);obj.lifespan-=secs;obj.lifespan=obj.lifespan<0?0:obj.lifespan;if(obj.lifespan===0){obj.active=false;pool.purge.call(pool,obj,pool,state)}}}};api.setActiveStateForAll=function(pool,bool){bool=bool===undefined?false:bool;var i=pool.objects.length,obj;while(i--){obj=pool.objects[i];obj.active=bool}};api.getObjectAt=function(pool,x,y){var i=pool.objects.length,obj;while(i--){obj=pool.objects[i];if(obj.active){if(api.boundingBox(obj,{x:x,y:y,w:1,h:1})){return obj}}}return false};api.moveByPPS=function(obj,secs){obj.x+=Math.cos(obj.heading)*obj.pps*secs;obj.y+=Math.sin(obj.heading)*obj.pps*secs};api.moveByFramePerObj=function(obj,fp){var per=fp.frame/fp.frameMax;per=per>1?1:per;per=per<0?0:per;per=fp.rev?1-per:per;obj.x=fp.sx+Math.cos(fp.heading)*fp.dist*per;obj.y=fp.sy+Math.sin(fp.heading)*fp.dist*per};api.checkBounds=function(obj,canvas){if(obj.x>=canvas.width||obj.x<obj.w*-1||obj.y>canvas.height||obj.y<obj.h*-1){return false}return true};api.boundingBox=function(a,b){return utils.boundingBox(a.x,a.y,a.w,a.h,b.x,b.y,b.w,b.h)};return api}();var gameMod=function(){var getInRange=function(game){return game.deg.current>=game.deg.target-game.deg.margin&&game.deg.current<=game.deg.target+game.deg.margin};var randomTarget=function(game){game.deg.target=Math.floor(Math.random()*(game.deg.total-game.deg.margin*2))+game.deg.margin};var api={};api.create=function(){var game={deg:{perSec:40,current:0,target:4,total:100,margin:4},dir:-1,inRange:false,score:0};randomTarget(game);return game};api.update=function(game,secs){game.deg.current+=game.deg.perSec*secs*game.dir;game.deg.current=utils.mod(game.deg.current,game.deg.total);game.inRange=getInRange(game)};api.click=function(game){game.score+=game.inRange?1:-1;if(game.inRange){game.dir=game.dir===1?-1:1;randomTarget(game)}};return api}();var draw=function(){var baseCircle=function(ctx,canvas){ctx.strokeStyle="white";ctx.lineWidth=3;ctx.beginPath();ctx.arc(canvas.width/2,canvas.height/2,100,0,Math.PI*2);ctx.stroke()};var targetRange=function(ctx,canvas,game){ctx.strokeStyle="red";ctx.beginPath();ctx.arc(canvas.width/2,canvas.height/2,100,utils.mod(game.deg.target-game.deg.margin,game.deg.total)/game.deg.total*Math.PI*2,utils.mod(game.deg.target+game.deg.margin,game.deg.total)/game.deg.total*Math.PI*2);ctx.stroke()};var info=function(ctx,canvas,game){ctx.fillStyle="yellow";ctx.textBaseline="top";ctx.textAlign="left";ctx.globalAlpha=.35;ctx.font="10px arial";ctx.fillText("deg.current "+game.deg.current.toFixed(2),10,10);ctx.fillText("inrange "+game.inRange,10,20)};var current_pos=function(ctx,canvas,game){ctx.strokeStyle="blue";ctx.beginPath();var r=game.deg.current/game.deg.total*Math.PI*2,x=Math.cos(r)*100+canvas.width/2,y=Math.sin(r)*100+canvas.height/2;ctx.arc(x,y,10,0,Math.PI*2);ctx.stroke()};var score=function(ctx,canvas,game){ctx.fillStyle=game.score>0?"green":"red";ctx.textBaseline="middle";ctx.textAlign="center";ctx.font="25px arial";ctx.fillText(game.score,canvas.width/2,canvas.height/2)};var api={};api.background=function(ctx,canvas,style){ctx.globalAlpha=1;ctx.fillStyle=style||"black";ctx.fillRect(0,0,canvas.width,canvas.height)};api.PTL=function(ctx,canvas,game){baseCircle(ctx,canvas);targetRange(ctx,canvas,game);current_pos(ctx,canvas,game);score(ctx,canvas,game);info(ctx,canvas,game)};api.titleText=function(ctx,canvas){ctx.fillStyle="white";ctx.textBaseline="middle";ctx.font="30px arial";ctx.textAlign="center";ctx.fillText("Pop The Lock",canvas.width/2,canvas.height/2-50)};api.ver=function(ctx,canvas,sm){ctx.fillStyle="white";ctx.textBaseline="top";ctx.font="10px arial";ctx.textAlign="left";ctx.fillText("v"+sm.ver,5,canvas.height-15)};api.pool=function(ctx,pool){var i=pool.objects.length,obj;ctx.fillStyle="white";ctx.strokeStyle="black";ctx.lineWidth=3;while(i--){obj=pool.objects[i];if(obj.active){ctx.save();ctx.fillStyle=obj.data.fill||"white";ctx.globalAlpha=obj.data.alpha||1;ctx.translate(obj.x,obj.y);ctx.beginPath();ctx.rect(0,0,obj.w,obj.h);ctx.fill();ctx.stroke();if(obj.data.disp){ctx.fillStyle="black";ctx.textBaseline="middle";ctx.font="10px arial";ctx.textAlign="center";ctx.fillText(obj.data.disp,obj.w/2,obj.h/2)}ctx.restore()}}};return api}();(function(){var canvasObj=utils.createCanvas({width:320,height:240}),canvas=canvasObj.canvas,ctx=canvasObj.ctx;var buttonPool=poolMod.create({spawn:function(obj,pool,sm,opt){console.log(opt);obj.data=opt;obj.x=opt.hx;obj.y=opt.hy;obj.w=opt.w||128;obj.h=opt.h||32},update:function(obj,pool,sm,secs){obj.lifespan=1;var fp={sx:obj.data.sx||0,sy:obj.data.sy||0,dist:obj.data.dist||0,heading:obj.data.heading||0,frame:Math.round(sm.trans.secs/sm.trans.secsTotal*50),frameMax:50,rev:obj.data.rev||false};poolMod.moveByFramePerObj(obj,fp)}});var sm={ver:"0.2.0",canvas:canvas,ctx:ctx,game:{},lt:new Date,currentState:"title",trans:{active:true,inState:true,secs:0,secsTotal:1},states:{},buttons:buttonPool};var changeState=function(sm,stateKey){sm.currentState=stateKey;sm.trans.active=true;sm.trans.inState=true;sm.trans.secs=0;sm.states[sm.currentState].init(sm)};var updateState=function(sm,secs){if(sm.trans.active){if(sm.trans.secs<sm.trans.secsTotal){sm.trans.secs+=secs;sm.trans.secs=sm.trans.secs>sm.trans.secsTotal?sm.trans.secsTotal:sm.trans.secs;if(sm.trans.secs===sm.trans.secsTotal){sm.trans.active=false;sm.trans.inState=false}}sm.states[sm.currentState].trans(sm,secs)}else{sm.states[sm.currentState].update(sm,secs)}};sm.states.title={init:function(sm){poolMod.setActiveStateForAll(sm.buttons,false);poolMod.spawn(sm.buttons,sm,{action:"set_state_game",disp:"New Game",sx:-150,sy:sm.canvas.height/2,dist:250,heading:0,rev:false})},trans:function(sm,secs){poolMod.update(sm.buttons,secs,sm)},update:function(sm,secs){},draw:function(sm,ctx,canvas){draw.titleText(ctx,canvas,sm);draw.pool(ctx,sm.buttons)},click:function(sm,pos,e){var obj=poolMod.getObjectAt(sm.buttons,pos.x,pos.y);if(obj){changeState(sm,"game")}}};sm.states.game={init:function(sm){sm.game=gameMod.create();poolMod.setActiveStateForAll(sm.buttons,false);poolMod.spawn(sm.buttons,sm,{action:"set_state_title",disp:"Quit",sx:sm.canvas.width+32,sy:0,dist:64,heading:Math.PI,rev:false,w:32,h:32})},trans:function(sm,secs){poolMod.update(sm.buttons,secs,sm)},update:function(sm,secs){gameMod.update(sm.game,secs)},draw:function(sm,ctx,canvas){draw.PTL(ctx,canvas,sm.game);draw.pool(ctx,sm.buttons)},click:function(sm,pos,e){var obj=poolMod.getObjectAt(sm.buttons,pos.x,pos.y);if(obj){changeState(sm,"title")}else{gameMod.click(sm.game)}}};changeState(sm,"title");var loop=function(){var now=new Date,secs=(now-sm.lt)/1e3;requestAnimationFrame(loop);updateState(sm,secs);draw.background(ctx,canvas,"#0a0a0a");sm.states[sm.currentState].draw(sm,ctx,canvas);draw.ver(ctx,canvas,sm);sm.lt=now};loop();canvas.addEventListener("click",function(e){var pos=utils.getCanvasRelative(e);sm.states[sm.currentState].click(sm,pos,e)})})();
