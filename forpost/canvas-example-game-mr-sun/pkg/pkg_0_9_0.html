<html>
<head>
<title>Canvas Example Mr Sun</title>
</head>
<body>
<div id="canvas-app" style="width:320px;height:240px;margin-left:auto;margin-right:auto;"></div>
<script>(function(){var utils={};utils.mod=function(x,m){return(x%m+m)%m};utils.getCanvasRelative=function(e){var canvas=e.target,bx=canvas.getBoundingClientRect();return{x:(e.changedTouches?e.changedTouches[0].clientX:e.clientX)-bx.left,y:(e.changedTouches?e.changedTouches[0].clientY:e.clientY)-bx.top,bx:bx}};utils.distance=function(x1,y1,x2,y2){return Math.sqrt(Math.pow(x1-x2,2)+Math.pow(y1-y2,2))};utils.logPer=function(per,a,b){a=a===undefined?2:a;b=b===undefined?a:b;per=per<0?0:per;per=per>1?1:per;return Math.log(1+a-2+per)/Math.log(b)};utils.createLogPerObject=function(i,len,base,max,a,b){a=a===undefined?2:a;b=b===undefined?a:b;base=base===undefined?0:base;max=max===undefined?1:max;var per=i/len,logPer=utils.logPer(per,a,b);return{i:i,len:len,per:per,logPer:logPer,n:base+logPer*(max-base),valueOf:function(){return this.n}}};utils.createLogPerCollection=function(opt){opt=opt||{};opt.len=opt.len===undefined?100:opt.len;opt.base=opt.base===undefined?0:opt.base;opt.max=opt.max===undefined?50:opt.max;opt.a=opt.a===undefined?2:opt.a;opt.b=opt.b===undefined?opt.a:opt.b;var i=0,obj,collection={len:opt.len,base:opt.base,max:opt.max,a:opt.a,b:opt.b};collection.data=[];while(i<opt.len){obj=utils.createLogPerObject(i,opt.len,opt.base,opt.max,opt.a,opt.b);collection.data.push(obj);i+=1}return collection};var gameMod=function(){var plugs={};var getCallPrioritySorted=function(){var keys=Object.keys(plugs);return keys.sort(function(a,b){var plugObjA=plugs[a],plugObjB=plugs[b];if(plugObjA.callPriority>plugObjB.callPriority){return 1}if(plugObjA.callPriority<plugObjB.callPriority){return-1}return 0})};var usePlugs=function(game,methodName,args){methodName=methodName||"create";args=args||[game];var keys=getCallPrioritySorted();keys.forEach(function(plugKey){var plugObj=plugs[plugKey],method=plugObj[methodName];if(method){method.apply(plugObj,args)}})};var api={};api.create=function(opt){opt=opt||{};opt.canvas=opt.canvas||{width:320,height:240};var game={};game.centerX=opt.centerX||opt.canvas.width/2;game.centerY=opt.centerY||opt.canvas.height/2;game.sectionRadius=opt.sectionRadius||16;game.worldRadius=opt.worldRadius||100;game.secs=0;game.year=opt.year||0;game.yearRate=opt.yearRate||1;game.sun={radius:16,x:game.centerX,y:game.centerY,sunGrid:{},text:""};var i=0,sections=[],total=opt.sectionCount||20,radian,cx=game.centerX,cy=game.centerY;while(i<total){radian=Math.PI*2/total*i;sections.push({i:i,x:Math.cos(radian)*game.worldRadius+cx,y:Math.sin(radian)*game.worldRadius+cy,radius:game.sectionRadius,per:1,text:""});i+=1}game.sections=sections;usePlugs(game,"create",[game,opt]);gameMod.updateSections(game);return game};api.updateSections=function(game){var sun=game.sun;game.sections.forEach(function(section){var ajust=section.radius+sun.radius;var d=utils.distance(section.x,section.y,sun.x,sun.y)-ajust;var per=d/(game.worldRadius*2-ajust*2);per=per>1?1:per;per=per<0?0:per;per=1-per;section.per=per})};api.getSectionByPos=function(game,x,y){var section,i=game.sections.length;while(i--){section=game.sections[i];if(utils.distance(section.x,section.y,x,y)<=section.radius){return section}}return false};var boundToCircle=function(obj,cx,cy,radius){if(utils.distance(obj.x,obj.y,cx,cy)>radius){var a=Math.atan2(obj.y-cy,obj.x-cx);obj.x=cx+Math.cos(a)*radius;obj.y=cy+Math.sin(a)*radius}};api.moveSun=function(game,pos){var ajust=game.sun.radius+game.sectionRadius;game.sun.x=pos.x;game.sun.y=pos.y;boundToCircle(game.sun,game.centerX,game.centerY,game.worldRadius-ajust);api.updateSections(sm.game)};api.update=function(game,secs){game.secs+=secs;var deltaYears=Math.floor(game.secs/game.yearRate);if(deltaYears>=1){game.year+=deltaYears;game.secs%=game.yearRate;usePlugs(game,"onDeltaYear",[game,deltaYears])}};api.load=function(plugObj){var len=Object.keys(plugs).length;plugObj.name=plugObj.name||len;plugObj.callPriority=plugObj.callPriority||len;plugs[plugObj.name]=plugObj};return api}();gameMod.load({name:"plug-api-base",callPriority:.1,create:function(game,opt){game.forSections=function(forEach){var i=0,len=game.sections.length;while(i<len){section=game.sections[i];forEach.call(game,section,i,game);i+=1}}},onDeltaYear:function(game,deltaYears){}});gameMod.load(function(){var LEVEL_CAP=100,DELTA_NEXT=50,XP_PER_YEAR=1;var XP=function(){var DEFAULTS={level:1,xp:0,cap:30,deltaNext:50};var set=function(xp,deltaNext){return(1+Math.sqrt(1+8*xp/deltaNext))/2};var getXPtoLevel=function(level,deltaNext){return(Math.pow(level,2)-level)*deltaNext/2};var parseByXP=function(xp,cap,deltaNext){xp=xp===undefined?DEFAULTS.xp:xp;cap=cap===undefined?DEFAULTS.cap:cap;deltaNext=deltaNext===undefined?DEFAULTS.deltaNext:deltaNext;var l=set(xp,deltaNext);l=l>cap?cap:l;var level=Math.floor(l),forNext=getXPtoLevel(level+1,deltaNext);forNext=l===cap?Infinity:forNext;var toNext=l===cap?Infinity:forNext-xp;var forLast=getXPtoLevel(level,deltaNext);return{level:level,levelFrac:l,xp:xp,per:(xp-forLast)/(forNext-forLast),forNext:forNext,toNext:toNext,forLast:forLast}};return{parseByLevel:function(l,cap,deltaNext){l=l===undefined?DEFAULTS.level:l;deltaNext=deltaNext===undefined?DEFAULTS.deltaNext:deltaNext;var xp=getXPtoLevel(l,deltaNext);console.log(xp);return parseByXP(xp,cap,deltaNext)},parseByXP:parseByXP}}();var setSunLevel=function(sun){sun.xp=sun.years*XP_PER_YEAR+sun.points;sun.levelObj=XP.parseByXP(sun.xp,LEVEL_CAP,DELTA_NEXT)};return{name:"sun",callPriority:"1.1",create:function(game,opt){var sun=game.sun;sun.addPoints=function(points){sun.points+=1;setSunLevel(sun)};sun.reset=function(){sun.points=0;sun.years=0;sun.exp=0;sun.levelObj={}};sun.reset();setSunLevel(sun)},onDeltaYear:function(game,deltaYears){var sun=game.sun;sun.years+=deltaYears;setSunLevel(sun)}}}());gameMod.load({name:"jar",callPriority:2.2,create:function(game,opt){game.jar={count:0}},onDeltaYear:function(game,deltaYears){game.sun.text=game.jar.count;game.forSections(function(section){if(section.per>=.98){game.jar.count+=section.cookie.count;game.sun.points=game.jar.count;section.cookie.count=0}})}});gameMod.load({name:"cookie",callPriority:2.1,create:function(game,opt){game.forSections(function(section){section.cookie={count:0,rate:1,max:10}})},onDeltaYear:function(game,deltaYears){game.forSections(function(section){var cookie=section.cookie;cookie.count+=cookie.rate*deltaYears;cookie.count=cookie.count>cookie.max?cookie.max:cookie.count;section.text=cookie.count+"/"+cookie.max})}});var stateMod=function(){var changeState=function(sm,stateKey,opt){opt=opt||{};var newState=sm.states[stateKey];sm.state=newState;sm.currentState=stateKey;if(newState.init){newState.init(sm,opt)}};var states={};var plugins={};var callMethodForAllPlugins=function(sm,methodName,args){var plugKeys=Object.keys(plugins);plugKeys.forEach(function(plugKey){var plugObj=plugins[plugKey];if(plugObj[methodName]){plugObj[methodName].apply(sm,args)}})};var pointerHanders={start:function(sm,pos,e){var pos=sm.input.pos;sm.input.pointerDown=true;sm.input.startPos={x:pos.x,y:pos.y};sm.input.d=0;callMethodForAllPlugins(sm,"pointerEvent",[sm,"start",pos,e,states[sm.currentState],sm.game])},move:function(sm,pos,e){var startPos=sm.input.startPos;sm.input.d=utils.distance(startPos.x,startPos.y,pos.x,pos.y);callMethodForAllPlugins(sm,"pointerEvent",[sm,"move",pos,e,states[sm.currentState],sm.game])},end:function(sm,pos,e){sm.input.pointerDown=false;callMethodForAllPlugins(sm,"pointerEvent",[sm,"end",pos,e,states[sm.currentState],sm.game])}};var createPointerHandler=function(sm,type){return function(e){var pos=utils.getCanvasRelative(e);sm.input.pos=pos;e.preventDefault();pointerHanders[type](sm,pos,e)}};var api={};api.load=function(obj){if(obj.type===undefined||obj.type==="state"){states[obj.name||Object.keys(states).length]=obj}if(obj.type==="plugin"){plugins[obj.name||Object.keys(plugins).length]=obj}};var createCanvas=function(opt){opt=opt||{};opt.container=opt.container||document.getElementById("canvas-app")||document.body;opt.canvas=document.createElement("canvas");opt.ctx=opt.canvas.getContext("2d");opt.container.appendChild(opt.canvas);opt.canvas.width=opt.width===undefined?320:opt.width;opt.canvas.height=opt.height===undefined?240:opt.height;opt.ctx.translate(.5,.5);return opt};api.create=function(opt){opt=opt||{};var can=createCanvas(opt);var sm={canvas:can.canvas,ctx:can.ctx,ver:opt.ver||"0.0.0",currentState:opt.currentState||"game",state:{},game:{},draw:{},data:{},states:states,input:{pointerDown:false,d:0,startPos:{x:0,y:0},pos:{x:0,y:0}}};sm.changeState=function(stateName,opt){changeState(sm,stateName,opt||{})};sm.canvas.addEventListener("mousedown",createPointerHandler(sm,"start"));sm.canvas.addEventListener("mousemove",createPointerHandler(sm,"move"));sm.canvas.addEventListener("mouseup",createPointerHandler(sm,"end"));sm.canvas.addEventListener("touchstart",createPointerHandler(sm,"start"));sm.canvas.addEventListener("touchmove",createPointerHandler(sm,"move"));sm.canvas.addEventListener("touchend",createPointerHandler(sm,"end"));sm.state=states[sm.currentState];callMethodForAllPlugins(sm,"create",[sm,opt]);Object.keys(states).forEach(function(stateName){var stateObj=states[stateName];if(stateObj.create){stateObj.create(sm)}});return sm};api.start=function(sm){var lt=new Date,FPS_target=30;sm.changeState(sm.currentState);var loop=function(){var now=new Date,t=now-lt,draw,update,secs=t/1e3;requestAnimationFrame(loop);if(t>=1e3/FPS_target){update=states[sm.currentState].update;if(update){callMethodForAllPlugins(sm,"update",[sm,secs]);update.call(sm,sm,secs)}draw=states[sm.currentState].draw;if(draw){draw.call(sm,sm.draw,sm.ctx,sm.canvas,sm.game,sm)}lt=now}};loop()};return api}();stateMod.load({name:"core-pointer",type:"plugin",pointerEvent:function(sm,type,pos,e,state,game){if(state.pointer){var method=state.pointer[type];if(method){method.call(sm,sm,pos,e,state,game)}}},update:function(sm){}});stateMod.load({name:"core-draw",type:"plugin",create:function(sm){var drawSprite=function(ctx,dispObj){var sprite=dispObj.sprite,sheet,fa=[];if(sprite){sheet=sprite.sheet;fa=sheet.frames.slice(sprite.frame*4,sprite.frame*4+4);ctx.save();ctx.globalAlpha=sprite.alpha;ctx.translate(dispObj.x,dispObj.y);ctx.rotate(sprite.radian);ctx.drawImage(sheet.img,fa[0],fa[1],fa[2],fa[3],sprite.x,sprite.y,sprite.w,sprite.h);ctx.restore()}};sm.draw.back=function(sm){var color="#000020";if(sm.currentState==="ui-sections"){var b=50+Math.round(sm.game.sections[sm.data.currentSection].per*128);color="rgb(0,0,"+b+")"}sm.ctx.fillStyle=color;sm.ctx.fillRect(0,0,sm.canvas.width,sm.canvas.height);drawSprite(sm.ctx,sm.background)};var drawSecton=function(ctx,section){var b=50+Math.round(section.per*128);ctx.fillStyle="rgb(0,0,"+b+")";ctx.beginPath();ctx.arc(section.x,section.y,section.radius,0,Math.PI*2);ctx.fill();ctx.strokeStyle="white";ctx.stroke();drawSprite(ctx,section)};sm.draw.sections=function(sm,sectionCollection){var ctx=sm.ctx;sectionCollection=sectionCollection||sm.game.sections;sectionCollection.forEach(function(section){drawSecton(ctx,section)});drawSecton(ctx,sectionCollection[sm.data.currentSection])};sm.draw.sun=function(sm){var sun=sm.game.sun,ctx=sm.ctx;ctx.fillStyle="yellow";ctx.beginPath();ctx.arc(sun.x,sun.y,sun.radius,0,Math.PI*2);ctx.fill();ctx.fillStyle="black";drawSprite(ctx,sun)};sm.draw.disp=function(sm){var ctx=sm.ctx;ctx.fillStyle="white";ctx.textAlign="left";ctx.textBaseline="top";ctx.font="10px courier";ctx.fillText("year: "+sm.game.year,3,10)};sm.draw.ver=function(sm){var ctx=sm.ctx;ctx.fillStyle="white";ctx.textAlign="left";ctx.textBaseline="top";ctx.font="10px courier";ctx.fillText("v"+sm.ver,10,sm.canvas.height-15)};sm.draw.buttons=function(sm){var ctx=sm.ctx,state=sm.states[sm.currentState];ctx.fillStyle="red";if(state.buttons){Object.keys(state.buttons).forEach(function(buttonKey){var button=state.buttons[buttonKey];ctx.beginPath();ctx.arc(button.x,button.y,button.r,0,Math.PI*2);ctx.fill();drawSprite(ctx,button)})}}}});stateMod.load({name:"core-game",type:"plugin",create:function(sm){sm.game=gameMod.create({canvas:sm.canvas,sectionCount:19,worldRadius:100,yearRate:.25,year:0})}});stateMod.load({name:"core-spritesheets",type:"plugin",create:function(sm){sm.sheets=[];var defaultSheet=function(){var canvas=document.createElement("canvas"),ctx=canvas.getContext("2d");canvas.width=32;canvas.height=32;ctx.translate(.5,.5);ctx.fillStyle="black";ctx.fillRect(0,0,32,32);ctx.strokeStyle="lime";ctx.lineWidth=3;ctx.beginPath();ctx.rect(0,0,31,31);ctx.moveTo(0,0);ctx.lineTo(31,31);ctx.moveTo(31,0);ctx.lineTo(0,31);ctx.stroke();return canvas};var defaultFrames=function(img){return[0,0,img.width,img.height]};var getSheet=function(sheetId){if(typeof sheetId==="string"){var i=sm.sheets.length,sheet;while(i--){sheet=sm.sheets[i];if(sheet.name===sheetId){return sheet}}}if(typeof sheetId==="number"){return sm.sheets[sheetId]}return sm.sheets[0]};sm.createSpriteSheetObj=function(img,name,frames,index){img=img===undefined?defaultSheet():img;index=index===undefined?sm.sheets.length:index;frames=frames===undefined?defaultFrames(img):frames;name=name===undefined?sm.sheets.length:name;sm.sheets[index]={name:name,img:img,frames:frames}};sm.createSpriteObj=function(sheetId,frame,x,y,w,h,alpha){return{sheet:getSheet(sheetId),frame:frame===undefined?0:frame,x:x===undefined?-12:x,y:y===undefined?-12:y,w:w===undefined?24:w,h:h===undefined?24:h,alpha:alpha===undefined?1:alpha,radian:0}};var img=defaultSheet();sm.createSpriteSheetObj(img,"default",defaultFrames(img),0);var sun=sm.game.sun;sm.game.forSections(function(section){section.sprite=sm.createSpriteObj("default",0,-16,-16,31,31,.75);section.sprite.radian=Math.atan2(sun.y-section.y,sun.x-section.x)});sm.game.sun.sprite=sm.createSpriteObj("default",0,-16,-16,31,31,.75);sm.background={x:0,y:0,sprite:sm.createSpriteObj("default",0,0,0,320,240,.25)}}});stateMod.load({name:"core-transitions",type:"plugin",create:function(sm){sm.startTrans=function(opt){opt=opt||{};opt.newStateName=opt.newStateName||"";opt.data=opt.data||{};var trans=sm.state.trans;if(trans){trans.frame=0;trans.secs=0;trans.newStateName=opt.newStateName;trans.data=opt.data;trans.action="start";trans.start(sm,trans,trans.data);trans.action="running";trans.forward=opt.forward===undefined?true:opt.forward}}},update:function(sm,secs){var trans=sm.state.trans;if(trans){if(trans.action==="running"){trans.secs+=secs;trans.per=trans.secs/trans.maxSecs;trans.per=trans.per>1?1:trans.per;trans.frame=Math.round(trans.maxFrame*trans.per);if(!trans.forward){trans.frame=trans.maxFrame-trans.frame;trans.per=1-trans.per}trans.update(sm,trans,trans.frame,trans.maxFrame,trans.per,trans.data);if(trans.forward&&trans.per===1||!trans.forward&&trans.per===0){trans.action="end";trans.end(sm,trans,trans.data);if(trans.newStateName!=""){sm.changeState(trans.newStateName)}}}}}});stateMod.load({name:"core-buttons",type:"plugin",create:function(sm){var createButton=function(opt){var button={};opt=opt||{};button.x=opt.x===undefined?0:opt.x;button.y=opt.y===undefined?0:opt.y;button.r=opt.r===undefined?16:opt.r;button.click=opt.click||function(){};button.sprite=sm.createSpriteObj("default",0);return button};Object.keys(sm.states).forEach(function(stateKey){var state=sm.states[stateKey];if(state.buttons){Object.keys(state.buttons).forEach(function(buttonKey){var button=state.buttons[buttonKey];if(typeof button==="function"){state.buttons[buttonKey]=button(sm,createButton)}if(typeof button==="object"){state.buttons[buttonKey]=createButton(button)}})}})},pointerEvent:function(sm,type,pos,e,state,game){if(state.buttons){if(type==="end"){var keys=Object.keys(state.buttons),button,i=keys.length;while(i--){button=state.buttons[keys[i]];if(utils.distance(button.x,button.y,pos.x,pos.y)<=button.r){button.click(sm,pos,button,e,state,game)}}}}}});stateMod.load({name:"ui-sun",create:function(sm){var sun=sm.game.sun;sun.move=function(game,pos){var radius=game.worldRadius-game.sectionRadius;if(utils.distance(pos.x,pos.y,game.centerX,game.centerY)<radius){gameMod.moveSun(game,pos)}};sm.sudoSectionsTrans=function(sm,trans,per){var csIndex=sm.data.currentSection,csSection=trans.data.sudoSections[csIndex];trans.data.sudoSections.forEach(function(sudoSection){var a=Math.atan2(sm.game.centerY-csSection.homeY,sm.game.centerX-csSection.homeX)+Math.PI;var dx=sm.game.worldRadius*Math.cos(a)*per;var dy=sm.game.worldRadius*Math.sin(a)*per;sudoSection.x=sudoSection.homeX-dx;sudoSection.y=sudoSection.homeY-dy;csSection.radius=csSection.homeRadius+sm.canvas.width*per;var sprite=sudoSection.sprite;sprite.x=320/2*per*-1;sprite.y=240/2*per*-1;sprite.w=Math.floor(320*per);sprite.h=Math.floor(240*per)})}},buttons:{sections:{x:300,y:20,r:16,click:function(sm,pos,button,e,state,game){sm.startTrans({newStateName:"ui-sections",forward:true,data:{}})}}},init:function(sm,opt){sm.startTrans({newStateName:"",forward:false,data:{}})},update:function(sm,secs){gameMod.update(sm.game,secs)},draw:function(d,ctx,canvas,game,sm){d.back(sm);if(sm.state.trans.action==="running"){d.sections(sm,sm.state.trans.data.sudoSections)}if(sm.state.trans.action==="end"){d.sections(sm);d.sun(sm);d.disp(sm);ctx.fillStyle="white";ctx.textAlign="center";ctx.textBaseline="middle";ctx.font="10px arial";game.forSections(function(section){ctx.fillText(section.text,section.x,section.y)});ctx.fillStyle="black";ctx.fillText(sm.game.sun.text,sm.game.sun.x,sm.game.sun.y)}d.buttons(sm);d.ver(sm)},pointer:{start:function(sm,pos,e){sm.game.sun.move(sm.game,pos)},move:function(sm,pos,e){if(sm.input.pointerDown){sm.game.sun.move(sm.game,pos);sm.game.forSections(function(section){section.sprite.alpha=section.per})}},end:function(sm,pos,e){if(sm.input.d<3){var section=gameMod.getSectionByPos(sm.game,pos.x,pos.y);if(section){sm.data.currentSection=section.i;sm.startTrans({newStateName:"ui-sections",forward:true,data:{}})}if(utils.distance(sm.game.sun.x,sm.game.sun.y,pos.x,pos.y)<=sm.game.sun.radius){}}}},trans:{maxFrame:50,maxSecs:.75,action:"end",start:function(sm,trans,data){var secButton=sm.state.buttons.sections;var per=1;if(trans.forward){secButton.x=300-320*1;per=1}else{secButton.x=300-320*0;per=0}trans.data.sudoSections=sm.game.sections.map(function(section){return{homeX:section.x,homeY:section.y,x:section.x,y:section.y,homeRadius:section.radius,radius:section.radius,per:section.per,sprite:sm.createSpriteObj("default",0)}});sm.sudoSectionsTrans(sm,trans,per)},update:function(sm,trans,frame,maxFrame,per,data){var secButton=sm.state.buttons.sections;secButton.x=300-320*per;sm.sudoSectionsTrans(sm,trans,per)},end:function(sm,trans,data){sm.state.buttons.sections.x=300}}});stateMod.load({name:"ui-sections",create:function(sm){sm.data=sm.data||{};sm.data.currentSection=0},buttons:{back:function(sm,createButton){return createButton({x:300,y:20,click:function(sm){sm.startTrans({newStateName:"ui-sun",forward:true,data:{}})}})},left:{x:20,y:120,r:16,click:function(sm){sm.data.currentSection+=1;sm.data.currentSection=sm.data.currentSection>=sm.game.sections.length?0:sm.data.currentSection}},right:{x:300,y:120,r:16,click:function(sm){sm.data.currentSection-=1;sm.data.currentSection=sm.data.currentSection<0?sm.game.sections.length-1:sm.data.currentSection}}},init:function(sm,opt){sm.startTrans({newStateName:"",forward:false,data:{}})},update:function(sm,secs){gameMod.update(sm.game,secs)},draw:function(d,ctx,canvas,game,sm){d.back(sm);d.buttons(sm);d.ver(sm);ctx.fillStyle="white";ctx.textAlign="left";ctx.textBaseline="middle";ctx.font="10px arial";ctx.fillText("section# : "+sm.data.currentSection,10,10);var section=sm.game.sections[sm.data.currentSection];ctx.fillText("per : "+section.per.toFixed(2),10,60)},trans:{maxFrame:50,maxSecs:.75,action:"end",start:function(sm,trans,data){var buttons=sm.state.buttons;buttons.back.x=-20;buttons.left.x=-20;buttons.right.x=-20},update:function(sm,trans,frame,maxFrame,per,data){var buttons=sm.state.buttons;buttons.back.x=300-320*per;buttons.left.x=20-32*per;buttons.right.x=sm.canvas.width-20+32*per},end:function(sm,trans,data){}}});var sm=stateMod.create({ver:"0.9.0",currentState:"ui-sun"});stateMod.start(sm);}());</script>
</body>
</html>
