<html>
<head>
<title>Canvas Example Mr Sun</title>
</head>
<body>
<div id="canvas-app" style="width:320px;height:240px;margin-left:auto;margin-right:auto;"></div>
<script>var utils={};utils.mod=function(x,m){return(x%m+m)%m};utils.getCanvasRelative=function(e){var canvas=e.target,bx=canvas.getBoundingClientRect();return{x:(e.changedTouches?e.changedTouches[0].clientX:e.clientX)-bx.left,y:(e.changedTouches?e.changedTouches[0].clientY:e.clientY)-bx.top,bx:bx}};utils.distance=function(x1,y1,x2,y2){return Math.sqrt(Math.pow(x1-x2,2)+Math.pow(y1-y2,2))};utils.logPer=function(per,a,b){a=a===undefined?2:a;b=b===undefined?a:b;per=per<0?0:per;per=per>1?1:per;return Math.log(1+a-2+per)/Math.log(b)};utils.createLogPerObject=function(i,len,base,max,a,b){a=a===undefined?2:a;b=b===undefined?a:b;base=base===undefined?0:base;max=max===undefined?1:max;var per=i/len,logPer=utils.logPer(per,a,b);return{i:i,len:len,per:per,logPer:logPer,n:base+logPer*(max-base),valueOf:function(){return this.n}}};utils.createLogPerCollection=function(opt){opt=opt||{};opt.len=opt.len===undefined?100:opt.len;opt.base=opt.base===undefined?0:opt.base;opt.max=opt.max===undefined?50:opt.max;opt.a=opt.a===undefined?2:opt.a;opt.b=opt.b===undefined?opt.a:opt.b;var i=0,obj,collection={len:opt.len,base:opt.base,max:opt.max,a:opt.a,b:opt.b};collection.data=[];while(i<opt.len){obj=utils.createLogPerObject(i,opt.len,opt.base,opt.max,opt.a,opt.b);collection.data.push(obj);i+=1}return collection};var gameMod=function(){var plugs={};var getCallPrioritySorted=function(){var keys=Object.keys(plugs);return keys.sort(function(a,b){var plugObjA=plugs[a],plugObjB=plugs[b];if(plugObjA.callPriority>plugObjB.callPriority){return 1}if(plugObjA.callPriority<plugObjB.callPriority){return-1}return 0})};var usePlugs=function(game,methodName,args){methodName=methodName||"create";args=args||[game];var keys=getCallPrioritySorted();keys.forEach(function(plugKey){var plugObj=plugs[plugKey],method=plugObj[methodName];if(method){method.apply(plugObj,args)}})};var api={};api.create=function(opt){opt=opt||{};opt.canvas=opt.canvas||{width:320,height:240};var game={};game.centerX=opt.centerX||opt.canvas.width/2;game.centerY=opt.centerY||opt.canvas.height/2;game.sectionRadius=opt.sectionRadius||16;game.worldRadius=opt.worldRadius||100;game.secs=0;game.year=opt.year||0;game.yearRate=opt.yearRate||1;game.sun={radius:16,x:game.centerX,y:game.centerY,sunGrid:{}};var i=0,sections=[],total=opt.sectionCount||20,radian,cx=game.centerX,cy=game.centerY;while(i<total){radian=Math.PI*2/total*i;sections.push({i:i,x:Math.cos(radian)*game.worldRadius+cx,y:Math.sin(radian)*game.worldRadius+cy,radius:game.sectionRadius,per:1});i+=1}game.sections=sections;usePlugs(game,"create",[game,opt]);gameMod.updateSections(game);return game};api.updateSections=function(game){var sun=game.sun;game.sections.forEach(function(section){var ajust=section.radius+sun.radius;var d=utils.distance(section.x,section.y,sun.x,sun.y)-ajust;var per=d/(game.worldRadius*2-ajust*2);per=per>1?1:per;per=per<0?0:per;per=1-per;section.per=per})};api.getSectionByPos=function(game,x,y){var section,i=game.sections.length;while(i--){section=game.sections[i];if(utils.distance(section.x,section.y,x,y)<=section.radius){return section}}return false};var boundToCircle=function(obj,cx,cy,radius){if(utils.distance(obj.x,obj.y,cx,cy)>radius){var a=Math.atan2(obj.y-cy,obj.x-cx);obj.x=cx+Math.cos(a)*radius;obj.y=cy+Math.sin(a)*radius}};api.moveSun=function(game,pos){var ajust=game.sun.radius+game.sectionRadius;game.sun.x=pos.x;game.sun.y=pos.y;boundToCircle(game.sun,game.centerX,game.centerY,game.worldRadius-ajust);api.updateSections(sm.game)};api.update=function(game,secs){game.secs+=secs;var deltaYears=Math.floor(game.secs/game.yearRate);if(deltaYears>=1){game.year+=deltaYears;game.secs%=game.yearRate;usePlugs(game,"onDeltaYear",[game,deltaYears])}};api.load=function(plugObj){var len=Object.keys(plugs).length;plugObj.name=plugObj.name||len;plugObj.callPriority=plugObj.callPriority||len;plugs[plugObj.name]=plugObj};return api}();gameMod.load({name:"plug-api-base",callPriority:.1,create:function(game,opt){console.log(this.name);game.forSections=function(forEach){var i=0,len=game.sections.length;while(i<len){section=game.sections[i];forEach.call(game,section,i,game);i+=1}}},onDeltaYear:function(game,deltaYears){}});gameMod.load(function(){var LEVEL_CAP=100,DELTA_NEXT=50,XP_PER_YEAR=1;var XP=function(){var DEFAULTS={level:1,xp:0,cap:30,deltaNext:50};var set=function(xp,deltaNext){return(1+Math.sqrt(1+8*xp/deltaNext))/2};var getXPtoLevel=function(level,deltaNext){return(Math.pow(level,2)-level)*deltaNext/2};var parseByXP=function(xp,cap,deltaNext){xp=xp===undefined?DEFAULTS.xp:xp;cap=cap===undefined?DEFAULTS.cap:cap;deltaNext=deltaNext===undefined?DEFAULTS.deltaNext:deltaNext;var l=set(xp,deltaNext);l=l>cap?cap:l;var level=Math.floor(l),forNext=getXPtoLevel(level+1,deltaNext);forNext=l===cap?Infinity:forNext;var toNext=l===cap?Infinity:forNext-xp;var forLast=getXPtoLevel(level,deltaNext);return{level:level,levelFrac:l,xp:xp,per:(xp-forLast)/(forNext-forLast),forNext:forNext,toNext:toNext,forLast:forLast}};return{parseByLevel:function(l,cap,deltaNext){l=l===undefined?DEFAULTS.level:l;deltaNext=deltaNext===undefined?DEFAULTS.deltaNext:deltaNext;var xp=getXPtoLevel(l,deltaNext);console.log(xp);return parseByXP(xp,cap,deltaNext)},parseByXP:parseByXP}}();var setSunLevel=function(sun){sun.xp=sun.years*XP_PER_YEAR+sun.points;sun.levelObj=XP.parseByXP(sun.xp,LEVEL_CAP,DELTA_NEXT)};return{name:"sun",callPriority:"1.1",create:function(game,opt){console.log(this.name);var sun=game.sun;sun.addPoints=function(points){sun.points+=1;setSunLevel(sun)};sun.reset=function(){sun.points=0;sun.years=0;sun.exp=0;sun.levelObj={}};sun.reset();setSunLevel(sun)},onDeltaYear:function(game,deltaYears){var sun=game.sun;sun.years+=deltaYears;setSunLevel(sun)}}}());gameMod.load({name:"jar",callPriority:2.2,create:function(game,opt){console.log(this.name);game.jar={count:0}},onDeltaYear:function(game,deltaYears){game.forSections(function(section){if(section.per>=.98){game.jar.count+=section.cookie.count;game.sun.points=game.jar.count;section.cookie.count=0}})}});gameMod.load({name:"cookie",callPriority:2.1,create:function(game,opt){console.log(this.name);game.forSections(function(section){section.cookie={count:0,rate:1,max:10}})},onDeltaYear:function(game,deltaYears){game.forSections(function(section){var cookie=section.cookie;cookie.count+=cookie.rate*deltaYears;cookie.count=cookie.count>cookie.max?cookie.max:cookie.count})}});var draw=function(){var api={};api.back=function(sm){sm.ctx.fillStyle="#202020";sm.ctx.fillRect(0,0,sm.canvas.width,sm.canvas.height)};api.sections=function(sm){var ctx=sm.ctx;sm.game.sections.forEach(function(section){var b=50+Math.round(section.per*128);ctx.fillStyle="rgb(0,0,"+b+")";ctx.beginPath();ctx.arc(section.x,section.y,section.radius,0,Math.PI*2);ctx.fill();ctx.fillStyle="white";ctx.textAlign="center";ctx.textBaseline="middle";ctx.font="10px arial";ctx.fillText(section.cookie.count,section.x,section.y)})};api.sun=function(sm){var sun=sm.game.sun,ctx=sm.ctx;ctx.fillStyle="yellow";ctx.beginPath();ctx.arc(sun.x,sun.y,sun.radius,0,Math.PI*2);ctx.fill();ctx.fillStyle="black";ctx.fillText(sm.game.jar.count,sun.x,sun.y)};api.disp=function(sm){var ctx=sm.ctx;ctx.fillStyle="white";ctx.textAlign="left";ctx.textBaseline="top";ctx.font="10px courier";ctx.fillText("year: "+sm.game.year,3,10);ctx.fillText("sun exp: "+sm.game.sun.xp,3,20);ctx.fillText("sun level: "+sm.game.sun.levelObj.level,3,30)};api.ver=function(sm){var ctx=sm.ctx;ctx.fillStyle="white";ctx.textAlign="left";ctx.textBaseline="top";ctx.font="10px courier";ctx.fillText("v"+sm.ver,10,sm.canvas.height-15)};return api}();var canvas=document.createElement("canvas"),ctx=canvas.getContext("2d"),container=document.getElementById("canvas-app")||document.body;container.appendChild(canvas);canvas.width=320;canvas.height=240;ctx.translate(.5,.5);var states={game:{init:function(sm){sm.game=gameMod.create({canvas:sm.canvas,sectionCount:19,worldRadius:100})},update:function(sm,secs){gameMod.update(sm.game,secs);draw.back(sm);draw.sections(sm);draw.sun(sm);draw.disp(sm);draw.ver(sm)},pointerStart:function(sm,pos,e){},pointerMove:function(sm,pos,e){var sun=sm.game.sun;if(sm.input.pointerDown){gameMod.moveSun(sm.game,pos)}},pointerEnd:function(){}}};var sm={ver:"0.3.0",canvas:canvas,currentState:"game",ctx:ctx,game:{},input:{pointerDown:false,pos:{x:0,y:0}}};var pointerHanders={start:function(sm,pos,e){var pos=sm.input.pos;sm.input.pointerDown=true;states[sm.currentState].pointerStart(sm,pos,e)},move:function(sm,pos,e){states[sm.currentState].pointerMove(sm,pos,e)},end:function(sm,pos,e){sm.input.pointerDown=false;states[sm.currentState].pointerEnd(sm,pos,e)}};var createPointerHandler=function(sm,type){return function(e){var pos=utils.getCanvasRelative(e);sm.input.pos=pos;e.preventDefault();pointerHanders[type](sm,pos,e)}};canvas.addEventListener("mousedown",createPointerHandler(sm,"start"));canvas.addEventListener("mousemove",createPointerHandler(sm,"move"));canvas.addEventListener("mouseup",createPointerHandler(sm,"end"));canvas.addEventListener("touchstart",createPointerHandler(sm,"start"));canvas.addEventListener("touchmove",createPointerHandler(sm,"move"));canvas.addEventListener("touchend",createPointerHandler(sm,"end"));states[sm.currentState].init(sm);var lt=new Date,FPS_target=30;var loop=function(){var now=new Date,t=now-lt,secs=t/1e3;requestAnimationFrame(loop);if(t>=1e3/FPS_target){states[sm.currentState].update(sm,secs);lt=now}};loop();</script>
</body>
</html>
