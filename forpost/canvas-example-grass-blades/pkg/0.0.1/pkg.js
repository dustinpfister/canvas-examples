/*
   canvas-example-grass-blades
   Copyright 2020 by Dustin Pfister
   https://raw.githubusercontent.com/dustinpfister/canvas-examples/master/LICENSE
 
   https://github.com/dustinpfister/canvas-examples
*/
var utils={};utils.createCanvas=function(opt){opt=opt||{};opt.container=opt.container||document.getElementById("canvas-app")||document.body;opt.canvas=document.createElement("canvas");opt.ctx=opt.canvas.getContext("2d");opt.canvas.className="canvas_example";opt.canvas.width=opt.width===undefined?320:opt.width;opt.canvas.height=opt.height===undefined?240:opt.height;opt.ctx.translate(.5,.5);opt.canvas.onselectstart=function(){return false};opt.container.appendChild(opt.canvas);return opt};var Blade=function(){var createPoints=function(blade,ptCount){var points=[],bp=blade.basePos,i=0,a,x=bp.x,y=bp.y;aDelta=Math.PI/180*blade.turn;while(i<ptCount){a=Math.PI*1.5+aDelta/(ptCount-2)*i;points.push({x:x,y:y});x+=Math.cos(a)*blade.segLength;y+=Math.sin(a)*blade.segLength;i+=1}return points};return{create:function(opt){opt=opt||{};opt.ptCount=opt.ptCount||24;opt.canvas=opt.canvas||{width:320,heigh:240};opt.baseX=opt.baseX===undefined?canvas.width/2:opt.baseX;var blade={basePos:{y:canvas.height,x:opt.baseX},r:opt.g===undefined?0:opt.r,g:opt.g===undefined?255:opt.g,b:opt.g===undefined?0:opt.b,width:{min:opt.widthMin||3,max:opt.widthMax||20},turn:opt.turn===undefined?0:opt.turn,segLength:opt.segLength===undefined?10:opt.segLength,points:[],t:opt.t===undefined?0:opt.t,tMax:opt.tMax===undefined?0:opt.tMax};blade.points=createPoints(blade,opt.ptCount);return blade}}}();var Grass=function(){return{create:function(opt){opt=opt||{};return{ver:"0.0.1",maxBlades:opt.maxBlades||10,spawnRate:opt.spawnRate||300,canvas:opt.canvas||{width:320,heigh:240},t:0,blades:[]}},update:function(grass,t){grass.t+=t;grass.blades.forEach(function(blade){blade.t+=t;blade.t=blade.t>blade.tMax?blade.tMax:blade.t});if(grass.t>=grass.spawnRate){if(grass.blades.length>=grass.maxBlades){grass.blades.shift()}grass.blades.push(Blade.create({r:100+Math.floor(156*Math.random()),g:100+Math.floor(156*Math.random()),b:100+Math.floor(156*Math.random()),baseX:Math.floor(grass.canvas.width*Math.random()),turn:-180+360*Math.random(),tMax:1e3+Math.floor(2e4*Math.random()),ptCount:20+Math.floor(30*Math.random()),segLength:5,widthMin:1,widthMax:5}));grass.t%=grass.spawnRate}}}}();var draw=function(){var drawBlade=function(ctx,blade,style){var i=1,per,len=Math.floor(blade.t/blade.tMax*blade.points.length),pt=blade.points[0];ctx.strokeStyle=style||"lime";while(i<len){ctx.beginPath();ctx.moveTo(pt.x,pt.y);pt=blade.points[i];per=i/len;ctx.lineWidth=Math.floor(blade.width.min+blade.width.max-blade.width.max*per);ctx.lineTo(pt.x,pt.y);ctx.stroke();i+=1}};return{background:function(ctx,canvas){ctx.fillStyle="black";ctx.fillRect(0,0,canvas.width,canvas.height)},blade:drawBlade,grass:function(ctx,grass){grass.blades.forEach(function(blade,i){var style="rgba("+blade.r+","+blade.g+","+blade.b+","+(.1+.9*(i/grass.blades.length))+")";drawBlade(ctx,blade,style)})},info:function(ctx,canvas,grass){ctx.fillStyle="grey";ctx.textBaseline="top";ctx.font="10px courier";ctx.textAlign="left";ctx.fillText("v"+grass.ver,10,canvas.height-15)}}}();var canvasObj=utils.createCanvas(),canvas=canvasObj.canvas,ctx=canvasObj.ctx;var g=Grass.create({maxBlades:200,canvas:canvas});var lt=new Date;var loop=function(){var now=new Date,t=now-lt;requestAnimationFrame(loop);draw.background(ctx,canvas);Grass.update(g,t);draw.grass(ctx,g);draw.info(ctx,canvas,g);lt=now};loop();
