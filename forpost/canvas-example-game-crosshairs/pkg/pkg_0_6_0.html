<html>
    <head>
        <title>canvas example game crosshairs</title>
    </head>
    <body>
<div id="canvas-app" style="width:320px;height:240px;margin-left:auto;margin-right:auto;"></div>
<script>var utils={};utils.distance=function(x1,y1,x2,y2){return Math.sqrt(Math.pow(x1-x2,2)+Math.pow(y1-y2,2));};utils.getCanvasRelative=function(e){var canvas=e.target,bx=canvas.getBoundingClientRect();return{x:(e.changedTouches?e.changedTouches[0].clientX:e.clientX)-bx.left,y:(e.changedTouches?e.changedTouches[0].clientY:e.clientY)-bx.top,bx:bx};};var crossMod=(function(){var isInInner=function(cross){var ch=cross.crosshairs,center=cross.center;return utils.distance(ch.x,ch.y,center.x,center.y)<cross.radiusInner;};var isInOuter=function(cross){var ch=cross.crosshairs,center=cross.center;return utils.distance(ch.x,ch.y,center.x,center.y)>=cross.radiusInner;};var isOutOfBounds=function(cross){var ch=cross.crosshairs,center=cross.center;return utils.distance(ch.x,ch.y,center.x,center.y)>=cross.radiusOuter;};var moveOffset=function(cross,secs){var ch=cross.crosshairs,center=cross.center,d1=utils.distance(ch.x,ch.y,center.x,center.y),diff=cross.radiusOuter-cross.radiusInner,d2=d1-cross.radiusInner,per=d2/diff;if(d1>cross.radiusInner){cross.offset.x+=Math.cos(ch.heading)*cross.offset.pps*per*secs;cross.offset.y+=Math.sin(ch.heading)*cross.offset.pps*per*secs;}};return{isInInner:isInInner,isInOuter:isInOuter,create:function(opt){opt=opt||{};return{userDown:false,pps:opt.pps||128,radiusInner:opt.radiusInner||(240/4),radiusOuter:opt.radiusOuter||(240/2.125),center:{x:opt.cx||(320/2),y:opt.cy||(240/2)},crosshairs:{x:320/2,y:240/2,heading:0,radius:16},offset:{x:opt.offsetX||0,y:opt.offsetY||0,pps:256}};},update:function(cross,secs){secs=secs||0;var ch=cross.crosshairs,center=cross.center;ch.heading=Math.atan2(center.y-ch.y,center.x-ch.x);if(isOutOfBounds(cross)){ch.x=center.x;ch.y=center.y;cross.userDown=false;}if(isInOuter(cross)){if(!cross.userDown){ch.x+=Math.cos(ch.heading)*cross.pps*secs;ch.y+=Math.sin(ch.heading)*cross.pps*secs;}moveOffset(cross,secs);}},createEvent:function(cross,eventType){return function(e){var pos=utils.getCanvasRelative(e),ch=cross.crosshairs;e.preventDefault();if(eventType==='start'){cross.userDown=true;ch.x=pos.x;ch.y=pos.y;}if(eventType==='end'){cross.userDown=false;}if(eventType==='move'){if(cross.userDown){ch.x=pos.x;ch.y=pos.y;}}};}}}());var mapMod=(function(){var cellTypes=[{i:0,type:'grass',HP:{min:50,max:75},autoHeal:{rate:0.1,amount:2}},{i:1,type:'tree',HP:{min:100,max:150},autoHeal:{rate:1,amount:5}},{i:2,type:'rock',HP:{min:200,max:250},autoHeal:{rate:3,amount:50}},];var setCellType=function(cell,typeIndex,opt){opt=opt||{};cell.type=cellTypes[typeIndex];cell.typeIndex=typeIndex;cell.maxHP=cell.type.HP.min+Math.round((cell.type.HP.max-cell.type.HP.min)*Math.random());cell.HP=opt.HP===undefined?cell.maxHP:opt.HP;cell.autoHeal.rate=cell.type.autoHeal.rate;cell.autoHeal.amount=cell.type.autoHeal.amount;};var getHighestDamageCell=function(map){return Math.max.apply(null,map.cells.map(function(cell){return cell.damage;}));};var get=function(map,x,y){if(x<0||y<0){return undefined;}if(x>=map.cellWidth||y>=map.cellHeight){return undefined;}return map.cells[y*map.cellWidth+x];};var autoHeal=function(cell,secs){cell.autoHeal.secs+=secs;if(cell.autoHeal.secs>=cell.autoHeal.rate){cell.autoHeal.secs%=cell.autoHeal.rate;cell.HP+=cell.autoHeal.amount;cell.HP=cell.HP>cell.maxHP?cell.maxHP:cell.HP;}};var getBorderCells=function(map,cell){var i=8,borderCell,cells=[],r,x,y;if(!cell){return[];}while(i--){r=Math.PI*2/8*i;x=Math.round(cell.x+Math.cos(r));y=Math.round(cell.y+Math.sin(r));borderCell=get(map,x,y);if(borderCell){cells.push(borderCell);}}return cells;};var getBorderCellsActiveCount=function(map,cell,active){active===undefined?true:active;var borderCells=getBorderCells(map,cell);return borderCells.reduce(function(acc,cell){acc=typeof acc==='object'?Number(acc.active===active):acc;return acc+=Number(cell.active==active);});};var getAllCellActiveState=function(map,active,condition){active=active===undefined?true:active;condition=condition===undefined?function(cell){return true;}:condition;return map.cells.filter(function(cell){if(cell.active===active&&condition(map,cell)){return true;}return false;});};var condition_gen_cell=function(map,cell){var borderCells=getBorderCells(map,cell);return getBorderCellsActiveCount(map,cell,true)>=1;};var getGenCells=function(map){return getAllCellActiveState(map,false,condition_gen_cell);};var popRandomCell=function(cells){var i=Math.floor(Math.random()*cells.length);return cells.splice(i,1)[0];};var gen=function(map,secs){var cells,cell,i;map.gen.secs+=secs;if(map.gen.secs>=map.gen.rate){map.gen.secs%=map.gen.rate;cells=getGenCells(map);i=map.gen.count;if(cells.length-i<0){i=cells.length;}if(i>0){while(i--){cell=popRandomCell(cells);cell.active=true;cell.HP=1;setCellType(cell,Math.round(cell.damagePer*(cellTypes.length-1)),{HP:1});}}else{cells=getAllCellActiveState(map,true);if(cells.length===0){cell=map.cells[map.gen.startCells[Math.floor(Math.random()*map.gen.startCells.length)]];cell.active=true;cell.HP=1;setCellType(cell,0,{HP:1});}}}};return{create:function(){var map={cellSize:32,cellWidth:32,cellHeight:16,cells:[],percentRemain:1,gen:{rate:1,secs:0,count:2,startCells:[0,31,480,511]},highDamageCell:0};var i=0,cell,x,y,len=map.cellWidth*map.cellHeight;while(i<len){cell={i:i,x:i%map.cellWidth,y:Math.floor(i/map.cellWidth),HP:50,maxHP:100,active:true,typeIndex:0,typeName:cellTypes[0].name,type:cellTypes[0],autoHeal:{rate:1,amount:5,secs:0},damage:0,damagePer:0};setCellType(cell,0);map.cells.push(cell);i+=1;}return map;},clampOffset:function(map,offset){offset.x=offset.x>0?0:offset.x;offset.y=offset.y>0?0:offset.y;offset.x=offset.x<map.cellWidth*map.cellSize* -1?map.cellWidth*map.cellSize* -1:offset.x;offset.y=offset.y<map.cellHeight*map.cellSize* -1?map.cellHeight*map.cellSize* -1:offset.y;},getAllFromPointAndRadius:function(map,x,y,r){var i=map.cells.length,d,cell,cells=[],dists=[];while(i--){cell=map.cells[i];d=utils.distance(cell.x,cell.y,x,y);if(d<=r){cells.push(cell);dists.push(d);}}return{cells:cells,dists:dists};},getWithCanvasPointAndOffset:function(map,canvasX,canvasY,offsetX,offsetY){var x=canvasX-160+Math.abs(offsetX),y=canvasY-120+Math.abs(offsetY);return get(map,Math.floor(x/map.cellSize),Math.floor(y/map.cellSize));},update:function(map,secs){var i=map.cells.length,cell;map.highDamageCell=getHighestDamageCell(map);while(i--){cell=map.cells[i];if(cell.HP<=0){cell.active=false;}if(cell.active){autoHeal(cell,secs);}if(cell.damage===0){damagePer=0;}else{cell.damagePer=cell.damage/map.highDamageCell;}}gen(map,secs);}}}());var poolMod=(function(){return{create:function(opt){opt=opt||{};opt.count=opt.count||10;var i=0,pool=[];while(i<opt.count){pool.push({active:false,x:0,y:0,radius:8,heading:0,pps:32,lifespan:opt.lifespan||3,data:{},spawn:opt.spawn||function(obj,state){obj.active=true;},purge:opt.purge||function(obj,state){},update:opt.update||function(obj,state,secs){obj.x+=obj.pps*secs;obj.lifespan-=secs;}});i+=1;}return pool;},spawn:function(pool,game,opt){var i=pool.length,obj;while(i--){obj=pool[i];if(!obj.active){obj.active=true;obj.spawn.call(obj,obj,game,opt);break;}}},update:function(pool,state,secs){var i=pool.length,obj;while(i--){obj=pool[i];if(obj.active){obj.update(obj,state,secs);obj.lifespan=obj.lifespan<0?0:obj.lifespan;if(obj.lifespan===0){obj.active=false;obj.purge.call(obj,obj,state);}}}}}}());var gameMod=(function(){var Weapons=[{name:'Blaster',pps:256,shotRate:0.125,blastRadius:1,maxDPS:10,accuracy:0.75,hitRadius:64,gunCount:1,},{name:'Assault Blaster',pps:512,shotRate:0.125,blastRadius:2,maxDPS:5,accuracy:0.5,hitRadius:64,gunCount:4},{name:'Cannon',pps:256,shotRate:0.5,blastRadius:3,maxDPS:150,accuracy:0.25,hitRadius:64,gunCount:2},{name:'Atom',pps:256,shotRate:3,blastRadius:10,maxDPS:250,accuracy:0.9,hitRadius:128,gunCount:1}];var shotOptions={count:20,spawn:function(shot,game,radian){var offset=game.cross.offset,w=Weapons[game.weaponIndex],ch=game.cross.crosshairs,r=Math.random()*(Math.PI*2),d=w.hitRadius*(1-w.accuracy)*Math.random(),x=ch.x+Math.cos(r)*d,y=ch.y+Math.sin(r)*d,d;shot.x=x+Math.cos(radian)*game.canvas.width;shot.y=y+Math.sin(radian)*game.canvas.width;shot.heading=Math.atan2(y-shot.y,x-shot.x);d=utils.distance(shot.x,shot.y,x,y);shot.pps=w.pps;shot.lifespan=d/shot.pps;shot.offset=offset;},purge:function(shot,game){poolMod.spawn(game.explosions,game,shot);},update:function(shot,game,secs){shot.x+=Math.cos(shot.heading)*shot.pps*secs;shot.y+=Math.sin(shot.heading)*shot.pps*secs;shot.lifespan-=secs;}};var userPointerStart=function(game){return function(e){var pos=utils.getCanvasRelative(e);e.preventDefault();game.userDown=true;var b=gameMod.buttons.changeWeapon,d=utils.distance(pos.x,pos.y,b.x,b.y);if(d<b.r){game.weaponIndex+=1;game.weaponIndex%=Weapons.length;}};};var userPointerEnd=function(game){return function(e){e.preventDefault();game.userDown=false;};};var explosionOptions={count:20,spawn:function(ex,game,shot){var w=Weapons[game.weaponIndex];ex.x=shot.x;ex.y=shot.y;ex.data.offset={x:shot.offset.x,y:shot.offset.y};ex.data.radiusEnd=game.map.cellSize*w.blastRadius;ex.data.explosionTime=0.6;ex.data.maxDPS=w.maxDPS;;ex.lifespan=ex.data.explosionTime;ex.per=0;},purge:function(ex,game){},update:function(ex,game,secs){ex.per=(ex.data.explosionTime-ex.lifespan)/ex.data.explosionTime;ex.radius=ex.data.radiusEnd*ex.per;var cell=mapMod.getWithCanvasPointAndOffset(game.map,ex.x,ex.y,ex.data.offset.x,ex.data.offset.y),blastRadius=Math.ceil((ex.radius+0.01)/game.map.cellSize);if(cell){var targets=mapMod.getAllFromPointAndRadius(game.map,cell.x,cell.y,blastRadius);targets.cells.forEach(function(cell,i){var damage=ex.data.maxDPS*(1-(targets.dists[i]/blastRadius))*secs;if(cell.active){game.totalDamage+=damage;cell.HP-=damage;cell.HP=cell.HP<0?0:cell.HP;}cell.damage+=damage;});game.map.percentRemain=0;game.map.cells.forEach(function(cell){game.map.percentRemain+=cell.HP/cell.maxHP;});game.map.percentRemain/=game.map.cells.length;}ex.lifespan-=secs;}};return{Weapons:Weapons,buttons:{changeWeapon:{x:280,y:32,r:16}},create:function(opt){opt=opt||{};var game={ver:'0.6.0',canvas:canvas,map:mapMod.create(),cross:{},shots:poolMod.create(shotOptions),explosions:poolMod.create(explosionOptions),shotRate:1,shotSecs:0,weaponIndex:0,totalDamage:0,userDown:false};game.cross=crossMod.create({offsetX:game.map.cellWidth*game.map.cellSize/2* -1,offsetY:game.map.cellHeight*game.map.cellSize/2* -1,});game.canvas.addEventListener('mousedown',crossMod.createEvent(game.cross,'start'));game.canvas.addEventListener('mouseup',crossMod.createEvent(game.cross,'end'));game.canvas.addEventListener('mousemove',crossMod.createEvent(game.cross,'move'));game.canvas.addEventListener('touchstart',crossMod.createEvent(game.cross,'start'));game.canvas.addEventListener('touchend',crossMod.createEvent(game.cross,'end'));game.canvas.addEventListener('touchmove',crossMod.createEvent(game.cross,'move'));game.canvas.addEventListener('mousedown',userPointerStart(game));game.canvas.addEventListener('mouseup',userPointerEnd(game));game.canvas.addEventListener('touchstart',userPointerStart(game));game.canvas.addEventListener('touchend',userPointerEnd(game));return game;},update:function(game,secs){var w=Weapons[game.weaponIndex];game.shotRate=Weapons[game.weaponIndex].shotRate;crossMod.update(game.cross,secs);mapMod.clampOffset(game.map,game.cross.offset);mapMod.update(game.map,secs);poolMod.update(game.shots,game,secs);poolMod.update(game.explosions,game,secs);game.shotSecs+=secs;game.shotSecs=game.shotSecs>=game.shotRate?game.shotRate:game.shotSecs;if(game.shotSecs>=game.shotRate&&game.userDown&&crossMod.isInInner(game.cross)&&game.cross.userDown){var i=0,radian;while(i<w.gunCount){radian=Math.PI*2/4*i+Math.PI/4;poolMod.spawn(game.shots,game,radian);i+=1;}game.shotSecs=0;}}}}());var draw=(function(){var drawCrossCircles=function(ctx,cross){ctx.strokeStyle='white';ctx.lineWidth=3;ctx.beginPath();ctx.arc(cross.center.x,cross.center.y,cross.radiusInner,0,Math.PI*2);ctx.stroke();ctx.beginPath();ctx.arc(cross.center.x,cross.center.y,cross.radiusOuter,0,Math.PI*2);ctx.stroke();ctx.beginPath();ctx.arc(cross.crosshairs.x,cross.crosshairs.y,cross.crosshairs.radius,0,Math.PI*2);ctx.stroke();};var drawCellHealthBar=function(ctx,map,cell,cross){var x=cell.x*map.cellSize+cross.offset.x+(320/2),y=cell.y*map.cellSize+cross.offset.y+(240/2);ctx.fillStyle='rgba(0,255,0,0.5)';ctx.fillRect(x,y,map.cellSize*(cell.HP/cell.maxHP),5);};var cellTypeColors=['green','blue','red'];return{back:function(ctx,canvas){ctx.fillStyle='black';ctx.fillRect(0,0,canvas.width,canvas.height);},cross:function(ctx,cross){var ch=cross.crosshairs;drawCrossCircles(ctx,cross);ctx.strokeStyle='rgba(200,0,0,0.5)';ctx.beginPath();ctx.moveTo(ch.x,ch.y-ch.radius*1.5);ctx.lineTo(ch.x,ch.y+ch.radius*1.5);ctx.stroke();ctx.beginPath();ctx.moveTo(ch.x-ch.radius*1.5,ch.y);ctx.lineTo(ch.x+ch.radius*1.5,ch.y);ctx.stroke();},map:function(ctx,map,cross){ctx.strokeStyle='grey';ctx.lineWidth=3;map.cells.forEach(function(cell){var x=cell.x*map.cellSize+cross.offset.x+(320/2),y=cell.y*map.cellSize+cross.offset.y+(240/2),per=cell.HP/cell.maxHP;ctx.beginPath();ctx.rect(x,y,map.cellSize,map.cellSize);ctx.stroke();ctx.fillStyle=cellTypeColors[cell.typeIndex];if(!cell.active){ctx.fillStyle='#606060';}ctx.fill();ctx.closePath();drawCellHealthBar(ctx,map,cell,cross);ctx.fillStyle='white';ctx.font='10px courier';ctx.fillText(Math.floor(cell.damagePer*100),x,y)});},shots:function(ctx,game){var shots=game.shots,i=shots.length,shot;while(i--){shot=shots[i];ctx.fillStyle='white';ctx.strokeStyle='black';if(shot.active){ctx.beginPath();ctx.arc(shot.x,shot.y,shot.radius,0,Math.PI*2);ctx.fill();ctx.stroke();}}},explosions:function(ctx,game){var exps=game.explosions,i=exps.length,alpha=0.5,ex;while(i--){ex=exps[i];alpha=1-ex.per;ctx.fillStyle='rgba(255,255,0,'+alpha+')';ctx.strokeStyle='rgba(0,0,0,'+alpha+')';if(ex.active){ctx.beginPath();ctx.arc(ex.x,ex.y,ex.radius,0,Math.PI*2);ctx.fill();ctx.stroke();}}},buttons:function(ctx){ctx.fillStyle='red';ctx.strokeStyle='white';Object.keys(gameMod.buttons).forEach(function(key){var b=gameMod.buttons[key];ctx.beginPath();ctx.arc(b.x,b.y,b.r,0,Math.PI*2);ctx.fill();ctx.stroke();});},info:function(ctx,game){ctx.fillStyle='rgba(0,0,0,0.4)';ctx.fillRect(0,0,game.canvas.width,game.canvas.height);ctx.fillStyle='yellow';ctx.textBaseline='top';ctx.font='10px courier';ctx.fillText('v'+game.ver,10,10);ctx.fillText('pos: '+game.cross.offset.x.toFixed(2)+','+game.cross.offset.y.toFixed(2),10,20);ctx.fillText('percent remain: '+game.map.percentRemain,10,30);ctx.fillText('weapon: '+gameMod.Weapons[game.weaponIndex].name,10,40);ctx.fillText('damage: '+Math.floor(game.totalDamage),10,50);ctx.fillText('high damage cell: '+Math.floor(game.map.highDamageCell),10,60);}}}());var canvas=document.createElement('canvas'),ctx=canvas.getContext('2d'),container=document.getElementById('canvas-app')||document.body;container.appendChild(canvas);canvas.width=320;canvas.height=240;ctx.translate(0.5,0.5);var game=gameMod.create({canvas:canvas});var lt=new Date();var loop=function(){var now=new Date(),t=now-lt,secs=t/1000;requestAnimationFrame(loop);gameMod.update(game,secs);draw.back(ctx,canvas);draw.map(ctx,game.map,game.cross);draw.explosions(ctx,game);draw.cross(ctx,game.cross);draw.shots(ctx,game);draw.buttons(ctx);draw.info(ctx,game);lt=now;};loop();</script>
    </body>
</html>