<html>
    <head>
        <title>canvas example game crosshairs</title>
    </head>
    <body>
<div id="canvas-app" style="width:320px;height:240px;margin-left:auto;margin-right:auto;"></div>
<script>
var utils={};utils.distance=function(x1,y1,x2,y2){return Math.sqrt(Math.pow(x1-x2,2)+Math.pow(y1-y2,2));};utils.getCanvasRelative=function(e){var canvas=e.target,bx=canvas.getBoundingClientRect();return{x:(e.changedTouches?e.changedTouches[0].clientX:e.clientX)-bx.left,y:(e.changedTouches?e.changedTouches[0].clientY:e.clientY)-bx.top,bx:bx};};var crossMod=(function(){var isInInner=function(cross){var ch=cross.crosshairs,center=cross.center;return utils.distance(ch.x,ch.y,center.x,center.y)<cross.radiusInner;};var isInOuter=function(cross){var ch=cross.crosshairs,center=cross.center;return utils.distance(ch.x,ch.y,center.x,center.y)>=cross.radiusInner;};var isOutOfBounds=function(cross){var ch=cross.crosshairs,center=cross.center;return utils.distance(ch.x,ch.y,center.x,center.y)>=cross.radiusOuter;};var moveOffset=function(cross,secs){var ch=cross.crosshairs,center=cross.center,d1=utils.distance(ch.x,ch.y,center.x,center.y),diff=cross.radiusOuter-cross.radiusInner,d2=d1-cross.radiusInner,per=d2/diff;if(d1>cross.radiusInner){cross.offset.x+=Math.cos(ch.heading)*cross.offset.pps*per*secs;cross.offset.y+=Math.sin(ch.heading)*cross.offset.pps*per*secs;}};return{isInInner:isInInner,isInOuter:isInOuter,create:function(opt){opt=opt||{};return{userDown:false,pps:opt.pps||128,radiusInner:opt.radiusInner||(240/4),radiusOuter:opt.radiusOuter||(240/2.125),center:{x:opt.cx||(320/2),y:opt.cy||(240/2)},crosshairs:{x:320/2,y:240/2,heading:0,radius:16},offset:{x:opt.offsetX||0,y:opt.offsetY||0,pps:256}};},update:function(cross,secs){secs=secs||0;var ch=cross.crosshairs,center=cross.center;ch.heading=Math.atan2(center.y-ch.y,center.x-ch.x);if(isInOuter(cross)){if(!cross.userDown){ch.x+=Math.cos(ch.heading)*cross.pps*secs;ch.y+=Math.sin(ch.heading)*cross.pps*secs;}moveOffset(cross,secs);}if(isOutOfBounds(cross)){ch.x=center.x+Math.cos(ch.heading+Math.PI)*cross.radiusOuter;ch.y=center.y+Math.sin(ch.heading+Math.PI)*cross.radiusOuter;}},createEvent:function(cross,eventType){return function(e){e.preventDefault();var pos=utils.getCanvasRelative(e);if(eventType==='start'){cross.userDown=true;cross.crosshairs.x=pos.x;cross.crosshairs.y=pos.y;}if(eventType==='end'){cross.userDown=false;}if(eventType==='move'&&cross.userDown){cross.crosshairs.x=pos.x;cross.crosshairs.y=pos.y;}};}}}());var mapMod=(function(){var get=function(map,x,y){return map.cells[y*map.cellWidth+x];};return{create:function(){var map={cellSize:32,cellWidth:32,cellHeight:16,cells:[],percentRemain:1};var i=0,x,y,len=map.cellWidth*map.cellHeight;while(i<len){map.cells.push({i:i,x:i%map.cellWidth,y:Math.floor(i/map.cellWidth),HP:100,maxHP:100});i+=1;}return map;},clampOffset:function(map,offset){offset.x=offset.x>0?0:offset.x;offset.y=offset.y>0?0:offset.y;offset.x=offset.x<map.cellWidth*map.cellSize* -1?map.cellWidth*map.cellSize* -1:offset.x;offset.y=offset.y<map.cellHeight*map.cellSize* -1?map.cellHeight*map.cellSize* -1:offset.y;},getAllFromPointAndRadius:function(map,x,y,r){var i=map.cells.length,d,cell,cells=[],dists=[];while(i--){cell=map.cells[i];d=utils.distance(cell.x,cell.y,x,y);if(d<=r){cells.push(cell);dists.push(d);}}return{cells:cells,dists:dists};},getWithCanvasPointAndOffset:function(map,canvasX,canvasY,offsetX,offsetY){var x=canvasX-160+Math.abs(offsetX),y=canvasY-120+Math.abs(offsetY);return get(map,Math.floor(x/map.cellSize),Math.floor(y/map.cellSize));}}}());var poolMod=(function(){return{create:function(opt){opt=opt||{};opt.count=opt.count||10;var i=0,pool=[];while(i<opt.count){pool.push({active:false,x:0,y:0,radius:8,heading:0,pps:32,lifespan:opt.lifespan||3,data:{},spawn:opt.spawn||function(obj,state){obj.active=true;},purge:opt.purge||function(obj,state){},update:opt.update||function(obj,state,secs){obj.x+=obj.pps*secs;obj.lifespan-=secs;}});i+=1;}return pool;},spawn:function(pool,game,opt){var i=pool.length,obj;while(i--){obj=pool[i];if(!obj.active){obj.active=true;obj.spawn.call(obj,obj,game,opt);break;}}},update:function(pool,state,secs){var i=pool.length,obj;while(i--){obj=pool[i];if(obj.active){obj.update(obj,state,secs);obj.lifespan=obj.lifespan<0?0:obj.lifespan;if(obj.lifespan===0){obj.active=false;obj.purge.call(obj,obj,state);}}}}}}());var gameMod=(function(){var shotOptions={count:20,spawn:function(shot,game,opt){var offset=game.cross.offset,ch=game.cross.crosshairs,d;shot.x=game.canvas.width;shot.y=game.canvas.height;shot.heading=Math.atan2(ch.y-shot.y,ch.x-shot.x);d=utils.distance(shot.x,shot.y,ch.x,ch.y);shot.pps=256;shot.lifespan=d/shot.pps;shot.offset=offset;},purge:function(shot,game){poolMod.spawn(game.explosions,game,shot);},update:function(shot,game,secs){shot.x+=Math.cos(shot.heading)*shot.pps*secs;shot.y+=Math.sin(shot.heading)*shot.pps*secs;shot.lifespan-=secs;}};var explosionOptions={count:20,spawn:function(ex,game,shot){ex.x=shot.x;ex.y=shot.y;ex.data.offset={x:shot.offset.x,y:shot.offset.y};ex.data.radiusEnd=game.map.cellSize*4;ex.data.explosionTime=0.6;ex.data.maxDPS=50;ex.lifespan=ex.data.explosionTime;},purge:function(ex,game){},update:function(ex,game,secs){ex.radius=ex.data.radiusEnd*(ex.data.explosionTime-ex.lifespan)/ex.data.explosionTime;var cell=mapMod.getWithCanvasPointAndOffset(game.map,ex.x,ex.y,ex.data.offset.x,ex.data.offset.y),blastRadius=Math.ceil((ex.radius+0.01)/game.map.cellSize);if(cell){var targets=mapMod.getAllFromPointAndRadius(game.map,cell.x,cell.y,blastRadius);targets.cells.forEach(function(cell,i){cell.HP-=ex.data.maxDPS*(1-(targets.dists[i]/blastRadius))*secs;cell.HP=cell.HP<0?0:cell.HP;});game.map.percentRemain=0;game.map.cells.forEach(function(cell){game.map.percentRemain+=cell.HP/cell.maxHP;});game.map.percentRemain/=game.map.cells.length;}ex.lifespan-=secs;}};return{create:function(opt){opt=opt||{};var game={ver:'0.3.0',canvas:canvas,map:mapMod.create(),cross:{},shots:poolMod.create(shotOptions),explosions:poolMod.create(explosionOptions),shotRate:1,shotSecs:0,userDown:false};game.cross=crossMod.create({offsetX:game.map.cellWidth*game.map.cellSize/2* -1,offsetY:game.map.cellHeight*game.map.cellSize/2* -1,});game.canvas.addEventListener('mousedown',crossMod.createEvent(game.cross,'start'));game.canvas.addEventListener('mouseup',crossMod.createEvent(game.cross,'end'));game.canvas.addEventListener('mousemove',crossMod.createEvent(game.cross,'move'));game.canvas.addEventListener('touchstart',crossMod.createEvent(game.cross,'start'));game.canvas.addEventListener('touchend',crossMod.createEvent(game.cross,'end'));game.canvas.addEventListener('touchmove',crossMod.createEvent(game.cross,'move'));game.canvas.addEventListener('mousedown',function(e){e.preventDefault();game.userDown=true;});game.canvas.addEventListener('mouseup',function(e){e.preventDefault();game.userDown=false;});game.canvas.addEventListener('touchstart',function(e){e.preventDefault();game.userDown=true;});game.canvas.addEventListener('touchend',function(e){e.preventDefault();game.userDown=false;});return game;},update:function(game,secs){crossMod.update(game.cross,secs);mapMod.clampOffset(game.map,game.cross.offset);poolMod.update(game.shots,game,secs);poolMod.update(game.explosions,game,secs);game.shotSecs+=secs;game.shotSecs=game.shotSecs>=game.shotRate?game.shotRate:game.shotSecs;if(game.shotSecs>=game.shotRate&&game.userDown&&crossMod.isInInner(game.cross)){poolMod.spawn(game.shots,game);game.shotSecs=0;}}}}());var draw=(function(){var drawCrossCircles=function(ctx,cross){ctx.strokeStyle='white';ctx.lineWidth=3;ctx.beginPath();ctx.arc(cross.center.x,cross.center.y,cross.radiusInner,0,Math.PI*2);ctx.stroke();ctx.beginPath();ctx.arc(cross.center.x,cross.center.y,cross.radiusOuter,0,Math.PI*2);ctx.stroke();ctx.beginPath();ctx.arc(cross.crosshairs.x,cross.crosshairs.y,cross.crosshairs.radius,0,Math.PI*2);ctx.stroke();};return{back:function(ctx,canvas){ctx.fillStyle='black';ctx.fillRect(0,0,canvas.width,canvas.height);},cross:function(ctx,cross){var ch=cross.crosshairs;drawCrossCircles(ctx,cross);ctx.strokeStyle='rgba(200,0,0,0.5)';ctx.beginPath();ctx.moveTo(ch.x,ch.y-ch.radius*1.5);ctx.lineTo(ch.x,ch.y+ch.radius*1.5);ctx.stroke();ctx.beginPath();ctx.moveTo(ch.x-ch.radius*1.5,ch.y);ctx.lineTo(ch.x+ch.radius*1.5,ch.y);ctx.stroke();},map:function(ctx,map,cross){ctx.strokeStyle='grey';ctx.lineWidth=3;map.cells.forEach(function(cell){var x=cell.x*map.cellSize+cross.offset.x+(320/2),y=cell.y*map.cellSize+cross.offset.y+(240/2),per=cell.HP/cell.maxHP;ctx.beginPath();ctx.rect(x,y,map.cellSize,map.cellSize);ctx.stroke();ctx.fillStyle='rgba(0,200,0,'+per.toFixed(2)+')';ctx.fill();ctx.closePath();});},shots:function(ctx,game){var shots=game.shots,i=shots.length,shot;while(i--){shot=shots[i];ctx.fillStyle='white';ctx.strokeStyle='black';if(shot.active){ctx.beginPath();ctx.arc(shot.x,shot.y,shot.radius,0,Math.PI*2);ctx.fill();ctx.stroke();}}},explosions:function(ctx,game){var exps=game.explosions,i=exps.length,ex;while(i--){ex=exps[i];ctx.fillStyle='yellow';ctx.strokeStyle='black';if(ex.active){ctx.beginPath();ctx.arc(ex.x,ex.y,ex.radius,0,Math.PI*2);ctx.fill();ctx.stroke();}}},info:function(ctx,game){ctx.fillStyle='rgba(0,0,0,0.4)';ctx.fillRect(0,0,game.canvas.width,game.canvas.height);ctx.fillStyle='yellow';ctx.textBaseline='top';ctx.font='10px courier';ctx.fillText('v'+game.ver,10,10);ctx.fillText('pos: '+game.cross.offset.x.toFixed(2)+','+game.cross.offset.y.toFixed(2),10,20);ctx.fillText('percent remain: '+game.map.percentRemain,10,30);}}}());var canvas=document.createElement('canvas'),ctx=canvas.getContext('2d'),container=document.getElementById('canvas-app')||document.body;container.appendChild(canvas);canvas.width=320;canvas.height=240;ctx.translate(0.5,0.5);var game=gameMod.create({canvas:canvas});var lt=new Date();var loop=function(){var now=new Date(),t=now-lt,secs=t/1000;requestAnimationFrame(loop);gameMod.update(game,secs);draw.back(ctx,canvas);draw.map(ctx,game.map,game.cross);draw.explosions(ctx,game);draw.cross(ctx,game.cross);draw.shots(ctx,game);draw.info(ctx,game);lt=now;};loop();</script>
    </body>
</html>