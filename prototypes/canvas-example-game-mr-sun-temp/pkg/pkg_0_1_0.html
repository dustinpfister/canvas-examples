<html>
<head>
<title>Canvas Example Mr Sun</title>
</head>
<body>
<div id="canvas-app" style="width:320px;height:240px;margin-left:auto;margin-right:auto;"></div>
<script>var utils={};utils.getCanvasRelative=function(e){var canvas=e.target,bx=canvas.getBoundingClientRect();return{x:(e.changedTouches?e.changedTouches[0].clientX:e.clientX)-bx.left,y:(e.changedTouches?e.changedTouches[0].clientY:e.clientY)-bx.top,bx:bx}};utils.distance=function(x1,y1,x2,y2){return Math.sqrt(Math.pow(x1-x2,2)+Math.pow(y1-y2,2))};var gameMod=function(){var plugs={};var getCallPrioritySorted=function(){var keys=Object.keys(plugs);return keys.sort(function(a,b){var plugObjA=plugs[a],plugObjB=plugs[b];if(plugObjA.callPriority>plugObjB.callPriority){return-1}if(plugObjA.callPriority<plugObjB.callPriority){return 1}return 0})};var usePlugs=function(game,methodName,args){methodName=methodName||"create";args=args||[game];var keys=getCallPrioritySorted();keys.forEach(function(plugKey){var plugObj=plugs[plugKey],method=plugObj[methodName];if(method){method.apply(plugObj,args)}})};var api={};api.create=function(opt){opt=opt||{};opt.canvas=opt.canvas||{width:320,height:240};var game={};game.centerX=opt.centerX||opt.canvas.width/2;game.centerY=opt.centerY||opt.canvas.height/2;game.sectionRadius=opt.sectionRadius||16;game.worldRadius=opt.worldRadius||100;game.secs=0;game.year=0;game.yearRate=opt.yearRate||1;game.sun={radius:16,x:game.centerX,y:game.centerY};var i=0,sections=[],total=opt.sectionCount||20,radian,cx=game.centerX,cy=game.centerY;while(i<total){radian=Math.PI*2/total*i;sections.push({i:i,x:Math.cos(radian)*game.worldRadius+cx,y:Math.sin(radian)*game.worldRadius+cy,radius:game.sectionRadius,per:1});i+=1}game.sections=sections;usePlugs(game,"create",[game,opt]);gameMod.updateSections(game);return game};api.updateSections=function(game){var sun=game.sun;game.sections.forEach(function(section){var ajust=section.radius+sun.radius;var d=utils.distance(section.x,section.y,sun.x,sun.y)-ajust;var per=d/(game.worldRadius*2-ajust*2);per=per>1?1:per;per=per<0?0:per;per=1-per;section.per=per})};api.getSectionByPos=function(game,x,y){var section,i=game.sections.length;while(i--){section=game.sections[i];if(utils.distance(section.x,section.y,x,y)<=section.radius){return section}}return false};var boundToCircle=function(obj,cx,cy,radius){if(utils.distance(obj.x,obj.y,cx,cy)>radius){var a=Math.atan2(obj.y-cy,obj.x-cx);obj.x=cx+Math.cos(a)*radius;obj.y=cy+Math.sin(a)*radius}};api.moveSun=function(game,pos){var ajust=game.sun.radius+game.sectionRadius;game.sun.x=pos.x;game.sun.y=pos.y;boundToCircle(game.sun,game.centerX,game.centerY,game.worldRadius-ajust);api.updateSections(sm.game)};api.update=function(game,secs){game.secs+=secs;var deltaYears=Math.floor(game.secs/game.yearRate);if(deltaYears>=1){game.year+=deltaYears;game.secs%=game.yearRate;usePlugs(game,"onDeltaYear",[game,deltaYears])}};api.load=function(plugObj){var len=Object.keys(plugs).length;plugObj.name=plugObj.name||len;plugObj.callPriority=plugObj.callPriority||len;plugs[plugObj.name]=plugObj};return api}();var draw=function(){var api={};api.back=function(sm){sm.ctx.fillStyle="#202020";sm.ctx.fillRect(0,0,sm.canvas.width,sm.canvas.height)};api.sectionData=function(sm,section){ctx.fillStyle="white";ctx.textAlign="left";ctx.textBaseline="top";ctx.font="15px arial";ctx.fillText("section "+section.i,10,10);ctx.font="10px arial";ctx.fillText("groundTemp: "+section.groundTemp.toFixed(2),10,30);ctx.fillText("temp: "+section.temp.toFixed(2),10,40);Object.keys(section.minerals).forEach(function(min,i){ctx.fillText(min+": "+section.minerals[min].toFixed(2),10,50+i*10)})};api.sections=function(sm){var ctx=sm.ctx;sm.game.sections.forEach(function(section){var b=50+Math.round(section.per*128);ctx.fillStyle="rgb(0,0,"+b+")";ctx.beginPath();ctx.arc(section.x,section.y,section.radius,0,Math.PI*2);ctx.fill();ctx.fillStyle="white";ctx.textAlign="center";ctx.textBaseline="middle";ctx.font="8px arial";ctx.fillText(section.per.toFixed(2),section.x,section.y-5)})};api.sun=function(sm){var sun=sm.game.sun,ctx=sm.ctx;ctx.fillStyle="yellow";ctx.beginPath();ctx.arc(sun.x,sun.y,sun.radius,0,Math.PI*2);ctx.fill();ctx.fillStyle="black";ctx.font="10px arial";ctx.fillText(Math.round(sun.temp),sun.x,sun.y)};api.disp=function(sm){var ctx=sm.ctx;ctx.fillStyle="white";ctx.textAlign="left";ctx.textBaseline="top";ctx.font="10px courier";ctx.fillText("year: "+sm.game.year,3,3)};api.ver=function(sm){var ctx=sm.ctx;ctx.fillStyle="white";ctx.textAlign="left";ctx.textBaseline="top";ctx.font="10px courier";ctx.fillText("v"+sm.ver,10,sm.canvas.height-15)};return api}();gameMod.load({name:"temp",callPriority:"1.0",create:function(game,opt){console.log(this.name);game.maxTemp=2e3;game.sun.temp=0;game.sections=game.sections.map(function(section){section.temp=0;section.groundTemp=0;return section})},onDeltaYear:function(game,deltaYears){game.sun.temp=50+(game.maxTemp-50)*game.year/1e5;game.sun.temp=game.sun.temp>game.maxTemp?game.maxTemp:game.sun.temp;var i=game.sections.length,section;while(i--){section=game.sections[i];if(Math.floor(section.per*100)>=50){section.groundTemp+=game.sun.temp/10*section.per}else{section.groundTemp-=section.groundTemp/100}section.groundTemp=section.groundTemp<.25?0:section.groundTemp;section.groundTemp=section.groundTemp>game.maxTemp/2?game.maxTemp/2:section.groundTemp;section.temp=section.groundTemp+game.sun.temp/2*section.per}}});gameMod.load(function(){var getMinDelta=function(section,rate,temp,deltaYears){return rate*Math.floor(section.temp/temp)*deltaYears};return{name:"fusion",callPriority:"1.1",create:function(game,opt){game.sections=game.sections.map(function(section){section.minerals={copper:0,silver:0};return section})},onDeltaYear:function(game,deltaYears){var i=game.sections.length,section;while(i--){section=game.sections[i];if(section.temp>100){section.minerals.copper+=getMinDelta(section,5,100,deltaYears)}if(section.temp>500){section.minerals.silver+=getMinDelta(section,1,500,deltaYears)}}}}}());var canvas=document.createElement("canvas"),ctx=canvas.getContext("2d"),container=document.getElementById("canvas-app")||document.body;container.appendChild(canvas);canvas.width=320;canvas.height=240;ctx.translate(.5,.5);var changeState=function(sm,stateKey,opt){opt=opt||{};var newState=sm.states[stateKey];if(newState.start){newState.start(sm,opt)}sm.currentState=stateKey};var states={game:{init:function(sm){sm.game=gameMod.create({canvas:sm.canvas,sectionCount:19,worldRadius:100,yearRate:.5})},update:function(sm,secs){gameMod.update(sm.game,secs);draw.back(sm);draw.sections(sm);draw.sun(sm);draw.disp(sm);draw.ver(sm)},pointerStart:function(sm,pos,e){},pointerMove:function(sm,pos,e){var sun=sm.game.sun;if(sm.input.pointerDown){gameMod.moveSun(sm.game,pos)}},pointerEnd:function(sm,pos){console.log("pointer down");var section=gameMod.getSectionByPos(sm.game,pos.x,pos.y);if(section){changeState(sm,"observe_section",{section:section})}}},observe_section:{data:{section:{}},start:function(sm,opt){console.log("observe_section state start: ");console.log(opt.section);sm.states["observe_section"].section=opt.section},update:function(sm,secs){gameMod.update(sm.game,secs);draw.back(sm);draw.sectionData(sm,sm.states["observe_section"].section)},pointerEnd:function(sm){console.log("back to game");changeState(sm,"game",{})}}};var sm={ver:"0.1.0",canvas:canvas,currentState:"game",ctx:ctx,game:{},states:states,input:{pointerDown:false,pos:{x:0,y:0}}};var pointerHanders={start:function(sm,pos,e){var pos=sm.input.pos;sm.input.pointerDown=true;var method=states[sm.currentState].pointerStart;if(method){method(sm,pos,e)}},move:function(sm,pos,e){var method=states[sm.currentState].pointerMove;if(method){method(sm,pos,e)}},end:function(sm,pos,e){sm.input.pointerDown=false;var method=states[sm.currentState].pointerEnd;if(method){method(sm,pos,e)}}};var createPointerHandler=function(sm,type){return function(e){var pos=utils.getCanvasRelative(e);sm.input.pos=pos;e.preventDefault();pointerHanders[type](sm,pos,e)}};canvas.addEventListener("mousedown",createPointerHandler(sm,"start"));canvas.addEventListener("mousemove",createPointerHandler(sm,"move"));canvas.addEventListener("mouseup",createPointerHandler(sm,"end"));canvas.addEventListener("touchstart",createPointerHandler(sm,"start"));canvas.addEventListener("touchmove",createPointerHandler(sm,"move"));canvas.addEventListener("touchend",createPointerHandler(sm,"end"));states[sm.currentState].init(sm);var lt=new Date,FPS_target=30;var loop=function(){var now=new Date,t=now-lt,secs=t/1e3;requestAnimationFrame(loop);if(t>=1e3/FPS_target){states[sm.currentState].update(sm,secs);lt=now}};loop();</script>
</body>
</html>
