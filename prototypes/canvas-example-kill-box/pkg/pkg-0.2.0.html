<html><head><title>canvas example kill box</title></head><body><div id="canvas-app"style="width:320px;height:240px;margin-left:auto;margin-right:auto;"></div><script>var utils={};utils.boundingBox=function(a,b){return!((a.y+a.h)<b.y||a.y>(b.y+b.h)||(a.x+a.w)<b.x||a.x>(b.x+b.w));};utils.getCanvasRelative=function(e){var canvas=e.target,bx=canvas.getBoundingClientRect();return{x:(e.changedTouches?e.changedTouches[0].clientX:e.clientX)-bx.left,y:(e.changedTouches?e.changedTouches[0].clientY:e.clientY)-bx.top,bx:bx};};var poolMod=(function(){return{create:function(opt){opt=opt||{};opt.count=opt.count||10;var i=0,pool=[];while(i<opt.count){pool.push({active:false,x:opt.x===undefined?0:opt.x,y:opt.y===undefined?0:opt.y,w:opt.w===undefined?32:opt.w,h:opt.h===undefined?32:opt.h,heading:opt.heading===undefined?0:opt.heading,pps:32,lifespan:opt.lifespan||3,data:{},spawn:opt.spawn||function(obj,state){},purge:opt.purge||function(obj,state){},update:opt.update||function(obj,state,secs){obj.lifespan-=secs;}});i+=1;} return pool;},spawn:function(pool,state,opt){var i=pool.length,obj;while(i--){obj=pool[i];if(!obj.active){obj.active=true;obj.spawn.call(obj,obj,state,opt);return obj;}} return false;},update:function(pool,secs,state){var i=pool.length,obj;state=state||{};while(i--){obj=pool[i];if(obj.active){obj.update(obj,state,secs);obj.lifespan=obj.lifespan<0?0:obj.lifespan;if(obj.lifespan===0){obj.active=false;obj.purge.call(obj,obj,state);}}}},setActiveStateForAll:function(pool,bool){bool=bool===undefined?false:bool;var i=pool.length,obj;while(i--){obj=pool[i];obj.active=bool;}}}} ());var mapMod=(function(){var createCells=function(map){var cells=[];var len=map.w*map.h,i=0;while(i<len){cells.push({i:i,x:i%map.w,y:Math.floor(i/map.w),unit:false});i+=1;} return cells;};var api={};api.get=function(map,x,y){if(x<0||y<0||x>=map.w||y>=map.h){return false;} return map.cells[y*map.w+x];};api.getCellByPointer=function(map,x,y){var cx=Math.floor((x-map.margin.x)/map.cellSize),cy=Math.floor((y-map.margin.y)/map.cellSize);return api.get(map,cx,cy)};api.create=function(opt){opt=opt||{};var map={w:opt.w||9,h:opt.h||7,cellSize:32,spawnEnabled:opt.spawnEnabled||false,spawnLimit:opt.spawnLimit||2,spawnCells:opt.spawnCells||[0],margin:opt.margin||{x:5,y:5},cells:[]};map.cells=createCells(map);return map;};return api;} ());var gameMod=(function(){var placeUnitInMap=function(game,unit,pos){var map=game.map,cell=mapMod.get(map,pos.x,pos.y);unit.x=map.margin.x+map.cellSize*cell.x;unit.y=map.margin.y+map.cellSize*cell.y;};var enemyPoolOptions={count:5,spawn:function(enemy,game,spawnOptions){placeUnitInMap(game,enemy,spawnOptions.cellPos);}};var playerPoolOptions={count:5,spawn:function(playerUnit,game,spawnOptions){placeUnitInMap(game,playerUnit,spawnOptions.cellPos);}};var shotPoolOptions={count:10,w:5,h:5,spawn:function(shot,game,spawnOptions){placeUnitInMap(game,shot,spawnOptions.cellPos);}};return{create:function(opt){var game={enemies:[],playerUnits:[],shots:[],map:mapMod.create({margin:{x:10,y:10}})};game.enemies=poolMod.create(enemyPoolOptions);game.playerUnits=poolMod.create(playerPoolOptions);game.shots=poolMod.create(shotPoolOptions);console.log(game);var spawnOptions={cellPos:{x:3,y:0}};poolMod.spawn(game.enemies,game,spawnOptions);spawnOptions.cellPos.x=7;spawnOptions.cellPos.y=6;poolMod.spawn(game.playerUnits,game,spawnOptions);spawnOptions.cellPos.x=1;spawnOptions.cellPos.y=1;poolMod.spawn(game.shots,game,spawnOptions);return game;}}} ());var draw=(function(){return{back:function(ctx,canvas){ctx.fillStyle='black';ctx.fillRect(0,0,canvas.width,canvas.height);},pool:function(sm,poolName,fill){var pool=sm.game[poolName],unit,i=pool.length;while(i--){unit=pool[i];if(unit.active){ctx.fillStyle=fill||'white';ctx.fillRect(unit.x,unit.y,unit.w,unit.h);}}},map:function(sm){var canvas=sm.canvas,ctx=sm.ctx,map=sm.game.map;var cs=map.cellSize,i=0,x,y,len=map.cells.length,cell;while(i<len){cell=map.cells[i];x=map.margin.x+cell.x*cs;y=map.margin.y+cell.y*cs;ctx.fillStyle='green';ctx.strokeStyle='white';ctx.beginPath();ctx.rect(x,y,32,32);ctx.fill();ctx.stroke();i+=1;}},cursor:function(sm){var ctx=sm.ctx;ctx.strokeStyle='lime';ctx.lineWidth=3;ctx.beginPath();ctx.arc(sm.input.pos.x,sm.input.pos.y,5,0,Math.PI*2);ctx.stroke();},ver:function(sm){var ctx=sm.ctx;ctx.fillStyle='lime';ctx.textBaseline='top';ctx.font='10px arial';ctx.fillText('v'+sm.ver,2,sm.canvas.height-12);}}} ());var states={game:{update:function(sm,secs){draw.back(ctx,canvas);draw.map(sm);draw.pool(sm,'enemies','red');draw.pool(sm,'playerUnits','blue');draw.pool(sm,'shots','white');draw.cursor(sm);draw.ver(sm);},pointerStart:function(sm,e){},pointerMove:function(){},pointerEnd:function(){}}};var canvas=document.createElement('canvas'),ctx=canvas.getContext('2d'),container=document.getElementById('canvas-app')||document.body;container.appendChild(canvas);canvas.width=320;canvas.height=240;ctx.translate(0.5,0.5);var sm={ver:'0.2.0',canvas:canvas,ctx:ctx,currentState:'game',game:gameMod.create({canvas:canvas}),input:{pointerDown:false,pos:{x:0,y:0}}};var pointerHanders={start:function(sm,e){var pos=sm.input.pos;sm.input.pointerDown=true;sm.input.pos=utils.getCanvasRelative(e);states[sm.currentState].pointerStart(sm,e);},move:function(sm,e){if(sm.input.pointerDown){sm.input.pos=utils.getCanvasRelative(e);states[sm.currentState].pointerMove(sm,e);}},end:function(sm,e){sm.input.pointerDown=false;states[sm.currentState].pointerEnd(sm,e);}};var createPointerHandler=function(sm,type){return function(e){e.preventDefault();pointerHanders[type](sm,e);};};canvas.addEventListener('mousedown',createPointerHandler(sm,'start'));canvas.addEventListener('mousemove',createPointerHandler(sm,'move'));canvas.addEventListener('mouseup',createPointerHandler(sm,'end'));canvas.addEventListener('touchstart',createPointerHandler(sm,'start'));canvas.addEventListener('touchmove',createPointerHandler(sm,'move'));canvas.addEventListener('touchend',createPointerHandler(sm,'end'));var lt=new Date(),FPS_target=30;var loop=function(){var now=new Date(),t=now-lt,secs=t/1000;requestAnimationFrame(loop);if(t>=1000/FPS_target){states[sm.currentState].update(sm,secs);lt=now;}};loop();</script></body></html>