<html>
<head>
<title>Canvas Example Mr Sun</title>
</head>
<body>
<div id="canvas-app" style="width:320px;height:240px;margin-left:auto;margin-right:auto;"></div>
<script>var utils={};utils.mod=function(x,m){return(x%m+m)%m};utils.getCanvasRelative=function(e){var canvas=e.target,bx=canvas.getBoundingClientRect();return{x:(e.changedTouches?e.changedTouches[0].clientX:e.clientX)-bx.left,y:(e.changedTouches?e.changedTouches[0].clientY:e.clientY)-bx.top,bx:bx}};utils.distance=function(x1,y1,x2,y2){return Math.sqrt(Math.pow(x1-x2,2)+Math.pow(y1-y2,2))};utils.logPer=function(per,a,b){a=a===undefined?2:a;b=b===undefined?a:b;per=per<0?0:per;per=per>1?1:per;return Math.log(1+a-2+per)/Math.log(b)};utils.createLogPerObject=function(i,len,base,max,a,b){a=a===undefined?2:a;b=b===undefined?a:b;base=base===undefined?0:base;max=max===undefined?1:max;var per=i/len,logPer=utils.logPer(per,a,b);return{i:i,len:len,per:per,logPer:logPer,n:base+logPer*(max-base),valueOf:function(){return this.n}}};utils.createLogPerCollection=function(opt){opt=opt||{};opt.len=opt.len===undefined?100:opt.len;opt.base=opt.base===undefined?0:opt.base;opt.max=opt.max===undefined?50:opt.max;opt.a=opt.a===undefined?2:opt.a;opt.b=opt.b===undefined?opt.a:opt.b;var i=0,obj,collection={len:opt.len,base:opt.base,max:opt.max,a:opt.a,b:opt.b};collection.data=[];while(i<opt.len){obj=utils.createLogPerObject(i,opt.len,opt.base,opt.max,opt.a,opt.b);collection.data.push(obj);i+=1}return collection};var gameMod=function(){var plugs={};var getCallPrioritySorted=function(){var keys=Object.keys(plugs);return keys.sort(function(a,b){var plugObjA=plugs[a],plugObjB=plugs[b];if(plugObjA.callPriority>plugObjB.callPriority){return 1}if(plugObjA.callPriority<plugObjB.callPriority){return-1}return 0})};var usePlugs=function(game,methodName,args){methodName=methodName||"create";args=args||[game];var keys=getCallPrioritySorted();keys.forEach(function(plugKey){var plugObj=plugs[plugKey],method=plugObj[methodName];if(method){method.apply(plugObj,args)}})};var api={};api.create=function(opt){opt=opt||{};opt.canvas=opt.canvas||{width:320,height:240};var game={};game.centerX=opt.centerX||opt.canvas.width/2;game.centerY=opt.centerY||opt.canvas.height/2;game.sectionRadius=opt.sectionRadius||16;game.worldRadius=opt.worldRadius||100;game.secs=0;game.year=opt.year||0;game.yearRate=opt.yearRate||1;game.sun={radius:16,x:game.centerX,y:game.centerY,sunGrid:{}};var i=0,sections=[],total=opt.sectionCount||20,radian,cx=game.centerX,cy=game.centerY;while(i<total){radian=Math.PI*2/total*i;sections.push({i:i,x:Math.cos(radian)*game.worldRadius+cx,y:Math.sin(radian)*game.worldRadius+cy,radius:game.sectionRadius,per:1});i+=1}game.sections=sections;usePlugs(game,"create",[game,opt]);gameMod.updateSections(game);return game};api.updateSections=function(game){var sun=game.sun;game.sections.forEach(function(section){var ajust=section.radius+sun.radius;var d=utils.distance(section.x,section.y,sun.x,sun.y)-ajust;var per=d/(game.worldRadius*2-ajust*2);per=per>1?1:per;per=per<0?0:per;per=1-per;section.per=per})};api.getSectionByPos=function(game,x,y){var section,i=game.sections.length;while(i--){section=game.sections[i];if(utils.distance(section.x,section.y,x,y)<=section.radius){return section}}return false};var boundToCircle=function(obj,cx,cy,radius){if(utils.distance(obj.x,obj.y,cx,cy)>radius){var a=Math.atan2(obj.y-cy,obj.x-cx);obj.x=cx+Math.cos(a)*radius;obj.y=cy+Math.sin(a)*radius}};api.moveSun=function(game,pos){var ajust=game.sun.radius+game.sectionRadius;game.sun.x=pos.x;game.sun.y=pos.y;boundToCircle(game.sun,game.centerX,game.centerY,game.worldRadius-ajust);api.updateSections(sm.game)};api.update=function(game,secs){game.secs+=secs;var deltaYears=Math.floor(game.secs/game.yearRate);if(deltaYears>=1){game.year+=deltaYears;game.secs%=game.yearRate;usePlugs(game,"onDeltaYear",[game,deltaYears])}};api.load=function(plugObj){var len=Object.keys(plugs).length;plugObj.name=plugObj.name||len;plugObj.callPriority=plugObj.callPriority||len;plugs[plugObj.name]=plugObj};return api}();gameMod.load({name:"plug-api-base",callPriority:.1,create:function(game,opt){console.log(this.name);game.forSections=function(forEach){var i=0,len=game.sections.length;while(i<len){section=game.sections[i];forEach.call(game,section,i,game);i+=1}}},onDeltaYear:function(game,deltaYears){}});gameMod.load(function(){var MASS_FOR_ALL_BLOCKS=1e4,GRID_WIDTH=12,GRID_HEIGHT=5;var createCellsArray=function(){var cells=[],w=GRID_WIDTH,h=GRID_HEIGHT,i=0,len=w*h;while(i<len){cells.push({i:i,x:i%w,y:Math.floor(i/w),type:0,block:null});i+=1}return cells};var getCell=function(section,x,y){var cell;if(x<0||y<0||x>=GRID_WIDTH||y>=GRID_HEIGHT){return false}cell=section.cells[y*GRID_WIDTH+x];if(cell){return cell}return false};var getAllEmptyCells=function(section){return section.cells.filter(function(cell){return cell.block===null})};var getRandomFreeCell=function(section){var freeCells=getAllEmptyCells(section),len=freeCells.length,i=Math.floor(Math.random()*len);if(len>0){return freeCells.slice(i,i+1)[0]}return false};var getEmptyCell=function(section){var i=0,cell,len=section.cells.length;while(i<len){cell=section.cells[i];if(cell.block===null){return cell}i+=1}return false};var createBlocksArray=function(){var blocks=[],w=GRID_WIDTH,h=GRID_HEIGHT,i=0,len=w*h;while(i<len){blocks.push({i:i,cell:null,active:false,type:1});i+=1}return blocks};var getAllActiveBlocks=function(blocks,active){active=active===undefined?true:active;return blocks.filter(function(block){return block.active===active})};var gravity=function(section,block){if(block.cell){var belowCell=getCell(section,block.cell.x,block.cell.y+1);if(belowCell){if(belowCell.block===null){block.cell.block=null;belowCell.block=block;block.cell=belowCell}}}};var setBlocksActive=function(section){var activePer=section.totalMass/MASS_FOR_ALL_BLOCKS;activePer=activePer>1?1:activePer;var topIndex=Math.floor(activePer*section.blocks.length);section.blocks.forEach(function(block){block.active=block.i<topIndex;if(!block.cell&&block.active){var cell=getRandomFreeCell(section);if(cell){cell.block=block;block.cell=cell}}gravity(section,block)})};var setBlockTypes=function(section){var i=0,blocks=getAllActiveBlocks(section.blocks,true),len=blocks.length,indexMarkers=Object.keys(section.mineralsPer).map(function(key){var minPer=section.mineralsPer[key];i=i+minPer*len;return i});blocks.forEach(function(block){var i=0,len=indexMarkers.length,indexMark;while(i<len){indexMark=indexMarkers[i];if(block.i<indexMark){block.type=i+1;break}i+=1}})};var setSection=function(game,index){game.currentSectionIndex=index;game.currentSection=game.sections[game.currentSectionIndex]};return{name:"plug-api-blocks",callPriority:.2,create:function(game,opt){console.log(this.name);game.forSections(function(section){section.cells=createCellsArray();section.blocks=createBlocksArray()});game.setSection=function(index){setSection(game,index)};setSection(game,0)},onDeltaYear:function(game,deltaYears){game.forSections(function(section){setBlocksActive(section);setBlockTypes(section)})}}}());gameMod.load(function(){var LEVEL_CAP=100,DELTA_NEXT=50,XP_PER_YEAR=1;var XP=function(){var DEFAULTS={level:1,xp:0,cap:30,deltaNext:50};var set=function(xp,deltaNext){return(1+Math.sqrt(1+8*xp/deltaNext))/2};var getXPtoLevel=function(level,deltaNext){return(Math.pow(level,2)-level)*deltaNext/2};var parseByXP=function(xp,cap,deltaNext){xp=xp===undefined?DEFAULTS.xp:xp;cap=cap===undefined?DEFAULTS.cap:cap;deltaNext=deltaNext===undefined?DEFAULTS.deltaNext:deltaNext;var l=set(xp,deltaNext);l=l>cap?cap:l;var level=Math.floor(l),forNext=getXPtoLevel(level+1,deltaNext);forNext=l===cap?Infinity:forNext;var toNext=l===cap?Infinity:forNext-xp;var forLast=getXPtoLevel(level,deltaNext);return{level:level,levelFrac:l,xp:xp,per:(xp-forLast)/(forNext-forLast),forNext:forNext,toNext:toNext,forLast:forLast}};return{parseByLevel:function(l,cap,deltaNext){l=l===undefined?DEFAULTS.level:l;deltaNext=deltaNext===undefined?DEFAULTS.deltaNext:deltaNext;var xp=getXPtoLevel(l,deltaNext);console.log(xp);return parseByXP(xp,cap,deltaNext)},parseByXP:parseByXP}}();var setSunLevel=function(sun){sun.xp=sun.years*XP_PER_YEAR+sun.points;sun.levelObj=XP.parseByXP(sun.xp,LEVEL_CAP,DELTA_NEXT)};return{name:"sun",callPriority:"1.1",create:function(game,opt){console.log(this.name);var sun=game.sun;sun.addPoints=function(points){sun.points+=1;setSunLevel(sun)};sun.reset=function(){sun.points=0;sun.years=0;sun.exp=0;sun.levelObj={}};sun.reset();setSunLevel(sun)},onDeltaYear:function(game,deltaYears){var sun=game.sun;sun.years+=deltaYears;setSunLevel(sun)}}}());gameMod.load(function(){var MAX_SUN_TEMP=250,MAX_GROUND_TEMP=1e3,COOL_TIME=1e5;var updateSun=function(game,deltaYears){};var updateTempSections=function(game,deltaYears){var timePer=game.year/COOL_TIME;timePer=timePer>1?1:timePer;game.forSections(function(section){section.temp=section.per*MAX_SUN_TEMP;var groundTempLoss=MAX_GROUND_TEMP*.75*timePer;section.groundTemp=MAX_GROUND_TEMP-groundTempLoss;section.temp=Number(section.temp.toFixed(2));section.groundTemp=Number(section.groundTemp.toFixed(2))})};return{name:"temp",callPriority:"1.2",create:function(game,opt){updateSun(game,0);game.sun.temp=MAX_SUN_TEMP;game.forSections(function(section){section.temp=0;section.groundTemp=MAX_GROUND_TEMP})},onDeltaYear:function(game,deltaYears){updateSun(game,deltaYears);updateTempSections(game,deltaYears)}}}());gameMod.load(function(){var SUN_STARTING_HYDROGEN=1e5,SUN_MINERAL_PRODUCTION={carbon:{rate:5,temp:100,cost:{amount:1,mineral:"hydrogen"}},oxygen:{rate:1,temp:250,cost:{amount:1,mineral:"carbon"}}},SUN_MINERAL_TRANSFER_RATES={hydrogen:7,carbon:5,oxygen:1};var getMinDelta=function(sun,rate,temp,deltaYears){return rate*Math.floor(sun.temp/temp)*deltaYears};var getMinCost=function(sun,production,deltaYears){return Math.floor(production.cost.amount*deltaYears)};var createMineralsObj=function(){return{hydrogen:0,carbon:0,oxygen:0}};var createMinerals=function(sun,deltaYears){var i=0,minName,minCount,production,keys=Object.keys(sun.minerals),len=keys.length;while(i<len){minName=keys[i];minCount=sun.minerals[minName];production=SUN_MINERAL_PRODUCTION[minName];if(production){if(sun.temp>=production.temp){var delta=getMinDelta(sun,production.rate,production.temp,deltaYears),cost=getMinCost(sun,production,deltaYears);if(sun.minerals[production.cost.mineral]>=cost){sun.minerals[production.cost.mineral]-=cost;sun.minerals[minName]+=delta}}}i+=1}};var transferToSection=function(sun,section,deltaYears){if(section.per>.95){Object.keys(sun.minerals).forEach(function(minKey){var minCount=sun.minerals[minKey];var transferAmount=SUN_MINERAL_TRANSFER_RATES[minKey]*deltaYears;if(minCount>=transferAmount){section.minerals[minKey]+=transferAmount;sun.minerals[minKey]-=transferAmount}})}};var updateTotalMass=function(obj){obj.totalMass=0;Object.keys(obj.minerals).forEach(function(minKey){var minCount=obj.minerals[minKey];obj.totalMass+=minCount})};var updateMineralsPer=function(obj){Object.keys(obj.minerals).forEach(function(minKey){var minCount=obj.minerals[minKey];obj.mineralsPer[minKey]=minCount/obj.totalMass})};return{name:"fusion",callPriority:"1.3",create:function(game,opt){game.sun.minerals=createMineralsObj();game.sun.mineralsPer={};game.sun.totalMass=0;game.forSections(function(section){section.minerals=createMineralsObj();section.mineralsPer={};section.totalMass=0});game.sun.minerals.hydrogen=SUN_STARTING_HYDROGEN},onDeltaYear:function(game,deltaYears){var sun=game.sun;createMinerals(sun,deltaYears);updateTotalMass(sun);updateMineralsPer(sun);game.forSections(function(section){transferToSection(sun,section,deltaYears);updateTotalMass(section);updateMineralsPer(section)})}}}());var stateMod=function(){var changeState=function(sm,stateKey,opt){opt=opt||{};var newState=sm.states[stateKey];if(newState.start){newState.start(sm,opt)}sm.currentState=stateKey};var states={};var pointerHanders={start:function(sm,pos,e){var pos=sm.input.pos;sm.input.pointerDown=true;sm.input.startPos={x:pos.x,y:pos.y};sm.input.d=0;var method=states[sm.currentState].pointerStart;if(method){method(sm,pos,e)}},move:function(sm,pos,e){var method=states[sm.currentState].pointerMove,startPos=sm.input.startPos;sm.input.d=utils.distance(startPos.x,startPos.y,pos.x,pos.y);if(method){method(sm,pos,e)}},end:function(sm,pos,e){sm.input.pointerDown=false;var method=states[sm.currentState].pointerEnd;if(method){method(sm,pos,e)}}};var createPointerHandler=function(sm,type){return function(e){var pos=utils.getCanvasRelative(e);sm.input.pos=pos;e.preventDefault();pointerHanders[type](sm,pos,e)}};var api={};api.load=function(stateObj){states[stateObj.name||Object.keys(states).length]=stateObj};var createCanvas=function(opt){opt=opt||{};opt.container=opt.container||document.getElementById("canvas-app")||document.body;opt.canvas=document.createElement("canvas");opt.ctx=opt.canvas.getContext("2d");opt.container.appendChild(opt.canvas);opt.canvas.width=opt.width===undefined?320:opt.width;opt.canvas.height=opt.height===undefined?240:opt.height;opt.ctx.translate(.5,.5);return opt};api.create=function(opt){opt=opt||{};var can=createCanvas(opt);var sm={canvas:can.canvas,ctx:can.ctx,ver:opt.ver||"0.0.0",currentState:opt.currentState||"game",game:{},draw:{},states:states,input:{pointerDown:false,d:0,startPos:{x:0,y:0},pos:{x:0,y:0}}};sm.canvas.addEventListener("mousedown",createPointerHandler(sm,"start"));sm.canvas.addEventListener("mousemove",createPointerHandler(sm,"move"));sm.canvas.addEventListener("mouseup",createPointerHandler(sm,"end"));sm.canvas.addEventListener("touchstart",createPointerHandler(sm,"start"));sm.canvas.addEventListener("touchmove",createPointerHandler(sm,"move"));sm.canvas.addEventListener("touchend",createPointerHandler(sm,"end"));Object.keys(states).forEach(function(stateName){var stateObj=states[stateName];if(stateObj.init){stateObj.init(sm)}});return sm};api.start=function(sm){var lt=new Date,FPS_target=30;var loop=function(){var now=new Date,t=now-lt,draw,update,secs=t/1e3;requestAnimationFrame(loop);if(t>=1e3/FPS_target){update=states[sm.currentState].update;draw=states[sm.currentState].draw;if(update){update.call(sm,sm,secs)}if(draw){draw.call(sm,sm.draw,sm.ctx,sm.canvas,sm.game,sm)}lt=now}};loop()};return api}();stateMod.load({name:"init-draw-base",init:function(sm){sm.draw.back=function(sm){sm.ctx.fillStyle="#000020";sm.ctx.fillRect(0,0,sm.canvas.width,sm.canvas.height)};sm.draw.sections=function(sm){var ctx=sm.ctx;sm.game.sections.forEach(function(section){var b=50+Math.round(section.per*128);ctx.fillStyle="rgb(0,0,"+b+")";ctx.strokeStyle="#808080";ctx.beginPath();ctx.arc(section.x,section.y,section.radius,0,Math.PI*2);ctx.fill();ctx.stroke();ctx.fillStyle="white";ctx.textAlign="center";ctx.textBaseline="middle";ctx.font="8px arial"})};sm.draw.sun=function(sm){var sun=sm.game.sun,ctx=sm.ctx;ctx.fillStyle="yellow";ctx.beginPath();ctx.arc(sun.x,sun.y,sun.radius,0,Math.PI*2);ctx.fill();ctx.fillStyle="black"};sm.draw.disp=function(sm){var ctx=sm.ctx;ctx.fillStyle="white";ctx.textAlign="left";ctx.textBaseline="top";ctx.font="10px courier";ctx.fillText("year: "+sm.game.year,3,10)};sm.draw.ver=function(sm){var ctx=sm.ctx;ctx.fillStyle="white";ctx.textAlign="left";ctx.textBaseline="top";ctx.font="10px courier";ctx.fillText("v"+sm.ver,10,sm.canvas.height-15)}}});stateMod.load(function(){var blockColors=["white","lime","blue","red","green"];return{name:"init-draw-blocks",init:function(sm){sm.draw.cells=function(sm,section,offsetX,offsetY){section=section===undefined?sm.game.currentSection:section;var ctx=sm.ctx;section.cells.forEach(function(cell){var block=cell.block,x=offsetX+cell.x*16,y=offsetY+cell.y*16;ctx.fillStyle=blockColors[0];if(block){ctx.fillStyle=blockColors[block.type]}ctx.fillRect(x,y,16,16);ctx.fillStyle="black";if(block){ctx.fillText(block.type,x,y)}})};var drawMineralInfo=function(ctx,obj,offsetX,offsetY){var keys=Object.keys(obj.minerals);keys.forEach(function(minName,i){var minCount=obj.minerals[minName],x=offsetX,y=offsetY+10*i;ctx.fillText(minName+": "+minCount,x,y)});ctx.fillText("totalMass: "+obj.totalMass,offsetX,offsetY+10*keys.length)};sm.draw.sectionMineralInfo=function(sm,section,offsetX,offsetY){var ctx=sm.ctx;ctx.fillStyle="white";ctx.font="10px arial";ctx.textAlign="left";ctx.textBaseLine="top";drawMineralInfo(ctx,section,offsetX,offsetY)};sm.draw.sunMineralInfo=function(sm,offsetX,offsetY){var ctx=sm.ctx,sun=sm.game.sun;ctx.fillStyle="white";ctx.font="10px arial";ctx.textAlign="left";ctx.textBaseLine="top";drawMineralInfo(ctx,sun,offsetX,offsetY)}}}}());stateMod.load({name:"init-game",init:function(sm){sm.game=gameMod.create({canvas:sm.canvas,sectionCount:19,worldRadius:100,yearRate:.25,year:0});console.log("game:");console.log(sm.game)}});stateMod.load({name:"ui-sun",init:function(sm){var sun=sm.game.sun;sun.move=function(game,pos){var radius=game.worldRadius-game.sectionRadius;if(utils.distance(pos.x,pos.y,game.centerX,game.centerY)<radius){gameMod.moveSun(game,pos)}}},update:function(sm,secs){gameMod.update(sm.game,secs)},draw:function(d,ctx,canvas,game,sm){d.back(sm);d.sections(sm);d.sun(sm);d.disp(sm);d.sunMineralInfo(sm,3,30);d.ver(sm)},pointerStart:function(sm,pos,e){sm.game.sun.move(sm.game,pos)},pointerMove:function(sm,pos,e){if(sm.input.pointerDown){sm.game.sun.move(sm.game,pos)}},pointerEnd:function(sm,pos){if(sm.input.d<3){var section=gameMod.getSectionByPos(sm.game,pos.x,pos.y);if(section){sm.game.setSection(section.i);sm.currentState="ui-blocks"}if(utils.distance(sm.game.sun.x,sm.game.sun.y,pos.x,pos.y)<=sm.game.sun.radius){}}}});stateMod.load(function(){return{name:"ui-blocks",init:function(sm){},update:function(sm,secs){gameMod.update(sm.game,secs)},draw:function(d,ctx,canvas,game,sm){var offsetX=160-16*12/2,offsetY=120-16*5/2,section=sm.game.currentSection;d.back(sm);d.cells(sm,section,offsetX,offsetY);d.sectionMineralInfo(sm,section,10,10);d.ver(sm)},pointerStart:function(sm,pos,e){},pointerMove:function(sm,pos,e){},pointerEnd:function(sm,pos){sm.currentState="ui-sun"}}}());var sm=stateMod.create({ver:"0.2.0",currentState:"ui-sun"});stateMod.start(sm);</script>
</body>
</html>
